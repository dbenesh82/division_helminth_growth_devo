---
title: "Life history strategies"
output: 
  github_document:
    toc: true
    df_print: kable
---

How should parasites divide their growth and development among the multiple hosts of a complex life cycle? Here we look at parasite life history strategies in two-host life cycles.

```{r setup, include=FALSE}
library(tidyverse)
library(MCMCglmm)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)
theme_set(new = theme_bw())
```
```{r}
tree <- read.tree(file = "../../data/full_tree_time_calib.nex")
dat <- read.csv(file = "../../data/imputed_stage_level_tables/stage_level_combined_bestimputed.csv", header = T)
```

```{r}
wrangle_data <- function(dat){
  dat <- mutate(dat, Host_no_fac = factor(Host_no_fac),
              obs = factor(1:length(Parasite.species)))%>%
  mutate(stage_lcl = paste0("lc", lcl_max_fac, "_", Host_no_fac),
         is_paratenic = if_else(Facultative == "paratenic", 1, 0))%>%
  mutate(log_end = log(imp_biovolume), log_start = log(imp_initial_biov), 
           log_dt = log(imp_avg_dt), log_dd = log(imp_avg_dd))%>%
  mutate(rg = log_end - log_start, rgr = (log_end - log_start)/(imp_avg_dd/15),
         tg = log(imp_biovolume-imp_initial_biov), tgr = (imp_biovolume-imp_initial_biov)/(imp_avg_dd/15) )%>%
  mutate(rgr_perc = exp(rgr)-1)%>%
  mutate(doubling_time = log(2)/rgr_perc)%>%
  mutate(host_bm = log(10^(host_bm)))
  dat <- dat%>% # trim white space
    mutate(across(parasite_genus:parasite_phylum, trimws))
  
  dat <- dat%>%
    mutate(rg_missing = if_else(is.na(biovolume)|is.na(initial_biov), "yes", "no"),
           dd_missing = if_else(is.na(avg_dd), "yes", "no"),
           fs_missing = if_else(is.na(biovolume)&Stage == "adult", "yes", "no"))
  
  # also make estimate of host met rate (just a way to combined host mass and temp)
  boltz <- 8.617333262145*10^-5 # eV per degree K
  dat <- mutate(dat, metabolic = log((exp(host_bm)^(3/4)*exp(-0.63/(
    boltz*(avg_temp+273.15)))) ))
  bm_comp <- dat%>%
    filter(Facultative != "postcyclic")%>%
    group_by(Parasite.species, tree_tips)%>%
    mutate(host_bm_next = lead(host_bm),
           rg_next = lead(rg),
           rgr_next = lead(rgr),
           tg_next = lead(tg),
           tgr_next = lead(tgr),
           fs_next = lead(log_end),
           dt_next = lead(log_dt),
           dd_next = lead(log_dd),
           mr_next = lead(metabolic),
           endo_next = lead(endo_ecto),
           host_class_next = lead(host_class), host_phylum_next = lead(host_phylum),
           rg_missing_next = lead(rg_missing), dd_missing_next = lead(dd_missing),
           fs_missing_next = lead(fs_missing))%>%
    ungroup()%>%
    mutate(step = if_else(Host.no == 1, "1 to 2", 
                          if_else(Host.no == 2, "2 to 3", "3 to 4")))
  bm_comp <- bm_comp%>%
    # filter(!(is.na(host_bm) | is.na(host_bm_next)))%>%
    select(Parasite.species, parasite_genus, parasite_family, parasite_order, parasite_class, parasite_phylum,
           host_class, host_class_next, host_phylum, host_phylum_next, tree_tips,
           Host.no, lcl_max, host_bm, host_bm_next, 
           rg, rg_next, rgr, rgr_next, 
           tg, tg_next, tgr, tgr_next,
           is = log_start,
           fs = log_end, fs_next, 
           dt = log_dt, dt_next, 
           dd = log_dd, dd_next, 
           mr = metabolic, mr_next,
           endo_next,
           step,
           rg_missing, rg_missing_next,
           dd_missing, dd_missing_next,
           fs_missing_next)
  two_hosts <- filter(bm_comp, lcl_max == 2)%>%
    filter(Host.no == 1)%>%
    rename(int_host_mass = host_bm, def_host_mass = host_bm_next, endo_def = endo_next,
           int_host_class = host_class, def_host_class = host_class_next, 
           int_host_phylum = host_phylum, def_host_phylum = host_phylum_next,
           mr_int_host = mr, mr_def_host = mr_next,
           egg_size = is, fs_int_host = fs, fs_def_host = fs_next, 
           rg_int_host = rg, rg_def_host = rg_next,
           tg_int_host = tg, tg_def_host = tg_next,
           dt_int_host = dt, dt_def_host = dt_next, 
           dd_int_host = dd, dd_def_host = dd_next,
           rgr_int_host = rgr, rgr_def_host = rgr_next,
           tgr_int_host = tgr, tgr_def_host = tgr_next,
           missing_rg_ih = rg_missing, missing_rg_dh = rg_missing_next,
           missing_dd_ih = dd_missing, missing_dd_dh = dd_missing_next,
           missing_fs = fs_missing_next
           )%>%
    mutate(missing_ag = if_else(missing_dd_ih == "yes" | missing_dd_dh == "yes", "yes", "no"))%>%
    mutate(fold_change_hm = def_host_mass - int_host_mass,
           endo_def = as.numeric(as.factor(endo_def))-1)%>%
    select(-Host.no, -step)
  
  two_hosts$obs <- 1:length(two_hosts$Parasite.species)
  two_hosts <- mutate(two_hosts,
           int_host_mass_c = int_host_mass - mean(two_hosts$int_host_mass),
           def_host_mass_c = def_host_mass - mean(two_hosts$def_host_mass),
           endo_def_c = endo_def - 0.5)
  two_hosts <- mutate(two_hosts, 
                      ag_def_host = log(exp(dd_int_host) + exp(dd_def_host)),
                      prop_growth_int = rg_int_host/(rg_int_host + rg_def_host))
  # stnd response var
  two_hosts <- two_hosts%>%
    mutate(across(c(starts_with("rg_"), starts_with("dd_"), starts_with("fs_"), 
                    starts_with("ag_"), starts_with("dt_")),
                  scale, .names = "z_{.col}"))
  two_hosts <- two_hosts%>%
    mutate(larval_overperf_nofe = (z_rg_int_host + -1*z_dd_int_host)/2,
           adult_overperf_nofe = (z_rg_def_host + -1*z_dd_def_host)/2,
           adult_overperf2_nofe = (z_fs_def_host + -1*z_ag_def_host)/2
           )
  two_hosts <- two_hosts%>%
    mutate(parasite_phylum = if_else(parasite_phylum == "Platyhelminthes", "Cestoda", parasite_phylum))
  two_hosts <- filter(two_hosts, !is.na(def_host_class))

  return(two_hosts)
}
```

I rearranged the stage-level parasite data so that pairs represent values in the current host and then the next host.

```{r}
two_hosts <- wrangle_data(dat)
```

For simplicity let's restrict ourselves to two stages: first intermediate host and second definitive host. In other words, we're only looking at worms with two-host life cycles.

# Optimal life history strategies? 

## Non-taxonomic models

When do worms spend more time in one host and less in another? We fit a series of multivariate mixed models to explore parasite life history strategies. Our response variables are parasite life history traits like growth and development as well as their covariance (hence the multivariate approach). We'll first fit models without considering parasite ancestry/taxonomy so that we can explore the correlations between host traits and parasite life history. Life history models suggest parasite growth should increase in hosts in which the growth rate to mortality ratio is high, like big endothermic hosts. Moreover, if the next host is large and endothermic, then growth should be suppressed in the current host so as to avoid inducing mortality and thus reducing the likelihood of transmission. 

We took six parasite traits as response variables: growth in the intermediate host, developmental time in the intermediate host, growth in the definitive host, developmental time in the definitive host, and size and age at maturity. We fit the following series of models: 1) intercept-only, no covariance between traits, 2) allow covariance between traits, 3) add fixed, main effects characterizing the parasite's hosts (intermediate host size, definitive host size, and endothermy of definitive host), 4) interactions between fixed effects, and 5) interactions between host traits and parasite group (acanths, nematodes, cestodes). Regarding the fixed effects, we have a couple predictions from theory, some of which have been shown previously: a) parasite size and developmental time increase with host size, b) larval growth and development decrease when the next host is relatively "good" (i.e. big and endothermic). 


Here are the number of species and families overall:
```{r}
two_hosts%>%
  summarise(n_spp = n_distinct(Parasite.species),
            n_fams = n_distinct(parasite_family))
```
Let's make sure all traits have been imputed:

```{r}
two_hosts%>%
  summarize(rg_int = sum(!is.na(rg_int_host)),
            rg_def = sum(!is.na(rg_def_host)),
            dd_int = sum(!is.na(dd_int_host)),
            dd_def = sum(!is.na(dd_def_host)),
            fs_def = sum(!is.na(fs_def_host)),
            ag_def = sum(!is.na(ag_def_host)),
            int_host_mass = sum(!is.na(int_host_mass)),
            def_host_mass = sum(!is.na(def_host_mass)))
```

There were species with larval traits, but not adult traits. These were species that either do not have known definitive hosts (Ascarophis) or undergo asexual reproduction as larvae (Echinococcus and Taenia) making it difficult to say what a typical starting size for adult growth is. We remove these species.

Here are the number of species for each trait when data is not imputed:

```{r}
pp <- two_hosts%>%
  summarize(rg_int = sum(missing_rg_ih == "no"),
            rg_def = sum(missing_rg_dh == "no"),
            dd_int = sum(missing_dd_ih == "no"),
            dd_def = sum(missing_dd_dh == "no"),
            fs_def = sum(missing_fs == "no"),
            ag_def = sum(missing_ag == "no"))
pp
```
Here is the proportion missing data in each trait:
```{r}
1 - pp/n_distinct(two_hosts$Parasite.species)
```

Here are the number of species with both larval growth and development:

```{r}
summarize(two_hosts,
          sp_no_missing_larv_data = 
            sum(missing_rg_ih == "no" & missing_dd_ih == "no")
          )
```


And the number of species with adult growth and development:

```{r}
summarize(two_hosts,
          sp_no_missing_adult_data = 
            sum(missing_dd_dh == "no" & missing_rg_dh == "no")
          )
```

And the number of species with no missing data:

```{r}
summarize(two_hosts,
          sp_no_missing_data = 
            sum(missing_dd_ih == "no" & missing_dd_dh == "no" &
                  missing_rg_ih == "no" & missing_rg_dh == "no")
          )
```

But most species had at least one growth or developmental time estimate:

```{r}
summarize(two_hosts,
          sp_at_least_one_estimate = 
            sum(missing_dd_ih == "no" | missing_dd_dh == "no" |
                  missing_rg_ih == "no" | missing_rg_dh == "no")
          )
```

The independent variables were host traits. Here is the average IH mass in mg:

```{r}
exp(mean(two_hosts$int_host_mass)) * 1000
```

And DH mass in g: 

```{r}
exp(mean(two_hosts$def_host_mass))
```

There were more helminths with endotherm DHs than ectotherms in the data.

```{r}
two_hosts%>%
  group_by(endo_def)%>%
  summarize(n=n())%>%
  mutate(prop = n/sum(n))
```


```{r}
# make tree based on taxonomic hierarchy, use unique genera as tips
tree_tax <- as.phylo.formula(~parasite_phylum/parasite_class/parasite_order/parasite_family/parasite_genus, 
                             data = select(two_hosts, parasite_genus:parasite_phylum)%>%
                               mutate_all(factor)%>%distinct() )
tree_tax$root.edge <- 0 # this retains polytomy at root, i.e. all phyla descend from this root
tree_tax <- makeNodeLabel(tree_tax) # standardize node labels
tree_tax <- compute.brlen(tree_tax, power = 0.5) # add branch lengths
Ainv <- inverseA(tree_tax)$Ainv # make inv of phy cov matrix
# take phylogenetic tree
tree <- keep.tip(tree, tip = two_hosts$tree_tips)
tree <- makeNodeLabel(tree) # standardize node labels
Ainv2 <- inverseA(tree)$Ainv # make inv of phy cov matrix
```

```{r}
prior_notax <- list(R = list(R1 = list(V = diag(6), n = 1)))
```

```{r}
chains0 = list()
chains1 = list()
chains1p = list()
chains2 = list()
chains3 = list()
chains4 = list()

nit <- 1000 # number of iterations for models
bi <- 500 # burnin iterations

for(i in 1:100){

  iname <- ifelse(i < 10, paste0('00',i), 
                  ifelse(i < 100, paste0('0',i),i))
  fname_p <- paste0('../../data/imputed_stage_level_tables/stage_level_imputed',iname,'.csv')
  dat_imp <- read.csv(file = fname_p, header = T)
  
  two_hosts_imp <- wrangle_data(dat_imp)
    
    # no cov LH
  chains0[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                    trait-1, 
                  rcov = ~idh(trait):units, # residual var-covar not unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  # prior = prior,
                  data = as.data.frame(two_hosts_imp),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  # cov LH, species level
  chains1[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~ trait-1, 
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_notax,
                  data = as.data.frame(two_hosts_imp),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  # cov LH, species level
  chains1p[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~ trait-1 + trait:parasite_phylum, 
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_notax,
                  data = as.data.frame(two_hosts_imp),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  chains2[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                    trait-1 +
                    trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c, 
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_notax,
                  data = as.data.frame(two_hosts_imp),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  chains3[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                    trait-1 +
                    trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c + 
                    trait:int_host_mass_c:def_host_mass_c +
                    trait:int_host_mass_c:endo_def_c +
                    trait:def_host_mass_c:endo_def_c, 
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_notax,
                  data = as.data.frame(two_hosts_imp),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  chains4[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                    trait-1 +
                    trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c + 
                    trait:int_host_mass_c:def_host_mass_c +
                    trait:int_host_mass_c:endo_def_c +
                    trait:def_host_mass_c:endo_def_c +
                    trait:parasite_phylum + 
                    trait:parasite_phylum:int_host_mass_c + trait:parasite_phylum:def_host_mass_c +
                    trait:parasite_phylum:endo_def_c, 
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_notax,
                  data = as.data.frame(two_hosts_imp),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  print(paste('non-taxonomic models, imputation', i, 'finished'))
}
```

Here is the model deviance for the non-taxonomic models. Allowing covariance among life history traits (red) improves model fit, and we explore these more below. Also, adding the fixed main effects (green) and interactions (blue) improves model fit, as does adding phylum interactions (light blue).

```{r}
name_dev_var <- function(x){
  dev <- x$Deviance
  dim(dev) <- c(length(dev),1)
  dimnames(dev) <- list(NULL, 'deviance')
  return(dev)
}

mod_comb_dev0 <- runjags::combine.mcmc(mcmc.list(lapply(chains0, name_dev_var)))
mod_comb_dev1 <- runjags::combine.mcmc(mcmc.list(lapply(chains1, name_dev_var)))
mod_comb_dev2 <- runjags::combine.mcmc(mcmc.list(lapply(chains2, name_dev_var)))
mod_comb_dev3 <- runjags::combine.mcmc(mcmc.list(lapply(chains3, name_dev_var)))
mod_comb_dev4 <- runjags::combine.mcmc(mcmc.list(lapply(chains4, name_dev_var)))
plot(mcmc.list(mod_comb_dev0, mod_comb_dev1,mod_comb_dev2, mod_comb_dev3, mod_comb_dev4), density = F)
```
Now we combine the chains for the fixed parameters and variance componenets.

```{r}
# combine the chains
mod_comb_sol1 <- runjags::combine.mcmc(mcmc.list(lapply(chains1, function(x) {x$Sol})))
mod_comb_sol1p <- runjags::combine.mcmc(mcmc.list(lapply(chains1p, function(x) {x$Sol})))
mod_comb_sol2 <- runjags::combine.mcmc(mcmc.list(lapply(chains2, function(x) {x$Sol})))
mod_comb_sol3 <- runjags::combine.mcmc(mcmc.list(lapply(chains3, function(x) {x$Sol})))
mod_comb_sol4 <- runjags::combine.mcmc(mcmc.list(lapply(chains4, function(x) {x$Sol})))
```

There are a lot of parameters - the model has six response variables and 15 fixed effects. Let's start by looking at larval growth. As expected, growth increased with intermediate host mass. Also, worms grow less when the next host is an endotherm, though this varies with worm phylum.

```{r}
s <- data.frame(quant = summary(mod_comb_sol4[,
                                        grepl("traitrg_int", colnames(mod_comb_sol4))])$quantiles)
mutate(s, param = gsub("traitrg_int_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

Now we move on to traits in the definitive host. Just looking at growth (more data), it does not increase with definitive host mass, surprisingly. It seems influenced by endothermy at least in some groups. It also tends to decrease with intermediate host mass, suggesting growth in a large intermediate hosts results in less growth in the definitive host.

```{r}
s <- data.frame(quant = summary(mod_comb_sol4[,
                                        grepl("traitrg_def", colnames(mod_comb_sol4))])$quantiles)
mutate(s, param = gsub("traitrg_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

Instead of relative growth in the definitive host, we can look at the overall size achieved. It also did not increase with definitive host mass, though it tended to be larger in endotherms.

```{r}
s <- data.frame(quant = summary(mod_comb_sol4[,
                                        grepl("traitfs_def", colnames(mod_comb_sol4))])$quantiles)
mutate(s, param = gsub("traitfs_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

Let's plot the effects of the larval environment on worm life history and then the effects of the adult environment. Blue vs red points distinguish worms with ecto vs endotherm definitive hosts. Larval growth increases and adult growth decreases with intermediate host size. Final worm size is unaffected by intermediate host size.

```{r}
fa <- ggplot(two_hosts, aes(x = int_host_mass, y = rg_int_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_rg_ih),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Intermediate host mass", y = "Larval growth") +
  facet_wrap(~parasite_phylum)
fb <- ggplot(two_hosts, aes(x = int_host_mass, y = dd_int_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_dd_ih),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Intermediate host mass", y = "Larval devo time") +
  facet_wrap(~parasite_phylum)
fc <- ggplot(two_hosts, aes(x = int_host_mass, y = rg_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_rg_dh),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Intermediate host mass", y = "Adult growth") +
  facet_wrap(~parasite_phylum)
fd <- ggplot(two_hosts, aes(x = int_host_mass, y = dd_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_dd_dh),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Intermediate host mass", y = "Adult devo time") +
  facet_wrap(~parasite_phylum)
fe <- ggplot(two_hosts, aes(x = int_host_mass, y = fs_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_fs),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Intermediate host mass", y = "Adult size") +
  facet_wrap(~parasite_phylum)
ff <- ggplot(two_hosts, aes(x = int_host_mass, y = ag_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_ag),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Intermediate host mass", y = "Adult age at maturity") +
  facet_wrap(~parasite_phylum)

cowplot::plot_grid(fa, fb, fc, fd, fe, ff, align = "hv", nrow = 3)
```

Now, we plot how adult environment affects worm life history.

```{r}
fa <- ggplot(two_hosts, aes(x = def_host_mass, y = rg_int_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_rg_ih),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Definitive host mass", y = "Larval growth") +
  facet_wrap(~parasite_phylum)
fb <- ggplot(two_hosts, aes(x = def_host_mass, y = dd_int_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_dd_ih),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Definitive host mass", y = "Larval devo time") +
  facet_wrap(~parasite_phylum)
fc <- ggplot(two_hosts, aes(x = def_host_mass, y = rg_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_rg_dh),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Definitive host mass", y = "Adult growth") +
  facet_wrap(~parasite_phylum)
fd <- ggplot(two_hosts, aes(x = def_host_mass, y = dd_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_dd_dh),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Definitive host mass", y = "Adult devo time") +
  facet_wrap(~parasite_phylum)
fe <- ggplot(two_hosts, aes(x = def_host_mass, y = fs_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_fs),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Definitive host mass", y = "Adult size") +
  facet_wrap(~parasite_phylum)
ff <- ggplot(two_hosts, aes(x = def_host_mass, y = ag_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_ag),
             alpha = 0.3) +
  geom_smooth(method = lm, se = F, linetype = "dashed") +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  labs(color = NULL, x = "Definitive host mass", y = "Adult age at maturity") +
  facet_wrap(~parasite_phylum)

cowplot::plot_grid(fa, fb, fc, fd, fe, ff, align = "hv", nrow = 3)
```

So habitats that favor larval growth (big intermediate hosts) are associated with less adult growth. We can see this by plotting relative growth in the two hosts. They are negatively correlated.

```{r}
ggplot(two_hosts, aes(x = rg_int_host, y = rg_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = missing_rg_ih == "yes"|missing_rg_dh == "yes")) +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto def host", "Endo def host")) +
  geom_smooth(method=lm, se =F ) +
  facet_wrap(~parasite_phylum)
```
But are these still negatively correlated after we account for the model fixed effects, like host mass and endothermy? We check this correlation via the model residuals. 

```{r}
l <- length(two_hosts$Parasite.species)

# full host trait model
pdx <- chains4[[1]]$X # model matrix, fixed effx
n <- dim(pdx)[1] # number of data points in model, all traits
nt <- n/6 # number of data points per trait
# p_i <- which(dxy$pred != "no") # points where we want predicted vals and cred int
# pdx <- pdx[c(p_i, nt+p_i, nt*2+p_i),] # restrict to only points where we want preds
# p_n <- dim(pdx)[1]/6 # number of points for each trait we want to predict
num_fe <- chains4[[1]]$Fixed$nfl # number of fixed effx, rand effx marginalized
p <- as.matrix(pdx) %*% t(mod_comb_sol4[,1:num_fe]) # predicteds via matrix mult for combined model runs, no taxonomic effx

# predictions for every iteration for every data point
px <- data.frame(two_hosts,
                rg_int_pred = p[1:l,],
                rg_def_pred = p[(l+1):(l*2),],
                dd_int_pred = p[(l*2+1):(l*3),],
                dd_def_pred = p[(l*3+1):(l*4),],
                fs_def_pred = p[(l*4+1):(l*5),],
                ag_def_pred = p[(l*5+1):(l*6),])

# reshape predicted vals for all iter, calc fit and quantiles
p_all <- px%>%
  pivot_longer(
    cols = rg_int_pred.1:names(px)[length(px)],
    names_to = c("trait","iter"),
    names_sep = "\\.",
    values_to = "mod_pred"
  )%>%
  group_by(obs, trait)%>%
  summarise(fit = median(mod_pred),
            lwr = quantile(mod_pred, probs = 0.025),
            upr = quantile(mod_pred, probs = 0.975))

p <- p_all%>%
  pivot_wider(id = obs, names_from = trait, values_from = fit:upr)

rm(px,pdx, n, nt, p_i, p_n, num_fe)
```

```{r}
two_hosts_p <- left_join(two_hosts, p, by = "obs")%>%
  mutate(rg_int_res = rg_int_host - fit_rg_int_pred,
         rg_def_res = rg_def_host - fit_rg_def_pred,
         dd_int_res = dd_int_host - fit_dd_int_pred,
         dd_def_res = dd_def_host - fit_dd_def_pred,
         fs_def_res = fs_def_host - fit_fs_def_pred,
         ag_def_res = ag_def_host - fit_ag_def_pred
         )
two_hosts_p <- two_hosts_p%>%
  mutate(rg_int_res_z = rg_int_res/sd(two_hosts_p$rg_int_res, na.rm = T),
         rg_def_res_z = rg_def_res/sd(two_hosts_p$rg_def_res, na.rm = T),
         dd_int_res_z = dd_int_res/sd(two_hosts_p$dd_int_res, na.rm = T),
         dd_def_res_z = dd_def_res/sd(two_hosts_p$dd_def_res, na.rm = T),
         fs_def_res_z = fs_def_res/sd(two_hosts_p$fs_def_res, na.rm = T),
         ag_def_res_z = ag_def_res/sd(two_hosts_p$ag_def_res, na.rm = T))
two_hosts_p <- two_hosts_p%>%
  mutate(larval_overperf = (rg_int_res_z + -1*dd_int_res_z)/2,
         adult_overperf = (rg_def_res_z + -1*dd_def_res_z)/2,
         adult_overperf2 = (fs_def_res_z + -1*ag_def_res_z)/2)
```

Here is the same plot as above. There is still a clear negative correlation between relative growth in the two hosts (notice how the endothermy effect was removed by using residuals).

```{r}
ggplot(two_hosts_p, aes(x = rg_int_res_z, y = rg_def_res_z, color = factor(endo_def))) +
  geom_point(aes(shape = missing_rg_ih == "yes"|missing_rg_dh == "yes")) +
  guides(color = F, shape = F) +
  scale_shape_manual(values = c(16, 4)) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto def host", "Endo def host")) +
  geom_smooth(method=lm, se =F ) +
  facet_wrap(~parasite_phylum)
```
More generally, the correlations among response variables did not change much after accounting for model fixed effects.

```{r}
fa <- ggplot(two_hosts_p, aes(z_rg_int_host, z_rg_def_host)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  labs(title = "Observed, z-standardized") +
  facet_wrap(~parasite_phylum)
fa2 <- ggplot(two_hosts_p, aes(rg_int_res_z, rg_def_res_z)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  labs(title = "Residuals") +
  facet_wrap(~parasite_phylum)
fb <- ggplot(two_hosts_p, aes(y = z_rg_int_host, x = z_dd_int_host)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)
fb2 <- ggplot(two_hosts_p, aes(y = rg_int_res_z, x = dd_int_res_z)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)
fc <- ggplot(two_hosts_p, aes(y = z_rg_def_host, x = z_dd_def_host)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)
fc2 <- ggplot(two_hosts_p, aes(y = rg_def_res_z, x = dd_def_res_z)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)
fd <- ggplot(two_hosts_p, aes(z_dd_int_host, z_dd_def_host)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)
fd2 <- ggplot(two_hosts_p, aes(dd_int_res_z, dd_def_res_z)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)

cowplot::plot_grid(fa, fa2, fb, fb2, fc, fc2, fd, fd2, ncol = 2)
```

```{r}
fa <- ggplot(two_hosts_p, aes(z_ag_def_host, z_fs_def_host)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  labs(title = "Not residuals") +
  facet_wrap(~parasite_phylum)
fa2 <- ggplot(two_hosts_p, aes(ag_def_res_z, fs_def_res_z)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  labs(title = "Residuals") +
  facet_wrap(~parasite_phylum)
fb <- ggplot(two_hosts_p, aes(y = z_fs_def_host, x = z_rg_int_host)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)
fb2 <- ggplot(two_hosts_p, aes(y = fs_def_res_z, x = rg_int_res_z)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)
fc <- ggplot(two_hosts_p, aes(y = z_fs_def_host, x = z_rg_def_host)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)
fc2 <- ggplot(two_hosts_p, aes(y = fs_def_res_z, x = rg_def_res_z)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)
fd <- ggplot(two_hosts_p, aes(y = z_ag_def_host, x = z_dd_def_host)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)
fd2 <- ggplot(two_hosts_p, aes(y = ag_def_res_z, x = dd_def_res_z)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum)

cowplot::plot_grid(fa, fa2, fb, fb2, fc, fc2, fd, fd2, ncol = 2)
```

We also average the residuals for size and age to assess over and under-performance. For example, here is the correlation between developmental time and relative growth in the intermediate host. Points are colored by their average residuals (i.e. whether they overperform or underperform).

```{r}
ggplot(two_hosts_p, 
       aes(x = dd_int_host, y = rg_int_host, color = larval_overperf)) +
  geom_point(aes(shape = missing_rg_ih == "yes"|missing_dd_ih == "yes")) +
  scale_shape_manual(values = c(16, 4)) +
  geom_smooth(se = F, method = lm) +
  scale_color_distiller(palette = "Spectral") +
  guides(color = F, shape = F) +
  facet_wrap(~ parasite_phylum) 
```
We can calculate over and underperformance for three developmental periods: in the intermediate host, in the definitive host, and over the whole life. When we plot these against each other, we see that larval and adult growth are unrelated, larval growth slightly increases lifetime growth, and adult growth clearly increases lifetime growth.

```{r}
fa <- ggplot(two_hosts_p, 
       aes(x = larval_overperf, y = adult_overperf)) +
  geom_point(aes(shape = missing_rg_ih == "yes"|missing_dd_ih == "yes"|
                   missing_rg_dh == "yes"|missing_dd_dh == "yes")) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(se = F, method = lm) +
  facet_wrap(~ parasite_phylum) +
  scale_shape_manual(values = c(16, 4)) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank()) +
  labs(x = "Larval growth", y = "Adult growth")
fb <- ggplot(two_hosts_p, 
       aes(x = larval_overperf, y = adult_overperf2)) +
  geom_point(aes(shape = missing_rg_ih == "yes"|missing_dd_ih == "yes"|
                   missing_fs == "yes"|missing_ag == "yes")) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(se = F, method = lm) +
  facet_wrap(~ parasite_phylum) +
  scale_shape_manual(values = c(16, 4)) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank()) +
  labs(x = "Larval growth", y = "Lifetime growth")
fc <- ggplot(two_hosts_p, 
       aes(x = adult_overperf, y = adult_overperf2)) +
  geom_point(aes(shape = missing_rg_dh == "yes"|missing_dd_dh == "yes"|
                   missing_fs == "yes"|missing_ag == "yes")) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(se = F, method = lm) +
  facet_wrap(~ parasite_phylum) +
  scale_shape_manual(values = c(16, 4)) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank()) +
  labs(x = "Adult growth", y = "Lifetime growth")
cowplot::plot_grid(fa, fb, fc, ncol = 1)
```
The absence of a negative relationship between larval and adult performance is surprising, since higher larval growth resulted in less adult growth. However, less adult growth was also associated with shorter developmental times. Thus, in species with overachieving larvae, the adults grow less but also have short development, suggesting they do not underachieve as adults.

```{r}
fa <- ggplot(two_hosts_p, 
       aes(x = larval_overperf, y = rg_def_res_z)) +
  geom_point() +
  geom_smooth(se = F, method = lm) +
  facet_wrap(~ parasite_phylum)
fb <- ggplot(two_hosts_p, 
       aes(x = larval_overperf, y = dd_def_res_z)) +
  geom_point() +
  geom_smooth(se = F, method = lm) +
  facet_wrap(~ parasite_phylum)
cowplot::plot_grid(fa, fb, ncol = 1)
```

## Taxonomic mixed models

Since both parasite life history and host traits are phylogenetically structured, it is possible that some of these effects disappear when we control for parasite ancestry. We next fit the same series of models, but including parasite taxonomy as nested random effects. The residuals can covary, since our response variables are clearly correlated.

```{r}
# add values for plotting
dx_avg <- select(two_hosts, int_host_mass_c, def_host_mass_c, endo_def_c, parasite_phylum)%>%
  group_by(endo_def_c, parasite_phylum)%>%
  summarize(min_ih = min(int_host_mass_c, na.rm = T),
            max_ih = max(int_host_mass_c, na.rm = T),
            min_dh = min(def_host_mass_c, na.rm = T),
            max_dh = max(def_host_mass_c, na.rm = T))

nd_ih <- bind_rows(
  data.frame(parasite_phylum = "Acanthocephala", endo_def = 0, endo_def_c = -0.5,
             int_host_mass_c = seq(dx_avg$min_ih[1], dx_avg$max_ih[1], length.out = 25),
             def_host_mass_c = 0,
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1]),
  data.frame(parasite_phylum = "Cestoda", endo_def = 0, endo_def_c = -0.5,
             int_host_mass_c = seq(dx_avg$min_ih[2], dx_avg$max_ih[2], length.out = 25),
             def_host_mass_c = 0,
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1]),
  data.frame(parasite_phylum = "Nematoda", endo_def = 0, endo_def_c = -0.5,
             int_host_mass_c = seq(dx_avg$min_ih[3], dx_avg$max_ih[3], length.out = 25),
             def_host_mass_c = 0,
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1]),
  data.frame(parasite_phylum = "Acanthocephala", endo_def = 1, endo_def_c = 0.5,
             int_host_mass_c = seq(dx_avg$min_ih[4], dx_avg$max_ih[4], length.out = 25),
             def_host_mass_c = 0,
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1]),
  data.frame(parasite_phylum = "Cestoda", endo_def = 1, endo_def_c = 0.5,
             int_host_mass_c = seq(dx_avg$min_ih[5], dx_avg$max_ih[5], length.out = 25),
             def_host_mass_c = 0,
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1]),
  data.frame(parasite_phylum = "Nematoda", endo_def = 1, endo_def_c = 0.5,
             int_host_mass_c = seq(dx_avg$min_ih[6], dx_avg$max_ih[6], length.out = 25),
             def_host_mass_c = 0,
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1])
)

nd_dh <- bind_rows(
  data.frame(parasite_phylum = "Acanthocephala", endo_def = 0, endo_def_c = -0.5,
             int_host_mass_c = 0,
             def_host_mass_c = seq(dx_avg$min_dh[1], dx_avg$max_dh[1], length.out = 25),
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1]),
  data.frame(parasite_phylum = "Cestoda", endo_def = 0, endo_def_c = -0.5,
             int_host_mass_c = 0,
             def_host_mass_c = seq(dx_avg$min_dh[2], dx_avg$max_dh[2], length.out = 50),
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1]),
  data.frame(parasite_phylum = "Nematoda", endo_def = 0, endo_def_c = -0.5,
             int_host_mass_c = 0,
             def_host_mass_c = seq(dx_avg$min_dh[3], dx_avg$max_dh[3], length.out = 25),
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1]),
  data.frame(parasite_phylum = "Acanthocephala", endo_def = 1, endo_def_c = 0.5,
             int_host_mass_c = 0,
             def_host_mass_c = seq(dx_avg$min_dh[4], dx_avg$max_dh[4], length.out = 25),
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1]),
  data.frame(parasite_phylum = "Cestoda", endo_def = 1, endo_def_c = 0.5,
             int_host_mass_c = 0,
             def_host_mass_c = seq(dx_avg$min_dh[5], dx_avg$max_dh[5], length.out = 25),
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1]),
  data.frame(parasite_phylum = "Nematoda", endo_def = 1, endo_def_c = 0.5,
             int_host_mass_c = 0,
             def_host_mass_c = seq(dx_avg$min_dh[6], dx_avg$max_dh[6], length.out = 25),
             tree_tips = unique(two_hosts$tree_tips)[1],
             parasite_genus = unique(two_hosts$parasite_genus)[1],
             parasite_family = unique(two_hosts$parasite_family)[1],
             parasite_order = unique(two_hosts$parasite_order)[1],
             parasite_class = unique(two_hosts$parasite_class)[1])
)
  
nd_ih$pred <- "yes IH"
nd_dh$pred <- "yes DH"

two_hosts2 <- bind_rows(two_hosts, nd_ih, nd_dh)
two_hosts2 <- two_hosts2%>%
  mutate(obs = 1:length(Parasite.species))
```

```{r}
prior_tax <- list(R = list(R1 = list(V = diag(6), n = 1)),
                  G = list(
                    G1 = list(V = diag(6)/5, n = 2),
                    G2 = list(V = diag(6)/5, n = 2),
                    G3 = list(V = diag(6)/5, n = 2),                       
                    G4 = list(V = diag(6)/5, n = 2),
                    G5 = list(V = diag(6)/5, n = 2)
                    ))
prior_tax2 <- list(R = list(R1 = list(V = diag(6), n = 1)),
                  G = list(
                    G1 = list(V = diag(6)/4, n = 2),
                    G2 = list(V = diag(6)/4, n = 2),
                    G3 = list(V = diag(6)/4, n = 2),                       
                    G4 = list(V = diag(6)/4, n = 2)
                    ))
prior_taxtree <- list(R = list(R1 = list(V = diag(6), n = 1)),
                  G = list(G1 = list(V = diag(6), n = 1))
                  )
startc1 <- list(G = list(G1 = diag(6)/5,
                        G2 = diag(6)/5,
                        G3 = diag(6)/5,
                        G4 = diag(6)/5,
                        G5 = diag(6)/5),
              R = diag(6)/5
              )
startc2 <- list(G = list(G1 = diag(6)/4,
                        G2 = diag(6)/4,
                        G3 = diag(6)/4,
                        G4 = diag(6)/4),
              R = diag(6)/4
              )
```

```{r}
chains1t = list()
chains2t = list()
chains3t = list()
chains4t = list()

nit <- 1000 # number of iterations for models
bi <- 500 # burnin iterations

for(i in 1:100){

  iname <- ifelse(i < 10, paste0('00',i), 
                  ifelse(i < 100, paste0('0',i),i))
  fname_p <- paste0('../../data/imputed_stage_level_tables/stage_level_imputed',iname,'.csv')
  dat_imp <- read.csv(file = fname_p, header = T)
  
  two_hosts_imp <- wrangle_data(dat_imp)
  two_hosts_imp2 <- bind_rows(two_hosts, nd_ih, nd_dh)
  two_hosts_imp2 <- two_hosts_imp2%>%
    mutate(obs = 1:length(Parasite.species))
  
  # int_only, with taxonomy, residual covariance
  chains1t[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                     trait-1 ,
                  random = ~
                    idh(trait):parasite_genus +
                    idh(trait):parasite_family +
                    idh(trait):parasite_order +
                    idh(trait):parasite_class +
                    idh(trait):parasite_phylum,
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_tax, start = startc1,
                  data = as.data.frame(two_hosts_imp2),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=T, 
                  verbose = F)
  # with fixed effects and taxonomy but no taxonomic covariance
  chains2t[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                     trait-1 +
                     trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c,
                  random = ~
                    idh(trait):parasite_genus +
                    idh(trait):parasite_family +
                    idh(trait):parasite_order +
                    idh(trait):parasite_class +
                    idh(trait):parasite_phylum,
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_tax, start = startc1,
                  data = as.data.frame(two_hosts_imp2),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  # with fixed effects, 2nd-order interactions and taxonomy but no taxonomic covariance
  chains3t[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~ 
                     trait-1 +
                     trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c + 
                     trait:int_host_mass_c:def_host_mass_c +
                     trait:int_host_mass_c:endo_def_c +
                     trait:def_host_mass_c:endo_def_c,
                  random = ~
                    idh(trait):parasite_genus +
                    idh(trait):parasite_family +
                    idh(trait):parasite_order +
                    idh(trait):parasite_class +
                    idh(trait):parasite_phylum,
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_tax, start = startc1,
                  data = as.data.frame(two_hosts_imp2),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  # move parasite group to fixed effects
  chains4t[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                    trait-1 +
                    trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c + 
                    trait:int_host_mass_c:def_host_mass_c +
                    trait:int_host_mass_c:endo_def_c +
                    trait:def_host_mass_c:endo_def_c +
                    trait:parasite_phylum + 
                    trait:parasite_phylum:int_host_mass_c + trait:parasite_phylum:def_host_mass_c +
                    trait:parasite_phylum:endo_def_c, 
                  random = ~
                    idh(trait):parasite_genus +
                    idh(trait):parasite_family +
                    idh(trait):parasite_order +
                    idh(trait):parasite_class,
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_tax2, start = startc2,
                  data = as.data.frame(two_hosts_imp2),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  
  s <- round(runif(1, min = 1, max = dim(chains4t[[i]]$VCV)[1]),0) # picks ran iter
  
  startc1 <- list(G = list(
    G1 = diag(round(chains2t[[i]]$VCV[s,1:6],6)),
    G2 = diag(round(chains2t[[i]]$VCV[s,7:12],6)),
    G3 = diag(round(chains2t[[i]]$VCV[s,13:18],6)),
    G4 = diag(round(chains2t[[i]]$VCV[s,19:24],6)),
    G5 = diag(round(chains2t[[i]]$VCV[s,25:30],6))
                        ),
    R = matrix(round(
      chains2t[[i]]$VCV[s,grepl(pattern = ".units$", colnames(chains2t[[i]]$VCV))],                                 6),
      nrow = 6, ncol = 6)
    )

  startc2 <- list(G = list(
    G1 = diag(round(chains4t[[i]]$VCV[s,1:6],6)),
    G2 = diag(round(chains4t[[i]]$VCV[s,7:12],6)),
    G3 = diag(round(chains4t[[i]]$VCV[s,13:18],6)),
    G4 = diag(round(chains4t[[i]]$VCV[s,19:24],6))
    ),
    R = matrix(round(
      chains4t[[i]]$VCV[s,grepl(pattern = ".units$", colnames(chains4t[[i]]$VCV))],
      6),
      nrow = 6, ncol = 6)
    )

  print(paste('taxonomic models, imputation', i, 'finished'))
}
```
```{r}
# substitute total growth for relative growth in models - for comparing means for each trait, not fixed effects or covariances 
chains1tg = list()
chains1ptg = list()
chains1ttg = list()
chains3ttg = list()
chains4ttg = list()

nit <- 1000 # number of iterations for models
bi <- 500 # burnin iterations

for(i in 1:100){

  iname <- ifelse(i < 10, paste0('00',i), 
                  ifelse(i < 100, paste0('0',i),i))
  fname_p <- paste0('../../data/imputed_stage_level_tables/stage_level_imputed',iname,'.csv')
  dat_imp <- read.csv(file = fname_p, header = T)
  
  two_hosts_imp <- wrangle_data(dat_imp)
  two_hosts_imp2 <- bind_rows(two_hosts, nd_ih, nd_dh)
  two_hosts_imp2 <- two_hosts_imp2%>%
    mutate(obs = 1:length(Parasite.species))
  
  # cov LH, species level
  chains1tg[[i]] <- MCMCglmm(cbind(tg_int_host, tg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~ trait-1, 
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_notax,
                  data = as.data.frame(two_hosts_imp),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  # cov LH, species level
  chains1ptg[[i]] <- MCMCglmm(cbind(tg_int_host, tg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~ trait-1 + trait:parasite_phylum, 
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_notax,
                  data = as.data.frame(two_hosts_imp),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  # int_only, with taxonomy, residual covariance
  chains1ttg[[i]] <- MCMCglmm(cbind(tg_int_host, tg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                     trait-1 ,
                  random = ~
                    idh(trait):parasite_genus +
                    idh(trait):parasite_family +
                    idh(trait):parasite_order +
                    idh(trait):parasite_class +
                    idh(trait):parasite_phylum,
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_tax, start = startc1,
                  data = as.data.frame(two_hosts_imp2),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=T, 
                  verbose = F)
  # with fixed effects, 2nd-order interactions and taxonomy but no taxonomic covariance
  chains3ttg[[i]] <- MCMCglmm(cbind(tg_int_host, tg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~ 
                     trait-1 +
                     trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c + 
                     trait:int_host_mass_c:def_host_mass_c +
                     trait:int_host_mass_c:endo_def_c +
                     trait:def_host_mass_c:endo_def_c,
                  random = ~
                    idh(trait):parasite_genus +
                    idh(trait):parasite_family +
                    idh(trait):parasite_order +
                    idh(trait):parasite_class +
                    idh(trait):parasite_phylum,
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_tax, start = startc1,
                  data = as.data.frame(two_hosts_imp2),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  # move parasite group to fixed effects
  chains4ttg[[i]] <- MCMCglmm(cbind(tg_int_host, tg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                    trait-1 +
                    trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c + 
                    trait:int_host_mass_c:def_host_mass_c +
                    trait:int_host_mass_c:endo_def_c +
                    trait:def_host_mass_c:endo_def_c +
                    trait:parasite_phylum + 
                    trait:parasite_phylum:int_host_mass_c + trait:parasite_phylum:def_host_mass_c +
                    trait:parasite_phylum:endo_def_c, 
                  random = ~
                    idh(trait):parasite_genus +
                    idh(trait):parasite_family +
                    idh(trait):parasite_order +
                    idh(trait):parasite_class,
                  rcov = ~us(trait):units, # residual var-covar unstructured
                  nitt = nit, thin = 50, burnin = bi,
                  prior = prior_tax2, start = startc2,
                  data = as.data.frame(two_hosts_imp2),
                  family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                  pr=F, 
                  verbose = F)
  
  s <- round(runif(1, min = 1, max = dim(chains4t[[i]]$VCV)[1]),0) # picks ran iter
  
  startc1 <- list(G = list(
    G1 = diag(round(chains2t[[i]]$VCV[s,1:6],6)),
    G2 = diag(round(chains2t[[i]]$VCV[s,7:12],6)),
    G3 = diag(round(chains2t[[i]]$VCV[s,13:18],6)),
    G4 = diag(round(chains2t[[i]]$VCV[s,19:24],6)),
    G5 = diag(round(chains2t[[i]]$VCV[s,25:30],6))
                        ),
    R = matrix(round(
      chains2t[[i]]$VCV[s,grepl(pattern = ".units$", colnames(chains2t[[i]]$VCV))],                                 6),
      nrow = 6, ncol = 6)
    )

  startc2 <- list(G = list(
    G1 = diag(round(chains4t[[i]]$VCV[s,1:6],6)),
    G2 = diag(round(chains4t[[i]]$VCV[s,7:12],6)),
    G3 = diag(round(chains4t[[i]]$VCV[s,13:18],6)),
    G4 = diag(round(chains4t[[i]]$VCV[s,19:24],6))
    ),
    R = matrix(round(
      chains4t[[i]]$VCV[s,grepl(pattern = ".units$", colnames(chains4t[[i]]$VCV))],
      6),
      nrow = 6, ncol = 6)
    )

  print(paste('total growth models, imputation', i, 'finished'))
}

mod_comb_sol1tg <- runjags::combine.mcmc(mcmc.list(lapply(chains1tg, function(x) {x$Sol})))
mod_comb_sol1ptg <- runjags::combine.mcmc(mcmc.list(lapply(chains1ptg, function(x) {x$Sol})))
mod_comb_sol1ttg <- runjags::combine.mcmc(mcmc.list(lapply(chains1ttg, function(x) {x$Sol})))
mod_comb_sol3ttg <- runjags::combine.mcmc(mcmc.list(lapply(chains3ttg, function(x) {x$Sol})))
mod_comb_sol4ttg <- runjags::combine.mcmc(mcmc.list(lapply(chains4ttg, function(x) {x$Sol})))
```





```{r}
mod_comb_dev1t <- runjags::combine.mcmc(mcmc.list(lapply(chains1t, name_dev_var)))
mod_comb_dev4t <- runjags::combine.mcmc(mcmc.list(lapply(chains4t, name_dev_var)))
```

Adding taxonomy is clearly important. It improves the model without fixed effects...

```{r}
plot(mcmc.list(mod_comb_dev1, mod_comb_dev1t), density = F)
```

...as well as the model with fixed effects.

```{r}
plot(mcmc.list(mod_comb_dev4, mod_comb_dev4t), density = F)
```

This suggests that parasite traits are taxonomically structured, even after controlling for host masses. We also compared models treating phylogeny as nested taxonomic levels or as a phylogenetic tree. In the models with the phylogeny, the variance components were very large, which usually happens when closely related species are quite different (i.e. big phenotypic change on short branches, which may be more measurement error than evolution). Despite this, the phylogenetic models were much worse than the taxonomic ones. This suggests that not all parts of the tree are informative.

## Model parameters

```{r}
# combine the chains
mod_comb_sol1t <- runjags::combine.mcmc(mcmc.list(lapply(chains1t, function(x) {x$Sol})))
mod_comb_sol2t <- runjags::combine.mcmc(mcmc.list(lapply(chains2t, function(x) {x$Sol})))
mod_comb_sol3t <- runjags::combine.mcmc(mcmc.list(lapply(chains3t, function(x) {x$Sol})))
mod_comb_sol4t <- runjags::combine.mcmc(mcmc.list(lapply(chains4t, function(x) {x$Sol})))
```

### Larval growth

Since taxonomy clearly impacts parasite life history, we should reexamine the fixed effects, starting with larval growth. Larval parasites grow more when the intermediate host is large. The relationship with endothermy seems to depend on intermediate host size.

```{r}
s <- data.frame(quant = summary(mod_comb_sol4t[,
                                        grepl("traitrg_int", colnames(mod_comb_sol4t))])$quantiles)
mutate(s, param = gsub("traitrg_int_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

Here is how much relative larval growth increased with a doubling of intermediate host mass.

```{r}
summary( exp(mod_comb_sol2t[,"traitrg_int_host:int_host_mass_c"] * log(2)) - 1) 
```
However, this relationship depended on whether the next host was an endotherm or not. Here is how much larval growth increased with intermediate host mass when the definitive host was an ectotherm:

```{r}
summary( exp( (mod_comb_sol3t[,"traitrg_int_host:int_host_mass_c"] + 
                 0 * -0.5) * # endothermy was centered
                log(2)) - 1) 
```

And when it was an endotherm (though this was also dependent on the parasite group): 

```{r}
summary( exp( (mod_comb_sol3t[,"traitrg_int_host:int_host_mass_c"] + mod_comb_sol3t[,"traitrg_int_host:int_host_mass_c:endo_def_c"] * 0.5) * #
                log(2)) - 1) 
```

Here is how much larval growth decreased when the next host was an endotherm (avg int and def host masses).

```{r}
# full host trait model
pdx <- chains3t[[1]]$X # model matrix, fixed effx
n <- dim(pdx)[1] # number of data points in model, all traits
nt <- n/6 # number of data points per trait
# p_i <- which(!is.na(two_hosts2$pred)) # points where we want predicted vals and cred int
# pdx <- pdx[c(p_i, nt+p_i, nt*2+p_i,
#              nt*3+p_i,nt*4+p_i,nt*5+p_i),] # restrict to only points where we want preds
p_n <- dim(pdx)[1]/6 # number of points for each trait we want to predict
num_fe <- chains3t[[1]]$Fixed$nfl # number of fixed effx, rand effx marginalized
p <- as.matrix(pdx) %*% t(mod_comb_sol3t[,1:num_fe]) # predicteds via matrix mult for combined model runs, no taxonomic effx

# predictions for every iteration for every data point
px <- data.frame(two_hosts2,
  # filter(two_hosts2, !is.na(pred)),
                rg_int_pred = p[1:p_n,],
                rg_def_pred = p[(p_n+1):(p_n*2),],
                dd_int_pred = p[(p_n*2+1):(p_n*3),],
                dd_def_pred = p[(p_n*3+1):(p_n*4),],
                fs_def_pred = p[(p_n*4+1):(p_n*5),],
                ag_def_pred = p[(p_n*5+1):(p_n*6),])

# reshape predicted vals for all iter, calc fit and quantiles
p_all <- px%>%
  pivot_longer(
    cols = rg_int_pred.1:names(px)[length(px)],
    names_to = c("trait","iter"),
    names_sep = "\\.",
    values_to = "mod_pred"
  )%>%
  group_by(obs, pred, trait)%>%
  summarise(fit = median(mod_pred),
            lwr = quantile(mod_pred, probs = 0.025),
            upr = quantile(mod_pred, probs = 0.975))

p <- p_all%>%
  pivot_wider(id = obs, names_from = trait, values_from = fit:upr)

rm(px,pdx, n, nt, p_i, p_n, num_fe)
```


```{r}
p <- left_join(two_hosts2, p, by = "obs")%>%
  filter(!is.na(pred))
filter(p, pred == "yes IH")%>%
  group_by(endo_def)%>%
  mutate(diff_from_wanted = abs(int_host_mass_c - 0))%>%
  arrange(diff_from_wanted)%>%
  slice(1)%>%
  select(int_host_mass_c, def_host_mass_c, endo_def,
         lwr_rg_int_pred, fit_rg_int_pred, upr_rg_int_pred)%>%
  mutate(fold_change.lwr = exp(lwr_rg_int_pred), 
         fold_change.fit = exp(fit_rg_int_pred),
         fold_change.upr = exp(upr_rg_int_pred))
```

Here is the average increase in size in an average intermediate host (fold change).

```{r}
s <- data.frame(quant = summary(mod_comb_sol3t[,
                                        grepl("traitrg_int", colnames(mod_comb_sol3t))])$quantiles)
mutate(s, param = gsub("traitrg_int_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%
  filter(param == "traitrg_int_host")%>%
  mutate(avg_fold_change_IH_lwr = exp(lwr),
         avg_fold_change_IH = exp(fit), 
         avg_fold_change_IH_upr = exp(upr))%>%
  select(param, avg_fold_change_IH_lwr, avg_fold_change_IH, avg_fold_change_IH_upr)
```

We can also explore how the average growth values depend on the model.

```{r}
compare_model_means <- function(trait){

# RAW
x <- bind_rows(
  data.frame(
    rg_int = quantile(
      mod_comb_sol1[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Combined", model = "raw"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol1p[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1p))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Acanthocephala", model = "raw"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol1p[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1p))] + 
        mod_comb_sol1p[,grepl(paste0("trait", trait,":parasite_phylumCestoda"), colnames(mod_comb_sol1p))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Cestoda", model = "raw"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol1p[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1p))] + 
    mod_comb_sol1p[,grepl(paste0("trait", trait,":parasite_phylumNematoda"), colnames(mod_comb_sol1p))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Nematoda", model = "raw"
    )
  )
# TAX
y <- bind_rows(
  data.frame(
    rg_int = quantile(
      mod_comb_sol1t[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1t))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Combined", model = "tax"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol1t[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1t))] + 
        mod_comb_sol1t[,grepl(paste0("trait", trait,".parasite_phylum.Acanthocephala"), colnames(mod_comb_sol1t))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Acanthocephala", model = "tax"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol1t[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1t))] + 
        mod_comb_sol1t[,grepl(paste0("trait", trait,".parasite_phylum.Cestoda"), colnames(mod_comb_sol1t))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Cestoda", model = "tax"
    ),
  data.frame(
    rg_int = quantile(mod_comb_sol1t[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1t))] + 
        mod_comb_sol1t[,grepl(paste0("trait", trait,".parasite_phylum.Nematoda"), colnames(mod_comb_sol1t))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Nematoda", model = "tax"
    )
  )

# TAX, FIXED
z <- bind_rows(
  data.frame(
    rg_int = quantile(
      mod_comb_sol3t[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol3t))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Combined", model = "tax2"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol4t[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol4t))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Acanthocephala", model = "tax2"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol4t[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol4t))] + 
        mod_comb_sol4t[,grepl(paste0("trait", trait,":parasite_phylumCestoda"), colnames(mod_comb_sol4t))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Cestoda", model = "tax2"
    ),
  data.frame(
    rg_int = quantile(mod_comb_sol4t[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol4t))] + 
        mod_comb_sol4t[,grepl(paste0("trait", trait,":parasite_phylumNematoda"), colnames(mod_comb_sol4t))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Nematoda", model = "tax2"
    )
  )

mod_means <- bind_rows(x%>%
            pivot_wider(names_from = quant, values_from = rg_int),
          y%>%
            pivot_wider(names_from = quant, values_from = rg_int),
          z%>%
            pivot_wider(names_from = quant, values_from = rg_int)
)%>%
  mutate(trait = trait)
  
return(mod_means)
}

```

The models are reasonably consistent.

```{r}
rg_int_mod_means <- compare_model_means("rg_int_host")

ggplot(rg_int_mod_means%>%
         mutate(group = fct_relevel(group, c("Combined", "Acanthocephala", "Cestoda", "Nematoda"))), aes(x = model, y = exp(fit))) +
  geom_pointrange(aes(ymin=exp(lwr), ymax=exp(upr))) +
  scale_y_log10() +
  scale_x_discrete(labels = c("no tax", "taxonomy", "tax + host traits")) +
  labs(x = NULL, y = "Relative growth (fold change)") +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  facet_wrap(~group)
```


### Larval development

The average time spent developing as larvae (days at 20 C):

```{r}
s <- data.frame(quant = summary(mod_comb_sol3t[,
                                        grepl("traitdd_int", colnames(mod_comb_sol3t))])$quantiles)
mutate(s, param = gsub("traitdd_int_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%
  filter(param == "traitdd_int_host")%>%
  mutate(avg_dd_IH_lwr = exp(lwr)/15,
         avg_dd_IH = exp(fit)/15, 
         avg_dd_IH_upr = exp(upr)/15)%>%
  select(param, avg_dd_IH_lwr, avg_dd_IH, avg_dd_IH_upr)
```

The models are reasonably consistent.

```{r}
dd_int_mod_means <- compare_model_means("dd_int_host")

ggplot(dd_int_mod_means%>%
         mutate(group = fct_relevel(group, c("Combined", "Acanthocephala", "Cestoda", "Nematoda"))), 
       aes(x = model, y = exp(fit)/15)) +
  geom_pointrange(aes(ymin=exp(lwr)/15, ymax=exp(upr)/15)) +
  # scale_y_log10() +
  scale_x_discrete(labels = c("no tax", "taxonomy", "tax + host traits")) +
  labs(x = NULL, y = "Developmental time, days at 20 C") +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  facet_wrap(~group)
```

Larval developmental time increased significantly with intermediate host mass, but only when the next host was an ectotherm.

```{r}
s <- data.frame(quant = summary(mod_comb_sol3t[,
                                        grepl("traitdd_int", colnames(mod_comb_sol3t))])$quantiles)
mutate(s, param = gsub("traitdd_int_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

Here is the percent increase in larval DT with a doubling of intermediate host mass.

```{r}
summary( exp(mod_comb_sol2t[,"traitdd_int_host:int_host_mass_c"] * log(2)) - 1) 
```
However, this relationship depended on whether the next host was an endotherm or not. Here is how much larval development increased with intermediate host mass when the definitive host was an ectotherm:

```{r}
summary( exp( (mod_comb_sol3t[,"traitdd_int_host:int_host_mass_c"] + 
                 0 * -0.5) * # endothermy was centered
                log(2)) - 1) 
```

And when it was an endotherm; a doubling of intermediate host mass has half the effect on larval developmental time.

```{r}
summary( exp( (mod_comb_sol3t[,"traitdd_int_host:int_host_mass_c"] +
                 mod_comb_sol3t[,"traitdd_int_host:int_host_mass_c:endo_def_c"] * 0.5) * #
                log(2)) - 1) 
```

Nematodes had shorter developmental times as larvae.

```{r}
s <- data.frame(quant = summary(mod_comb_sol4t[,
                                        grepl("traitdd_int", colnames(mod_comb_sol4t))])$quantiles)
mutate(s, param = gsub("traitdd_int_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```


### Adult growth

For adult growth, there is an effect of endothermy and a negative relationship with intermediate host size. 

```{r}
s <- data.frame(quant = summary(mod_comb_sol4t[,
                                        grepl("traitrg_def", colnames(mod_comb_sol4t))])$quantiles)
mutate(s, param = gsub("traitrg_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

There was not a clear relationship with definitive host mass, but that is because the relationship varies somewhat among groups. When we look at the parameters in the model without parasite groups, there is a positive relationship between definitive host mass and adult growth.

```{r}
s <- data.frame(quant = summary(mod_comb_sol3t[,
                                        grepl("traitrg_def", colnames(mod_comb_sol3t))])$quantiles)
s <- mutate(s, param = gsub("traitrg_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
s
```

Here is how much relative adult growth increased with a doubling of definitive host mass overall.

```{r}
summary( exp(mod_comb_sol2t[,"traitrg_def_host:def_host_mass_c"] * log(2)) - 1) 
```
And here is how much adult growth decreased with a doubling of intermediate host mass.

```{r}
summary( exp(mod_comb_sol2t[,"traitrg_def_host:int_host_mass_c"] * log(2)) - 1) 
```
However, this decrease depended on whether the definitive host was an endotherm or not. Adult growth decreased this much with a doubling of intermediate host mass when the next host was an ectotherm:

```{r}
summary( exp( (mod_comb_sol3t[,"traitrg_def_host:int_host_mass_c"] + 0 * -0.5) * log(2)) - 1) 
```
But much less when the definitive host was an endotherm: 

```{r}
summary( exp( (mod_comb_sol3t[,"traitrg_def_host:int_host_mass_c"] + mod_comb_sol3t[,"traitrg_def_host:int_host_mass_c:endo_def_c"]*0.5) * log(2)) - 1) 
```

Here is the average increase in size in a definitive host (fold change).

```{r}
s%>%
  filter(param == "traitrg_def_host")%>%
  mutate(avg_fold_change_DH_lwr = exp(lwr),
         avg_fold_change_DH = exp(fit), 
         avg_fold_change_DH_upr = exp(upr))%>%
  select(param, avg_fold_change_DH_lwr, avg_fold_change_DH, avg_fold_change_DH_upr)
```

Here is how much adult worms grew in endotherms vs ectotherms.

```{r}
filter(p, pred == "yes DH")%>%
  group_by(endo_def)%>%
  mutate(diff_from_wanted = abs(def_host_mass_c - 0))%>%
  arrange(diff_from_wanted)%>%
  slice(1)%>%
  select(int_host_mass_c, def_host_mass_c, endo_def,
         lwr_rg_def_pred, fit_rg_def_pred, upr_rg_def_pred)%>%
  mutate(fold_change.lwr = exp(lwr_rg_def_pred), 
         fold_change.fit = exp(fit_rg_def_pred),
         fold_change.upr = exp(upr_rg_def_pred))
```

Here is how much adult worms grew in a small, endothermic definitive host (10 g)...

```{r}
filter(p, pred == "yes DH", endo_def == 1)%>%
  mutate(diff_from_wanted = abs(def_host_mass_c + mean(two_hosts$def_host_mass) - log(10)))%>%
  arrange(diff_from_wanted)%>%
  slice(1)%>%
  select(int_host_mass_c, def_host_mass_c, endo_def,
         lwr_rg_def_pred, fit_rg_def_pred, upr_rg_def_pred)%>%
  mutate(fold_change.lwr = exp(lwr_rg_def_pred), 
         fold_change.fit = exp(fit_rg_def_pred),
         fold_change.upr = exp(upr_rg_def_pred))
```

..and in a large endothermic definitive host (10 kg).

```{r}
filter(p, pred == "yes DH", endo_def == 1)%>%
  mutate(diff_from_wanted = abs(def_host_mass_c + mean(two_hosts$def_host_mass) - log(10^5)))%>%
  arrange(diff_from_wanted)%>%
  slice(1)%>%
  select(int_host_mass_c, def_host_mass_c, endo_def,
         lwr_rg_def_pred, fit_rg_def_pred, upr_rg_def_pred)%>%
  mutate(fold_change.lwr = exp(lwr_rg_def_pred), 
         fold_change.fit = exp(fit_rg_def_pred),
         fold_change.upr = exp(upr_rg_def_pred))
```

How does adult growth compare with larval growth?

```{r}
rg_def_mod_means <- compare_model_means("rg_def_host")
rg_comb <- bind_rows(rg_int_mod_means, rg_def_mod_means)

rg_int_def <- ggplot(rg_comb%>%
         mutate(group = fct_relevel(group, c("Combined", "Acanthocephala", "Cestoda", "Nematoda")),
                trait = fct_relevel(trait, c("rg_int_host", "rg_def_host"))), 
       aes(x = model, y = exp(fit), color = trait)) +
  geom_pointrange(aes(ymin=exp(lwr), ymax=exp(upr)),
                  position = position_dodge(width = 0.4)
                  ) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_x_discrete(labels = c("no tax", "taxonomy", "tax + host traits")) +
  scale_color_brewer(palette = "Pastel1", labels = c("IH", "DH")) +
  labs(x = NULL, y = "Relative growth (fold change)", color = NULL) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.position = c(0.95,0.95),
        legend.justification = c(1,1)) +
  facet_wrap(~group, nrow = 1)
rg_int_def
```

What percent of *relative* growth does an average worm (avg host masses) do in the definitive host, controlling for taxonomy? Another way to think of this is "doublings" per host. Here is the percent growth in the definitive host. It is quite evenly split. 

```{r}
rg_int <- (mod_comb_sol3t[,grepl("traitrg_int_host$", colnames(mod_comb_sol3t))] )
rg_def <- (mod_comb_sol3t[,grepl("traitrg_def_host$", colnames(mod_comb_sol3t))] )

summary(rg_def/(rg_int + rg_def))
```
But this depends on the group. Acanths grow relatively less in the definitive host, because they have bigger larvae.

```{r}
rg_int <- (mod_comb_sol4t[,grepl("traitrg_int_host$", colnames(mod_comb_sol4t))] )
rg_def <- (mod_comb_sol4t[,grepl("traitrg_def_host$", colnames(mod_comb_sol4t))] )

summary(rg_def/(rg_int + rg_def))
```
cestodes:

```{r}
rg_int <- (
  mod_comb_sol4t[,grepl("traitrg_int_host$", colnames(mod_comb_sol4t))] +
        mod_comb_sol4t[,grepl("traitrg_int_host:parasite_phylumCestoda", colnames(mod_comb_sol4t))] 
  )
  
rg_def <- (
  mod_comb_sol4t[,grepl("traitrg_def_host$", colnames(mod_comb_sol4t))] +
        mod_comb_sol4t[,grepl("traitrg_def_host:parasite_phylumCestoda", colnames(mod_comb_sol4t))] 
  )

summary(rg_def/(rg_int + rg_def))
```

Nematodes grow relatively more as adults than larvae:

```{r}
rg_int <- (
  mod_comb_sol4t[,grepl("traitrg_int_host$", colnames(mod_comb_sol4t))] +
        mod_comb_sol4t[,grepl("traitrg_int_host:parasite_phylumNematoda", colnames(mod_comb_sol4t))] 
  )
  
rg_def <- (
  mod_comb_sol4t[,grepl("traitrg_def_host$", colnames(mod_comb_sol4t))] +
        mod_comb_sol4t[,grepl("traitrg_def_host:parasite_phylumNematoda", colnames(mod_comb_sol4t))] 
  )

summary(rg_def/(rg_int + rg_def))
```

It is also worth comparing *total* growth in the two hosts, not just *relative* growth.

```{r}
compare_model_means_tg <- function(trait){
# RAW
x <- bind_rows(
  data.frame(
    rg_int = quantile(
      mod_comb_sol1tg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1tg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Combined", model = "raw"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol1ptg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1ptg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Acanthocephala", model = "raw"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol1ptg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1ptg))] + 
        mod_comb_sol1ptg[,grepl(paste0("trait", trait,":parasite_phylumCestoda"), colnames(mod_comb_sol1ptg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Cestoda", model = "raw"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol1ptg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1ptg))] + 
    mod_comb_sol1ptg[,grepl(paste0("trait", trait,":parasite_phylumNematoda"), colnames(mod_comb_sol1ptg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Nematoda", model = "raw"
    )
  )
# TAX
y <- bind_rows(
  data.frame(
    rg_int = quantile(
      mod_comb_sol1ttg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1ttg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Combined", model = "tax"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol1ttg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1ttg))] + 
        mod_comb_sol1ttg[,grepl(paste0("trait", trait,".parasite_phylum.Acanthocephala"), colnames(mod_comb_sol1ttg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Acanthocephala", model = "tax"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol1ttg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1ttg))] + 
        mod_comb_sol1ttg[,grepl(paste0("trait", trait,".parasite_phylum.Cestoda"), colnames(mod_comb_sol1ttg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Cestoda", model = "tax"
    ),
  data.frame(
    rg_int = quantile(mod_comb_sol1ttg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol1ttg))] + 
        mod_comb_sol1ttg[,grepl(paste0("trait", trait,".parasite_phylum.Nematoda"), colnames(mod_comb_sol1ttg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Nematoda", model = "tax"
    )
  )

# TAX, FIXED
z <- bind_rows(
  data.frame(
    rg_int = quantile(
      mod_comb_sol3ttg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol3ttg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Combined", model = "tax2"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol4ttg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol4ttg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Acanthocephala", model = "tax2"
    ),
  data.frame(
    rg_int = quantile(
      mod_comb_sol4ttg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol4ttg))] + 
        mod_comb_sol4ttg[,grepl(paste0("trait", trait,":parasite_phylumCestoda"), colnames(mod_comb_sol4ttg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Cestoda", model = "tax2"
    ),
  data.frame(
    rg_int = quantile(mod_comb_sol4ttg[,grepl(paste0("trait", trait, "$"), colnames(mod_comb_sol4ttg))] + 
        mod_comb_sol4ttg[,grepl(paste0("trait", trait,":parasite_phylumNematoda"), colnames(mod_comb_sol4ttg))], probs = c(0.025,0.5,0.975)),
    quant = c("lwr", "fit", "upr"), group = "Nematoda", model = "tax2"
    )
  )

mod_means <- bind_rows(x%>%
            pivot_wider(names_from = quant, values_from = rg_int),
          y%>%
            pivot_wider(names_from = quant, values_from = rg_int),
          z%>%
            pivot_wider(names_from = quant, values_from = rg_int)
)%>%
  mutate(trait = trait)
return(mod_means)
}
```

Most growth is conducted in the DH. That is not strongly dependent on correcting for host size, taxonomy, etc.

```{r}
tg_int_mod_means <- compare_model_means_tg("tg_int_host")
tg_def_mod_means <- compare_model_means_tg("tg_def_host")
tg_comb <- bind_rows(tg_int_mod_means, tg_def_mod_means)

tg_int_def <- ggplot(tg_comb%>%
         mutate(group = fct_relevel(group, c("Combined", "Acanthocephala", "Cestoda", "Nematoda")),
                trait = fct_relevel(trait, c("tg_int_host", "tg_def_host"))), 
       aes(x = model, y = exp(fit), color = trait)) +
  geom_pointrange(aes(ymin=exp(lwr), ymax=exp(upr)),
                  position = position_dodge(width = 0.4)
                  ) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_x_discrete(labels = c("no tax", "taxonomy", "tax + host traits")) +
  scale_color_brewer(palette = "Pastel1", labels = c("IH", "DH")) +
  labs(x = NULL, color = NULL,
       y = "Total growth\n(~mg amassed)") +
  guides(color = F) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.position = c(0.95,0.95),
        legend.justification = c(1,1)) +
  facet_wrap(~group, nrow = 1)
tg_int_def
```

The average worm accumulates around 10 mg in the definitive host.

```{r}
tg_def <- exp(mod_comb_sol3ttg[,grepl("traittg_def_host$", colnames(mod_comb_sol3ttg))] )
summary(tg_def)
```
By contrast, they average less than 100 ug in the intermediate host.

```{r}
tg_int <- exp(mod_comb_sol3ttg[,grepl("traittg_int_host$", colnames(mod_comb_sol3ttg))] )
summary(tg_int*1000)
```
Thus, essentially all of the *total* growth is in the DH, controlling for host masses and taxonomy.

```{r}
summary(tg_def/(tg_int + tg_def))
```
This high percentage is essentially the same for acanths:

```{r}
tg_int <- exp(mod_comb_sol4ttg[,grepl("traittg_int_host$", colnames(mod_comb_sol4ttg))] )
tg_def <- exp(mod_comb_sol4ttg[,grepl("traittg_def_host$", colnames(mod_comb_sol4ttg))] )

summary(tg_def/(tg_int + tg_def))
```
cestodes:

```{r}
tg_int <- exp(
  mod_comb_sol4ttg[,grepl("traittg_int_host$", colnames(mod_comb_sol4ttg))] +
        mod_comb_sol4ttg[,grepl("traittg_int_host:parasite_phylumCestoda", colnames(mod_comb_sol4ttg))] 
  )
  
tg_def <- exp(
  mod_comb_sol4ttg[,grepl("traittg_def_host$", colnames(mod_comb_sol4ttg))] +
        mod_comb_sol4ttg[,grepl("traittg_def_host:parasite_phylumCestoda", colnames(mod_comb_sol4ttg))] 
  )

summary(tg_def/(tg_int + tg_def))
```

and nematodes:

```{r}
tg_int <- exp(
  mod_comb_sol4ttg[,grepl("traittg_int_host$", colnames(mod_comb_sol4ttg))] +
        mod_comb_sol4ttg[,grepl("traittg_int_host:parasite_phylumNematoda", colnames(mod_comb_sol4ttg))] 
  )
  
tg_def <- exp(
  mod_comb_sol4ttg[,grepl("traittg_def_host$", colnames(mod_comb_sol4ttg))] +
        mod_comb_sol4ttg[,grepl("traittg_def_host:parasite_phylumNematoda", colnames(mod_comb_sol4ttg))] 
  )

summary(tg_def/(tg_int + tg_def))
```


### Adult development

The average time spent in the definitive host (days at 20 C):

```{r}
s <- data.frame(quant = summary(mod_comb_sol3t[,
                                        grepl("traitdd_def", colnames(mod_comb_sol3t))])$quantiles)
mutate(s, param = gsub("traitdd_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%
  filter(param == "traitdd_def_host")%>%
  mutate(avg_dd_DH_lwr = exp(lwr)/15,
         avg_dd_DH = exp(fit)/15, 
         avg_dd_DH_upr = exp(upr)/15)%>%
  select(param, avg_dd_DH_lwr, avg_dd_DH, avg_dd_DH_upr)
```

Adult development was longer in big hosts, but mainly ectotherms, and shorter when the intermediate host was large and the definitive host was an ectotherm.

```{r}
s <- data.frame(quant = summary(mod_comb_sol3t[,
                                        grepl("traitdd_def", colnames(mod_comb_sol3t))])$quantiles)
mutate(s, param = gsub("traitdd_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

Here is the percent increase in adult DT with a doubling of definitive host mass.

```{r}
summary( exp(mod_comb_sol2t[,"traitdd_def_host:def_host_mass_c"] * log(2)) - 1) 
```
However, this relationship depended on whether the definitive host was an endotherm or not. Here is how much prepatent periods increased when the definitive host was an ectotherm:

```{r}
summary( exp( (mod_comb_sol3t[,"traitdd_def_host:def_host_mass_c"] + 
                 0 * -0.5) * # endothermy was centered
                log(2)) - 1) 
```

And when it was an endotherm; a doubling of definitive host mass has about half the effect on larval developmental time.

```{r}
summary( exp( (mod_comb_sol3t[,"traitdd_def_host:def_host_mass_c"] + mod_comb_sol3t[,"traitdd_def_host:def_host_mass_c:endo_def_c"] * 0.5) * #
                log(2)) - 1) 
```

Most trends were consistent across groups.

```{r}
s <- data.frame(quant = summary(mod_comb_sol4t[,
                                        grepl("traitdd_def", colnames(mod_comb_sol4t))])$quantiles)
mutate(s, param = gsub("traitdd_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

How does adult development compare with larval development?

```{r}
dd_def_mod_means <- compare_model_means("dd_def_host")
dd_comb <- bind_rows(dd_int_mod_means, dd_def_mod_means)

dd_int_def <- ggplot(dd_comb%>%
         mutate(group = fct_relevel(group, c("Combined", "Acanthocephala", "Cestoda", "Nematoda")),
                trait = fct_relevel(trait, c("dd_int_host", "dd_def_host"))), 
       aes(x = model, y = exp(fit)/15, color = trait)) +
  geom_pointrange(aes(ymin=exp(lwr)/15, ymax=exp(upr)/15),
                  position = position_dodge(width = 0.4)
                  ) +
  scale_y_log10() +
  scale_x_discrete(labels = c("no tax", "tax", "tax + host")) +
  scale_color_brewer(palette = "Pastel1", labels = c("IH", "DH")) +
  labs(x = NULL, color = NULL,
       y = "Developmental time\n(days at 20 C)") +
  guides(color = F) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.position = c(0.95,0.95),
        legend.justification = c(1,1)) +
  facet_wrap(~group, nrow = 1)
dd_int_def
```
```{r}
# output figure combining absolute, relative, dt in IH vs DH
fsx <- cowplot::plot_grid(tg_int_def + theme(axis.text.x = element_blank()),
                          rg_int_def + theme(axis.text.x = element_blank()),
                          dd_int_def,
                          labels = c("(a)","(b)","(c)"), ncol = 1, align = "hv")
ggsave(fsx, filename = "../../figs/figB1_imp.png", width = 8, height = 8)
ggsave(fsx, filename = "../../figs/figB1_imp.svg", width = 8, height = 8)
```


### Size at maturity

The pattern for adult size was similar to adult growth - it increases with definitive host mass when we do not consider differences among parasite groups.

```{r}
s <- data.frame(quant = summary(mod_comb_sol3t[,
                                        grepl("traitfs_def", colnames(mod_comb_sol3t))])$quantiles)
s <- mutate(s, param = gsub("traitfs_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
s
```

Here is how much size at maturity increases with a doubling of definitive host mass.

```{r}
summary( exp(mod_comb_sol3t[,"traitfs_def_host:def_host_mass_c"] * log(2)) - 1) # beta x "log diff corresponding to doubling of size"
```

But the effect is not evident once we allow interactions between parasite phylua and host traits. Also, unlike for adult growth, there is no relationship between adult size and intermediate host size.

```{r}
s <- data.frame(quant = summary(mod_comb_sol4t[,
                                        grepl("traitfs_def", colnames(mod_comb_sol4t))])$quantiles)
mutate(s, param = gsub("traitfs_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

### Age at maturity

Age at maturity tended to increase with definitive host mass.
```{r}
s <- data.frame(quant = summary(mod_comb_sol3t[,
                                        grepl("traitag_def", colnames(mod_comb_sol3t))])$quantiles)
mutate(s, param = gsub("traitag_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

Here is how much age at maturity increased with a doubling of definitive host mass.

```{r}
summary( exp(mod_comb_sol3t[,"traitag_def_host:def_host_mass_c"] * log(2)) - 1) # beta x "log diff corresponding to doubling of size"
```

Here are the parameters from the larger model:

```{r}
s <- data.frame(quant = summary(mod_comb_sol4t[,
                                        grepl("traitag_def", colnames(mod_comb_sol4t))])$quantiles)
mutate(s, param = gsub("traitag_def_host:", "", row.names(s)))%>%
  mutate(sig = if_else( !(`quant.2.5.` < 0 & `quant.97.5.` > 0), "sig", "ns"))%>%
  select(param, lwr = `quant.2.5.`, fit = `quant.50.`, upr = `quant.97.5.`, sig)%>%arrange(param)
```

## Plotted model predictions - Figs 3 and 4

We plot the model predictions over the data to understand the patterns, starting with how the larval host affects life history strategies.

```{r}
# full host trait model
pdx <- chains4t[[1]]$X # model matrix, fixed effx
n <- dim(pdx)[1] # number of data points in model, all traits
nt <- n/6 # number of data points per trait
# p_i <- which(!is.na(two_hosts2$pred)) # points where we want predicted vals and cred int
# pdx <- pdx[c(p_i, nt+p_i, nt*2+p_i,
#              nt*3+p_i,nt*4+p_i,nt*5+p_i),] # restrict to only points where we want preds
p_n <- dim(pdx)[1]/6 # number of points for each trait we want to predict
num_fe <- chains4t[[1]]$Fixed$nfl # number of fixed effx, rand effx marginalized
p <- as.matrix(pdx) %*% t(mod_comb_sol4t[,1:num_fe]) # predicteds via matrix mult for combined model runs, no taxonomic effx

rgr_i <- p[1:p_n,]/(exp(p[(p_n*2+1):(p_n*3),])/15)
rgr_d <- p[(p_n+1):(p_n*2),]/(exp(p[(p_n*3+1):(p_n*4),])/15)

# predictions for every iteration for every data point
px <- data.frame(two_hosts2,
                 rg_int_pred = p[1:p_n,],
                 rg_def_pred = p[(p_n+1):(p_n*2),],
                 dd_int_pred = p[(p_n*2+1):(p_n*3),],
                 dd_def_pred = p[(p_n*3+1):(p_n*4),],
                 fs_def_pred = p[(p_n*4+1):(p_n*5),],
                 ag_def_pred = p[(p_n*5+1):(p_n*6),],
                 rgr_int_pred = rgr_i,
                 rgr_def_pred = rgr_d,
                 rg_int_res = two_hosts2$rg_int_host - p[1:p_n,],
                 rg_def_res = two_hosts2$rg_def_host - p[(p_n+1):(p_n*2),],
                 dd_int_res = two_hosts2$dd_int_host - p[(p_n*2+1):(p_n*3),],
                 dd_def_res = two_hosts2$dd_def_host - p[(p_n*3+1):(p_n*4),],
                 fs_def_res = two_hosts2$fs_def_host - p[(p_n*4+1):(p_n*5),],
                 ag_def_res = two_hosts2$ag_def_host - p[(p_n*5+1):(p_n*6),],
                 rgr_int_res = two_hosts2$rgr_int_host - rgr_i,
                 rgr_def_res = two_hosts2$rgr_def_host - rgr_d
                 )

# reshape predicted vals for all iter, calc fit and quantiles
p_all <- px%>%
  pivot_longer(
    cols = rg_int_pred.1:names(px)[length(px)],
    names_to = c("trait","iter"),
    names_sep = "\\.",
    values_to = "mod_pred"
  )%>%
  group_by(obs, pred, trait)%>%
  summarise(fit = median(mod_pred, na.rm = T),
            lwr = quantile(mod_pred, probs = 0.025, na.rm = T),
            upr = quantile(mod_pred, probs = 0.975, na.rm = T))

p <- p_all%>%
  pivot_wider(id = obs, names_from = trait, 
              names_glue = "{trait}.{.value}",
              values_from = fit:upr)
p <- left_join(two_hosts2, p, by="obs")

two_hosts_p <- p
two_hosts_p <- two_hosts_p%>%
  rename_with(.cols = ends_with("fit"), .fn = function(x){gsub(".fit", "", x)})
  
px <- select(px, obs, contains("_res")) # only keeps residuals, not preds

rm(pdx, n, nt, p_i, p_n, rgr_i, rgr_d)
# p <- p_all%>%
#   pivot_wider(id = obs, names_from = trait, values_from = fit:upr)
# 
# rm(px,pdx, n, nt, p_i, p_n, num_fe)
```


```{r}
fa <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_rg_ih == "yes", "zz", parasite_phylum)),
             aes(x = exp(int_host_mass), y = exp(rg_int_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes IH"),
              aes(fill = factor(endo_def),
                  x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                  ymin = exp(rg_int_pred.lwr), ymax = exp(rg_int_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes IH"),
            aes(color = factor(endo_def),
                x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                y = exp(rg_int_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Intermediate host mass (g)", y = "Larval growth\n(fold change in size)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
fb <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_dd_ih == "yes", "zz", parasite_phylum)),
             aes(x = exp(int_host_mass), y = exp(dd_int_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes IH"),
              aes(fill = factor(endo_def),
                  x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                  ymin = exp(dd_int_pred.lwr), ymax = exp(dd_int_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes IH"),
            aes(color = factor(endo_def),
                x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                y = exp(dd_int_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10() +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Intermediate host mass (g)", y = "Larval developmental time\n(degree days)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
fc <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_rg_dh == "yes", "zz", parasite_phylum)),
             aes(x = exp(int_host_mass), y = exp(rg_def_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes IH"),
              aes(fill = factor(endo_def),
                  x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                  ymin = exp(rg_def_pred.lwr), ymax = exp(rg_def_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes IH"),
            aes(color = factor(endo_def),
                x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                y = exp(rg_def_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Intermediate host mass (g)", y = "Adult growth\n(fold change in size)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
fd <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_dd_dh == "yes", "zz", parasite_phylum)),
             aes(x = exp(int_host_mass), y = exp(dd_def_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes IH"),
              aes(fill = factor(endo_def),
                  x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                  ymin = exp(dd_def_pred.lwr), ymax = exp(dd_def_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes IH"),
            aes(color = factor(endo_def),
                x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                y = exp(dd_def_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10() +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Intermediate host mass (g)", y = "Adult developmental time\n(degree days)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
fe <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_fs == "yes", "zz", parasite_phylum)),
             aes(x = exp(int_host_mass), y = exp(fs_def_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes IH"),
              aes(fill = factor(endo_def),
                  x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                  ymin = exp(fs_def_pred.lwr), ymax = exp(fs_def_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes IH"),
            aes(color = factor(endo_def),
                x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                y = exp(fs_def_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Intermediate host mass (g)", y = bquote("Size at maturity "(~mm^3))) +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
ff <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_ag == "yes", "zz", parasite_phylum)),
             aes(x = exp(int_host_mass), y = exp(ag_def_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes IH"),
              aes(fill = factor(endo_def),
                  x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                  ymin = exp(ag_def_pred.lwr), ymax = exp(ag_def_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes IH"),
            aes(color = factor(endo_def),
                x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                y = exp(ag_def_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10() +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Intermediate host mass (g)", y = "Age at maturity\n(degree days)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
```

Larval worms grow more and develop longer when the intermediate host is large, but less when the definitive host is an endotherm (a and b). Large intermediate hosts are also associated with less adult growth, but not a small size or age at maturity. This suggests that more growth in the intermediate host reduces the amount of growth needed to reach an optimal size for reproduction.

```{r}
f3 <- cowplot::plot_grid(fa + theme(axis.text.x = element_blank(),
                              axis.title.x = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points")),
                   fb + theme(axis.text.x = element_blank(),
                              axis.title.x = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points")),
                   fc + theme(axis.text.x = element_blank(),
                              axis.title.x = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points"),
                              strip.background = element_blank(),
                              strip.text.x = element_blank()),
                   fd + theme(axis.text.x = element_blank(),
                              axis.title.x = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points"),
                              strip.background = element_blank(),
                              strip.text.x = element_blank()),
                   fe + theme(strip.background = element_blank(),
                              strip.text.x = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points")),
                   ff + theme(strip.background = element_blank(),
                              strip.text.x = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points")),
                   labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)"), 
                   align = "hv", nrow = 3)
f3
ggsave(f3, filename = "../../figs/fig3_imp.png", width = 9, height = 8)
ggsave(f3, filename = "../../figs/fig3_imp.svg", width = 9, height = 8)
```


What about the effect of the adult environment?

```{r}
fa <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_rg_ih == "yes", "zz", parasite_phylum)),
             aes(x = exp(def_host_mass), y = exp(rg_int_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes DH"),
              aes(fill = factor(endo_def),
                  x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                  ymin = exp(rg_int_pred.lwr), ymax = exp(rg_int_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes DH"),
            aes(color = factor(endo_def),
                x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                y = exp(rg_int_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Definitive host mass (g)", y = "Larval growth\n(fold change in size)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
fb <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_dd_ih == "yes", "zz", parasite_phylum)),
             aes(x = exp(def_host_mass), y = exp(dd_int_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes DH"),
              aes(fill = factor(endo_def),
                  x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                  ymin = exp(dd_int_pred.lwr), ymax = exp(dd_int_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes DH"),
            aes(color = factor(endo_def),
                x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                y = exp(dd_int_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10() +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Definitive host mass (g)", y = "Larval developmental time\n(degree days)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
fc <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_rg_dh == "yes", "zz", parasite_phylum)),
             aes(x = exp(def_host_mass), y = exp(rg_def_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes DH"),
              aes(fill = factor(endo_def),
                  x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                  ymin = exp(rg_def_pred.lwr), ymax = exp(rg_def_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes DH"),
            aes(color = factor(endo_def),
                x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                y = exp(rg_def_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Definitive host mass (g)", y = "Adult growth\n(fold change in size)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
fd <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_dd_dh == "yes", "zz", parasite_phylum)),
             aes(x = exp(def_host_mass), y = exp(dd_def_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes DH"),
              aes(fill = factor(endo_def),
                  x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                  ymin = exp(dd_def_pred.lwr), ymax = exp(dd_def_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes DH"),
            aes(color = factor(endo_def),
                x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                y = exp(dd_def_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10() +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Definitive host mass (g)", y = "Adult developmental time\n(degree days)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
fe <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_fs == "yes", "zz", parasite_phylum)),
             aes(x = exp(def_host_mass), y = exp(fs_def_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes DH"),
              aes(fill = factor(endo_def),
                  x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                  ymin = exp(fs_def_pred.lwr), ymax = exp(fs_def_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes DH"),
            aes(color = factor(endo_def),
                x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                y = exp(fs_def_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Definitive host mass (g)", y = bquote("Size at maturity "(~mm^3))) +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
ff <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m = if_else(missing_ag == "yes", "zz", parasite_phylum)),
             aes(x = exp(def_host_mass), y = exp(ag_def_host), color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes DH"),
              aes(fill = factor(endo_def),
                  x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                  ymin = exp(ag_def_pred.lwr), ymax = exp(ag_def_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes DH"),
            aes(color = factor(endo_def),
                x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                y = exp(ag_def_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_y_log10() +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, x = "Definitive host mass (g)", y = "Age at maturity\n(degree days)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
```

Larval growth is unrelated to definitive host size (a and b). Adult growth is also only weakly related to definitive host size, though it tends to be greater in an endotherm.

```{r}
f4 <- cowplot::plot_grid(fa + theme(axis.text.x = element_blank(),
                              axis.title.x = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points")),
                   fb + theme(axis.text.x = element_blank(),
                              axis.title.x = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points")),
                   fc + theme(axis.text.x = element_blank(),
                              axis.title.x = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points"),
                              strip.background = element_blank(),
                              strip.text.x = element_blank()),
                   fd + theme(axis.text.x = element_blank(),
                              axis.title.x = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points"),
                              strip.background = element_blank(),
                              strip.text.x = element_blank()),
                   fe + theme(strip.background = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points"),
                              strip.text.x = element_blank()),
                   ff + theme(strip.background = element_blank(),
                              plot.margin = unit(c(0,5.5,0,5.5), "points"),
                              strip.text.x = element_blank()),
                   labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)"), 
                   align = "hv", nrow = 3)
f4
ggsave(f4, filename = "../../figs/fig4_imp.png", width = 9, height = 8)
ggsave(f4, filename = "../../figs/fig4_imp.svg", width = 9, height = 8)
```

Look at growth rates as function of host traits.

```{r}
fg <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m =
                        if_else(missing_rg_ih == "yes"|missing_dd_ih == "yes",
                                "zz", parasite_phylum)),
                      aes(x = exp(int_host_mass), y = rgr_int_host, color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes IH"),
              aes(fill = factor(endo_def),
                  x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                  ymin = (rgr_int_pred.lwr), ymax = (rgr_int_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes IH"),
            aes(color = factor(endo_def),
                x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                y = (rgr_int_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  # scale_y_log10() +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, 
       x = "Intermediate host mass (g)", 
       y = "Larval growth rate\n(~% increase per day at 20C)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
fh <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m =
                        if_else(missing_rg_dh == "yes"|missing_dd_dh == "yes",
                                "zz", parasite_phylum)),
             aes(x = exp(int_host_mass), y = rgr_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes IH"),
              aes(fill = factor(endo_def),
                  x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                  ymin = (rgr_def_pred.lwr), ymax = (rgr_def_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes IH"),
            aes(color = factor(endo_def),
                x = exp(int_host_mass_c + mean(two_hosts$int_host_mass)),
                y = (rgr_def_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  # scale_y_log10() +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, 
       x = "Intermediate host mass (g)", 
       y = "Adult growth rate\n(~% increase per day at 20C)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
```


```{r}
fg2 <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m =
                        if_else(missing_rg_ih == "yes"|missing_dd_ih == "yes",
                                "zz", parasite_phylum)),
              aes(x = exp(def_host_mass), y = rgr_int_host, color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes DH"),
              aes(fill = factor(endo_def),
                  x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                  ymin = (rgr_int_pred.lwr), ymax = (rgr_int_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes DH"),
            aes(color = factor(endo_def),
                x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                y = (rgr_int_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  # scale_y_log10() +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, 
       x = "Definitive host mass (g)", 
       y = "Larval growth rate\n(~% increase per day at 20C)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())

fh2 <- ggplot(two_hosts%>%
               mutate(parasite_phylum_m =
                        if_else(missing_rg_dh == "yes"|missing_dd_dh == "yes",
                                "zz", parasite_phylum)),
              aes(x = exp(def_host_mass), y = rgr_def_host, color = factor(endo_def))) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.4) +
  geom_ribbon(data = filter(p, pred == "yes DH"),
              aes(fill = factor(endo_def),
                  x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                  ymin = (rgr_def_pred.lwr), ymax = (rgr_def_pred.upr)),
              color = NA,
              alpha = 0.2) +
  geom_line(data = filter(p, pred == "yes DH"),
            aes(color = factor(endo_def),
                x = exp(def_host_mass_c + mean(two_hosts$def_host_mass)),
                y = (rgr_def_pred.fit)),
            linetype = "dashed") +
  guides(color = F, fill = F, shape = F) +
  scale_color_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  scale_fill_brewer(palette = "Set1", direction = -1, labels = c("Ecto next host", "Endo next host")) +
  # scale_y_log10() +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(color = NULL, 
       x = "Definitive host mass (g)", 
       y = "Adult growth rate\n(~% increase per day at 20C)") +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank())
```

Neither adult or larval growth depended much on host mass or endothermy.
```{r}
fs <- cowplot::plot_grid(fg + theme(axis.text.x = element_blank(),
                              axis.title.x = element_blank(),
                              plot.margin = unit(c(0, 0, 0, 0), "points")) + 
                     scale_y_continuous(expand = c(0,0),
                                        limits = c(
                       min(c(p$rgr_int_host, filter(p, pred == "yes IH")$rgr_int_pred.lwr), na.rm=T),
                       max(c(p$rgr_int_host, filter(p, pred == "yes IH")$rgr_int_pred.upr), na.rm=T)
                       )
                       ),
                   fg2 + theme(axis.text.x = element_blank(),
                              axis.title.x = element_blank(),
                              axis.text.y = element_blank(),
                              axis.title.y = element_blank(),
                              plot.margin = unit(c(0, 0, 0, 0), "points")) +
                     scale_y_continuous(expand = c(0,0), 
                                        limits = c(
                       min(c(p$rgr_int_host, filter(p, pred == "yes IH")$rgr_int_pred.lwr), na.rm=T),
                       max(c(p$rgr_int_host, filter(p, pred == "yes IH")$rgr_int_pred.upr), na.rm=T)
                       )
                       ),
                   fh + theme(plot.margin = unit(c(0, 0, 0, 0), "points"),
                              strip.text = element_blank(),
                              strip.background = element_blank()) +
                     scale_y_continuous(expand = c(0,0), 
                                        limits = c(
                       min(c(p$rgr_def_host, filter(p, pred == "yes DH")$rgr_def_pred.lwr), na.rm=T),
                       max(c(p$rgr_def_host, filter(p, pred == "yes DH")$rgr_def_pred.upr), na.rm=T)
                       )
                       ),
                   fh2 + theme(axis.title.y = element_blank(),
                               axis.text.y = element_blank(),
                               plot.margin = unit(c(0, 0, 0, 0), "points"),
                               strip.text = element_blank(),
                               strip.background = element_blank()) +
                     scale_y_continuous(expand = c(0,0), 
                                        limits = c(
                       min(c(p$rgr_def_host, filter(p, pred == "yes DH")$rgr_def_pred.lwr), na.rm=T),
                       max(c(p$rgr_def_host, filter(p, pred == "yes DH")$rgr_def_pred.upr), na.rm=T)
                       )
                       ),
                   nrow=2, ncol = 2,
                   labels = c("(a)","(b)","(c)","(d)"),
                   align = "hv")
fs
ggsave(fs, filename = "../../figs/figB2_imp.png", width = 9, height = 5)
ggsave(fs, filename = "../../figs/figB2_imp.svg", width = 9, height = 5)
rm(fs)
```
Here is the average larval growth rate for a worm infecting typically sized hosts.

```{r}
filter(p, pred == "yes DH")%>%
  group_by(endo_def)%>%
  mutate(diff_from_wanted = abs(def_host_mass_c - 0))%>%
  arrange(diff_from_wanted)%>%
  slice(1)%>%
  select(int_host_mass_c, def_host_mass_c, endo_def,
         rgr_int_pred.lwr, rgr_int_pred.fit, rgr_int_pred.upr)
```

Here is the average adult growth rate. It is very similar to the larval growth rate.

```{r}
filter(p, pred == "yes DH")%>%
  group_by(endo_def)%>%
  mutate(diff_from_wanted = abs(def_host_mass_c - 0))%>%
  arrange(diff_from_wanted)%>%
  slice(1)%>%
  select(int_host_mass_c, def_host_mass_c, endo_def,
         rgr_def_pred.lwr, rgr_def_pred.fit, rgr_def_pred.upr)
```



## Model effect sizes

These results suggest that life history is determined by both intermediate and definitive hosts, whereas adult strategies are determined by just the definitive host. 

Here's the R^2^ for these models.

```{r}
# function to return R2 from models
r2_multiv <- function(m){

  sol <- runjags::combine.mcmc(mcmc.list(lapply(m, function(x) {x$Sol}))) # fix param
  vcv <- runjags::combine.mcmc(mcmc.list(lapply(m, function(x) {x$VCV}))) # vc
  X <- m[[1]]$X # design matrix
  num_fe <- m[[1]]$Fixed$nfl # fixed effects
  l <- dim(X)[1]/6 # number of data points in model

  # calculate fixed effects var
  p_all <- as.matrix(X) %*% t(sol[,1:num_fe]) # predicteds for every post sample
  p1 <- p_all[1:l,] # preds for larval growth
  p2 <- p_all[(l+1):(l*2),] # preds for adult growth
  p3 <- p_all[(l*2 + 1):(l*3),] # preds for larval dd
  p4 <- p_all[(l*3 + 1):(l*4),] # preds for adult dd
  p5 <- p_all[(l*4 + 1):(l*5),] # preds for adult size
  p6 <- p_all[(l*5 + 1):(l*6),] # preds for adult age
  
  f1 <- apply(p1, MARGIN = 2, FUN = var)
  f2 <- apply(p2, MARGIN = 2, FUN = var)
  f3 <- apply(p3, MARGIN = 2, FUN = var)
  f4 <- apply(p4, MARGIN = 2, FUN = var)
  f5 <- apply(p5, MARGIN = 2, FUN = var)
  f6 <- apply(p6, MARGIN = 2, FUN = var)

  # random effects var
  resi <- which(grepl(colnames(vcv), pattern = '.units')) # remove resid variance from variance components
  randVar <- vcv[,-resi]
  ran1 <- randVar[, grepl(colnames(randVar), pattern = 'traitrg_int_host.')] # RE for larval size
  ran1 <- rowSums(ran1)
  ran2 <- randVar[, grepl(colnames(randVar), pattern = 'traitrg_def_host.')] # RE for adult size
  ran2 <- rowSums(ran2)
  ran3 <- randVar[, grepl(colnames(randVar), pattern = 'traitdd_int_host.')] # RE for larval devo time
  ran3 <- rowSums(ran3)
  ran4 <- randVar[, grepl(colnames(randVar), pattern = 'traitdd_def_host.')] # RE for adult devo time
  ran4 <- rowSums(ran4)
  ran5 <- randVar[, grepl(colnames(randVar), pattern = 'traitfs_def_host.')] # RE for adult size
  ran5 <- rowSums(ran5)
  ran6 <- randVar[, grepl(colnames(randVar), pattern = 'traitag_def_host.')] # RE for adult age
  ran6 <- rowSums(ran6)
  
  # resid var
  res1 <- vcv[, "traitrg_int_host:traitrg_int_host.units"]
  res2 <- vcv[, "traitrg_def_host:traitrg_def_host.units"]
  res3 <- vcv[, "traitdd_int_host:traitdd_int_host.units"]
  res4 <- vcv[, "traitdd_def_host:traitdd_def_host.units"]
  res5 <- vcv[, "traitfs_def_host:traitfs_def_host.units"]
  res6 <- vcv[, "traitag_def_host:traitag_def_host.units"]
  
  # calculate R2 marginal
  r2m1 <- f1/(f1 + ran1 + res1)
  r2m2 <- f2/(f2 + ran2 + res2)
  r2m3 <- f3/(f3 + ran3 + res3)
  r2m4 <- f4/(f4 + ran4 + res4)
  r2m5 <- f5/(f5 + ran5 + res5)
  r2m6 <- f6/(f6 + ran6 + res6)
  # for output...
  r2m1 <- paste0(round(median(r2m1),3), ' [', 
         round(quantile(r2m1, probs = 0.025), 3), '-', 
         round(quantile(r2m1, probs = 0.975), 3), ']')
  r2m2 <- paste0(round(median(r2m2),3), ' [', 
         round(quantile(r2m2, probs = 0.025), 3), '-', 
         round(quantile(r2m2, probs = 0.975), 3), ']')
  r2m3 <- paste0(round(median(r2m3),3), ' [', 
         round(quantile(r2m3, probs = 0.025), 3), '-', 
         round(quantile(r2m3, probs = 0.975), 3), ']')
  r2m4 <- paste0(round(median(r2m4),3), ' [', 
         round(quantile(r2m4, probs = 0.025), 3), '-', 
         round(quantile(r2m4, probs = 0.975), 3), ']')
  r2m5 <- paste0(round(median(r2m5),3), ' [', 
         round(quantile(r2m5, probs = 0.025), 3), '-', 
         round(quantile(r2m5, probs = 0.975), 3), ']')
  r2m6 <- paste0(round(median(r2m6),3), ' [', 
         round(quantile(r2m6, probs = 0.025), 3), '-', 
         round(quantile(r2m6, probs = 0.975), 3), ']')
  
  # calculate R2 conditional
  r2c1 <- (f1 + ran1)/(f1 + ran1 + res1)
  r2c2 <- (f2 + ran2)/(f2 + ran2 + res2)
  r2c3 <- (f3 + ran3)/(f3 + ran3 + res3)
  r2c4 <- (f4 + ran4)/(f4 + ran4 + res4)
  r2c5 <- (f5 + ran5)/(f5 + ran5 + res5)
  r2c6 <- (f6 + ran6)/(f6 + ran6 + res6)
  r2c1 <- paste0(round(median(r2c1),3), ' [', 
         round(quantile(r2c1, probs = 0.025), 3), '-', 
         round(quantile(r2c1, probs = 0.975), 3), ']')
  r2c2 <- paste0(round(median(r2c2),3), ' [', 
         round(quantile(r2c2, probs = 0.025), 3), '-', 
         round(quantile(r2c2, probs = 0.975), 3), ']')
  r2c3 <- paste0(round(median(r2c3),3), ' [', 
         round(quantile(r2c3, probs = 0.025), 3), '-', 
         round(quantile(r2c3, probs = 0.975), 3), ']')
  r2c4 <- paste0(round(median(r2c4),3), ' [', 
         round(quantile(r2c4, probs = 0.025), 3), '-', 
         round(quantile(r2c4, probs = 0.975), 3), ']')
  r2c5 <- paste0(round(median(r2c5),3), ' [', 
         round(quantile(r2c5, probs = 0.025), 3), '-', 
         round(quantile(r2c5, probs = 0.975), 3), ']')
  r2c6 <- paste0(round(median(r2c6),3), ' [', 
         round(quantile(r2c6, probs = 0.025), 3), '-', 
         round(quantile(r2c6, probs = 0.975), 3), ']')
  

  out_d <- data.frame(trait = c('larval_growth', 'adult_growth', 'larval_dt', 'adult_dt', "adult_size", "adult_age"),
                      r2m = c(r2m1, r2m2, r2m3, r2m4, r2m5, r2m6),
                      r2c = c(r2c1, r2c2, r2c3, r2c4, r2c5, r2c6))
  return(out_d)
}
```

```{r}
m1 <- r2_multiv(chains1t)
m2 <- r2_multiv(chains2t)
m3 <- r2_multiv(chains3t)
m4 <- r2_multiv(chains4t)

m1$model <- 'int-only'
m2$model <- 'host traits, main effects'
m3$model <- 'host traits, second-order interactions'
m4$model <- 'host traits x parasite group'

r2_table <- bind_rows(m1, m2, m3, m4)%>%
  arrange(trait)%>%
  select(trait, model, r2m, r2c)
# r2_table
rm(m1, m2, m3, m4)
```

The host trait interactions explain variation in larval growth, as does the parasite group by host traits interaction. However, adding parasite group mostly shifted explanatory power from the random to the fixed effects (i.e. overall conditional R2 did not change much).

```{r}
filter(r2_table, trait == "larval_growth")
```
The pattern for larval development was similar.

```{r}
filter(r2_table, trait == "larval_dt")
```
The model explained less variation in adult growth.

```{r}
filter(r2_table, trait == "adult_growth")
```

Adult developmental times seem to be specific to parasite groups.

```{r}
filter(r2_table, trait == "adult_dt")
```

Variation in adult size was mostly taxonomic.

```{r}
filter(r2_table, trait == "adult_size")
```

As was age at maturity.

```{r}
filter(r2_table, trait == "adult_age")
```

For all traits, taxonomy is very important. For comparison, we can also look at the models without taxonomy. The marginal R^2^ values are higher, particularly for larval traits, which suggests that some of the explanatory power of e.g. host mass is confounded with worm taxonomy. Even so, much of the variation in parasite life history is explained better by worm taxonomy than by host traits.

```{r}
m1 <- r2_multiv(chains1)
m2 <- r2_multiv(chains2)
m3 <- r2_multiv(chains3)
m4 <- r2_multiv(chains4)

m1$model <- 'int-only'
m2$model <- 'host traits, main effects'
m3$model <- 'host traits, second-order interactions'
m4$model <- 'host traits x parasite group'

r2_table2 <- bind_rows(m1, m2, m3, m4)%>%
  arrange(trait)%>%
  select(trait, model, r2m, r2c)
select(r2_table2, -r2c)
rm(m1, m2, m3, m4)
```

Below, we partition trait variance by taxonomic level to determine where in the taxonomic hierarchy parasite differ most.

# Trait covariation

Trait covariation can be assessed before or after accounting for the fixed effects documented above (i.e. with or without correcting for host mass and endothermy). It can also be affected by including parasite taxonomy and taxonomic covariance in the model, i.e. taxonomy may drive covariance. Therefore, let's examine how trait covariance estimates depended on model structure. We examine five models: 1) without fixed effects or taxonomy (species-level), 2) with fixed effects but not taxonomy, 3) with taxonomy but not fixed effects, 4) with taxonomy and fixed effects, and 5) with fixed effects and taxonomic covariance. For each of these models, we extract the residual covariance between traits and convert it to a correlation coefficient.

```{r}
prior_tax_ord <- list(R = list(R1 = list(V = diag(6), n = 1)),
                  G = list(
                    G1 = list(V = diag(6)/4, n = 2),
                    G2 = list(V = diag(6)/4, n = 2)
                    ))
prior_tax_fam <- list(R = list(R1 = list(V = diag(6), n = 1)),
                  G = list(
                    G1 = list(V = diag(6)/4, n = 2),
                    G2 = list(V = diag(6)/4, n = 2),
                    G3 = list(V = diag(6)/4, n = 2)
                    ))
startc_ord <- list(G = list(G1 = diag(6)/2,
                            G2 = diag(6)/2
                            ),
              R = diag(6)/2
              )
startc_fam <- list(G = list(G1 = diag(6)/3,
                            G2 = diag(6)/3,
                            G3 = diag(6)/3
                            ),
              R = diag(6)/3
              )
```
```{r}
chains4t.1 <- list()
chains4t_ord <- list()
chains4t_fam <- list()
nit <- 1500

for(i in 1:100){

  iname <- ifelse(i < 10, paste0('00',i), 
                  ifelse(i < 100, paste0('0',i),i))
  fname_p <- paste0('../../data/imputed_stage_level_tables/stage_level_imputed',iname,'.csv')
  dat_imp <- read.csv(file = fname_p, header = T)
  
  two_hosts_imp <- wrangle_data(dat_imp)
  two_hosts_imp2 <- bind_rows(two_hosts, nd_ih, nd_dh)
  two_hosts_imp2 <- two_hosts_imp2%>%
    mutate(obs = 1:length(Parasite.species))
  
  chains4t.1[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                  trait-1 +
                  trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c + 
                  trait:int_host_mass_c:def_host_mass_c +
                  trait:int_host_mass_c:endo_def_c +
                  trait:def_host_mass_c:endo_def_c +
                  trait:parasite_phylum + 
                  trait:parasite_phylum:int_host_mass_c + trait:parasite_phylum:def_host_mass_c +
                  trait:parasite_phylum:endo_def_c, 
                random = ~
                  us(trait):parasite_genus +
                  us(trait):parasite_family +
                  us(trait):parasite_order +
                  idh(trait):parasite_class,
                rcov = ~us(trait):units, # residual var-covar unstructured
                nitt = nit, thin = 100, burnin = bi,
                prior = prior_tax2, start = startc2,
                data = as.data.frame(two_hosts_imp2),
                family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                pr=T, 
                verbose = F)
  chains4t_ord[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                  trait-1 +
                  trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c + 
                  trait:int_host_mass_c:def_host_mass_c +
                  trait:int_host_mass_c:endo_def_c +
                  trait:def_host_mass_c:endo_def_c +
                  trait:parasite_phylum + 
                  trait:parasite_phylum:int_host_mass_c + trait:parasite_phylum:def_host_mass_c +
                  trait:parasite_phylum:endo_def_c, 
                random = ~
                 us(trait):parasite_order +
                 idh(trait):parasite_class,
                rcov = ~us(trait):units, # residual var-covar unstructured
                nitt = nit, thin = 100, burnin = bi,
                prior = prior_tax_ord, start = startc_ord,
                data = as.data.frame(two_hosts_imp2),
                family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                pr=T, 
                verbose = F)

  chains4t_fam[[i]] <- MCMCglmm(cbind(rg_int_host, rg_def_host, dd_int_host, dd_def_host, fs_def_host, ag_def_host) ~
                  trait-1 +
                  trait:int_host_mass_c + trait:def_host_mass_c + trait:endo_def_c + 
                  trait:int_host_mass_c:def_host_mass_c +
                  trait:int_host_mass_c:endo_def_c +
                  trait:def_host_mass_c:endo_def_c +
                  trait:parasite_phylum + 
                  trait:parasite_phylum:int_host_mass_c + trait:parasite_phylum:def_host_mass_c +
                  trait:parasite_phylum:endo_def_c, 
                random = ~
                  us(trait):parasite_family +
                  us(trait):parasite_order +
                  idh(trait):parasite_class,
                rcov = ~us(trait):units, # residual var-covar unstructured
                nitt = nit, thin = 100, burnin = bi,
                prior = prior_tax_fam, start = startc_fam,
                data = as.data.frame(two_hosts_imp2),
                family = c("gaussian", "gaussian", "gaussian", "gaussian", "gaussian", "gaussian"),
                pr=T, 
                verbose = F)

  
  s <- round(runif(1, min = 1, max = dim(chains4t.1[[i]]$VCV)[1]),0) # picks ran iter
  
  
  startc2 <- list(G = list(
    G1 = matrix(round(
      chains4t.1[[i]]$VCV[s,grepl(pattern = ".parasite_genus$", colnames(chains4t.1[[i]]$VCV))], 6),
      nrow = 6, ncol = 6),
    G2 = matrix(round(
      chains4t.1[[i]]$VCV[s,grepl(pattern = ".parasite_family$", colnames(chains4t.1[[i]]$VCV))], 6),
      nrow = 6, ncol = 6),
    G3 = matrix(round(
      chains4t.1[[i]]$VCV[s,grepl(pattern = ".parasite_order$", colnames(chains4t.1[[i]]$VCV))], 6),
      nrow = 6, ncol = 6),
    G4 = diag(round(chains4t.1[[i]]$VCV[s,grepl(pattern = ".parasite_class$", colnames(chains4t.1[[i]]$VCV))],6))
    ),
    R = matrix(round(
      chains4t.1[[i]]$VCV[s,grepl(pattern = ".units$", colnames(chains4t.1[[i]]$VCV))],
      6),
      nrow = 6, ncol = 6)
    )
  
  startc_ord <- list(G = list(
    G1 = matrix(round(
      chains4t_ord[[i]]$VCV[s,grepl(pattern = ".parasite_order$", colnames(chains4t_ord[[i]]$VCV))], 6),
      nrow = 6, ncol = 6),
    G2 = diag(round(chains4t_ord[[i]]$VCV[s,grepl(pattern = ".parasite_class$",
                                                colnames(chains4t_ord[[i]]$VCV))],6))
    ),
    R = matrix(round(
      chains4t_ord[[i]]$VCV[s,grepl(pattern = ".units$", colnames(chains4t_ord[[i]]$VCV))],
      6),
      nrow = 6, ncol = 6)
    )
  
  startc_fam <- list(G = list(
    G1 = matrix(round(
      chains4t_fam[[i]]$VCV[s,grepl(pattern = ".parasite_family$", colnames(chains4t_fam[[i]]$VCV))], 6),
      nrow = 6, ncol = 6),
    G2 = matrix(round(
      chains4t_fam[[i]]$VCV[s,grepl(pattern = ".parasite_order$", colnames(chains4t_fam[[i]]$VCV))], 6),
      nrow = 6, ncol = 6),
    G3 = diag(round(chains4t_fam[[i]]$VCV[s,grepl(pattern = ".parasite_class$", colnames(chains4t_fam[[i]]$VCV))],6))
    ),
    R = matrix(round(
      chains4t_fam[[i]]$VCV[s,grepl(pattern = ".units$", colnames(chains4t_fam[[i]]$VCV))],
      6),
      nrow = 6, ncol = 6)
    )


  print(paste('taxonomic models, imputation', i, 'finished'))
}

```


```{r}
mod_comb_vcv1 <- runjags::combine.mcmc(mcmc.list(lapply(chains1, function(x) {x$VCV})))
mod_comb_vcv4 <- runjags::combine.mcmc(mcmc.list(lapply(chains4, function(x) {x$VCV})))
mod_comb_vcv1t <- runjags::combine.mcmc(mcmc.list(lapply(chains1t, function(x) {x$VCV})))
mod_comb_vcv4t <- runjags::combine.mcmc(mcmc.list(lapply(chains4t, function(x) {x$VCV})))
mod_comb_vcv4t.1 <- runjags::combine.mcmc(mcmc.list(lapply(chains4t.1, function(x) {x$VCV})))
mod_comb_vcv4t_ord <- runjags::combine.mcmc(mcmc.list(lapply(chains4t_ord, function(x) {x$VCV})))
mod_comb_vcv4t_fam <- runjags::combine.mcmc(mcmc.list(lapply(chains4t_fam, function(x) {x$VCV})))
```
```{r}
sx <- summary( round(posterior.cor(mod_comb_vcv1[,grepl(pattern = ".units", colnames(mod_comb_vcv1))]),3))
sx1 <- data.frame(model = "no_fixed_no_tax",
                  cov = posterior.mode(mod_comb_vcv1[,grepl(pattern = ".units", colnames(mod_comb_vcv1))]),
                  cor = colnames(mod_comb_vcv1[,grepl(pattern = ".units", colnames(mod_comb_vcv1))]),
                  cor.lwr = sx$quantiles[,1], 
                  cor.fit = sx$quantiles[,3],
                  cor.upr = sx$quantiles[,5])
sx <- summary( round(posterior.cor(mod_comb_vcv4[,grepl(pattern = ".units", colnames(mod_comb_vcv4))]),3))
sx2 <- data.frame(model = "fixed_no_tax",
                  cov = posterior.mode(mod_comb_vcv4[,grepl(pattern = ".units", colnames(mod_comb_vcv4))]),
                  cor = colnames(mod_comb_vcv4[,grepl(pattern = ".units", colnames(mod_comb_vcv4))]),
                  cor.lwr = sx$quantiles[,1], 
                  cor.fit = sx$quantiles[,3],
                  cor.upr = sx$quantiles[,5])
sx <- summary( round(posterior.cor(mod_comb_vcv1t[,grepl(pattern = ".units", colnames(mod_comb_vcv1t))]),3))
sx3 <- data.frame(model = "no_fixed_tax",
                  cov = posterior.mode(mod_comb_vcv1t[,grepl(pattern = ".units", colnames(mod_comb_vcv1t))]),
                  cor = colnames(mod_comb_vcv1t[,grepl(pattern = ".units", colnames(mod_comb_vcv1t))]),
                  cor.lwr = sx$quantiles[,1], 
                  cor.fit = sx$quantiles[,3],
                  cor.upr = sx$quantiles[,5])
sx <- summary( round(posterior.cor(mod_comb_vcv4t[,grepl(pattern = ".units", colnames(mod_comb_vcv4t))]),3))
sx4 <- data.frame(model = "fixed_tax",
                  cov = posterior.mode(mod_comb_vcv4t[,grepl(pattern = ".units", colnames(mod_comb_vcv4t))]),
                  cor = colnames(mod_comb_vcv4t[,grepl(pattern = ".units", colnames(mod_comb_vcv4t))]),
                  cor.lwr = sx$quantiles[,1], 
                  cor.fit = sx$quantiles[,3],
                  cor.upr = sx$quantiles[,5])
sx <- summary( round(posterior.cor(mod_comb_vcv4t.1[,grepl(pattern = ".units", colnames(mod_comb_vcv4t.1))]),3))
sx5 <- data.frame(model = "fixed_tax_cov",
                  cov = posterior.mode(mod_comb_vcv4t.1[,grepl(pattern = ".units", colnames(mod_comb_vcv4t.1))]),
                  cor = colnames(mod_comb_vcv4t.1[,grepl(pattern = ".units", colnames(mod_comb_vcv4t.1))]),
                  cor.lwr = sx$quantiles[,1], 
                  cor.fit = sx$quantiles[,3],
                  cor.upr = sx$quantiles[,5])

row.names(sx1) <- NULL
row.names(sx2) <- NULL
row.names(sx3) <- NULL
row.names(sx4) <- NULL
row.names(sx5) <- NULL

cors_long <- bind_rows(sx1, sx2, sx3, sx4, sx5)%>%
  filter(cor.fit != 1)

rename_cors <- data.frame(cor = c("traitrg_int_host:traitdd_int_host.units",
                                  "traitrg_int_host:traitrg_def_host.units",
                                  "traitrg_int_host:traitdd_def_host.units",
                                  "traitrg_int_host:traitfs_def_host.units",
                                  "traitrg_int_host:traitag_def_host.units",
                                  "traitdd_int_host:traitrg_def_host.units",
                                  "traitdd_int_host:traitdd_def_host.units",
                                  "traitdd_int_host:traitfs_def_host.units",
                                  "traitdd_int_host:traitag_def_host.units",
                                  "traitrg_def_host:traitdd_def_host.units",
                                  "traitrg_def_host:traitfs_def_host.units",
                                  "traitrg_def_host:traitag_def_host.units",
                                  "traitdd_def_host:traitfs_def_host.units",
                                  "traitdd_def_host:traitag_def_host.units",
                                  "traitfs_def_host:traitag_def_host.units"),
                          cor_name = c("RG IH - DT IH",
                                       "RG IH - RG DH",
                                       "RG IH - DT DH",
                                       "RG IH - SM",
                                       "RG IH - AM",
                                       "DT IH - RG DH",
                                       "DT IH - DT DH",
                                       "DT IH - SM",
                                       "DT IH - AM",
                                       "RG DH - DT DH",
                                       "RG DH - SM",
                                       "RG DH - AM",
                                       "DT DH - SM",
                                       "DT DH - AM",
                                       "SM - AM")
)

cors_long <- cors_long%>%
  left_join(., rename_cors)%>%
  filter(!is.na(cor_name))%>%
  mutate(taxonomy = if_else(model %in% c("no_fixed_tax", "fixed_tax"), "taxonomy",
                            if_else(model == "fixed_tax_cov", "taxonomic\ncovariance", "no taxonomy")),
         fixed = if_else(model %in% c("fixed_no_tax", "fixed_tax", "fixed_tax_cov"),
                         "fixed effects", "no fixed effects"),
         cor_name = fct_relevel(cor_name, c("RG IH - DT IH", "RG IH - RG DH", "RG IH - DT DH",
                                             "RG IH - SM", "RG IH - AM", "DT IH - RG DH",
                                             "DT IH - DT DH", "DT IH - SM", "DT IH - AM",
                                             "RG DH - DT DH", "RG DH - SM", "RG DH - AM", "DT DH - SM",
                                             "DT DH - AM", "SM - AM")))%>%
  mutate(taxonomy = fct_relevel(taxonomy, c("no taxonomy", "taxonomy", "taxonomic\ncovariance")))

cors_wide <- cors_long%>%
  pivot_wider(id_cols = cor_name, names_from = model, values_from = cor.lwr:cor.upr )
rm(sx, sx1, sx2, sx3, sx4, sx5, rename_cors)
```

Here are the correlations from the five models for the 15 trait combinations. Adding fixed effects to a non-taxonomic model (compare red points) sometimes shrank the correlation (6 cases), sometimes increased the correlation (4), or had no effect (5). Once taxonomy was included in the model, the correlations were not sensitive to the fixed effects (compare green points), presumably because the fixed effects like host mass were taxonomically structured. This is presumably also why adding taxonomy moved correlations in the same direction as adding fixed effects (compare red vs green points). In a few cases (~7), the correlations disappeared after we added taxonomic covariance (blue points), indicating that the species-level correlation is entirely explained by correlations at higher taxonomic levels.

```{r}
fs2 <- ggplot(cors_long%>%
         mutate(model = fct_relevel(model, c("no_fixed_no_tax", "fixed_no_tax",
                                             "no_fixed_tax", "fixed_tax", "fixed_tax_cov"))),
         # filter(!grepl(pattern = "SM", cor_name) & !grepl(pattern = "AM", cor_name)),
       aes(x = model, y = cor.fit, color = taxonomy, shape = fixed)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_pointrange(aes(ymin = cor.lwr, ymax = cor.upr)) +
  facet_wrap(~cor_name, scales = "free_y", nrow = 3) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_blank()) +
  labs(color = NULL, shape = NULL, x = "Model", y = "Correlation coefficient")
fs2
# ggsave(fs2, filename = "../../figs/figS2_imp.png", width = 10, height = 5)
```

Here is another way to visualize the differences. We focus on just the relationship between growth and development in intermediate hosts and we plot the marginal residuals (i.e. accounting for fixed effects but not taxonomy) from the taxonomic mixed model. The covariance matrix that fits best is the one estimated with fixed effects but without taxonomy. The covariance is too wide when estimated without fixed effects and too narrow when accounting for taxonomy.

```{r}
# function to calculate CI ellipse
ci_ellipse <- function(cm, meanx, meany){ # take in 2x2 cov matrix, return 95% CI ellipsoid
  
  eigVal  <- eigen(cm)$values
  eigVec  <- eigen(cm)$vectors
  eigScl  <- eigVec %*% diag(sqrt(eigVal))  # scale eigenvectors to length = square-root
  angles <- seq(0, 2*pi, length.out = 300)
  ellBase <- cbind(sqrt(eigVal[1])*cos(angles), sqrt(eigVal[2])*sin(angles)) # normal ellipse
  xcrs <- which(ellBase[,1] == max(ellBase[,1]) | ellBase[,1] == min(ellBase[,1])) # id major axis
  ycrs <- which(ellBase[,2] == max(ellBase[,2]) | ellBase[,2] == min(ellBase[,2])) # id minor axis
  ellRot  <- eigVec %*% t(ellBase) # rotated ellipse
  ellRot <- data.frame(t(ellRot))
  ellRot <- cbind(angles, ellRot)
  names(ellRot) <- c("angles", "x", "y")
  ellRot <- mutate(ellRot, x = x + meanx, y = y + meany)
  ellRot$axes[xcrs] <- "major"
  ellRot$axes[ycrs] <- "minor"
  
  return(ellRot) # dataframe for ellipse
}

# function to extract cov matrixes from post dist
post_cov_matrices_df <- function(mod1, trait1, trait2, cv_level1, num_ps){
  
  ps <- sample(1:length(mod1[,1]), size = num_ps) # random posterior samples
  
  # trait names for extracting cov matrix from post dist
  v1x <- paste0("trait",trait1,":","trait",trait1,cv_level1)
  v2x <- paste0("trait",trait2,":","trait",trait2,cv_level1)
  cv12x <- paste0("trait",trait1,":","trait",trait2,cv_level1)
  cv21x <- paste0("trait",trait2,":","trait",trait1,cv_level1)

  # loop around to take sample
  for(i in ps){
    ell_i <- ci_ellipse(
      cm = matrix(6 * (mod1[i, c(v1x, cv12x, cv21x, v2x)]), 2,2),
      meanx = 0, #mod1$Sol[i, paste0("trait",trait1)]
      meany = 0 #mod1$Sol[i, paste0("trait",trait2)]
  )
    ell_i$p_samp <- as.character(i)
    if(i == ps[1]){
      ell_many <- ell_i
    } else {
      ell_many <- bind_rows(ell_many, ell_i)
    }
  }
  
  return(ell_many)

}

post_cov_matrix_best <- function(mod1, trait1, trait2, cv_level1){
  
  # trait names for extracting cov matrix from post dist
  v1x <- paste0("trait",trait1,":","trait",trait1,cv_level1)
  v2x <- paste0("trait",trait2,":","trait",trait2,cv_level1)
  cv12x <- paste0("trait",trait1,":","trait",trait2,cv_level1)
  cv21x <- paste0("trait",trait2,":","trait",trait1,cv_level1)
  
  ell <- ci_ellipse(
      cm = matrix(6 * posterior.mode(mod1[, c(v1x, cv12x, cv21x, v2x)]), 2,2),
      meanx = 0, # mean at zero because of res
      meany = 0 # mean at zero because of res
  )

  return(ell)
}
```

```{r}
ell1 <- post_cov_matrices_df(mod_comb_vcv1, "dd_int_host", "rg_int_host", ".units", 10)
x <- c("traitrg_int_host:traitrg_int_host.units", "traitrg_int_host:traitdd_int_host.units", 
       "traitdd_int_host:traitrg_int_host.units", "traitdd_int_host:traitdd_int_host.units")
sx <- summary(posterior.cor(mod_comb_vcv1[,colnames(mod_comb_vcv1) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fa <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(missing_rg_ih == "yes", "zz", parasite_phylum)), 
       aes(x = dd_int_res, y = rg_int_res)) +
  geom_point(aes(shape = parasite_phylum_m)) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, p_samp, angles),
              aes(x = x, y = y, group = p_samp),
              alpha = 0.25, color = "black") +
  # geom_smooth(se = F, method = lm) +
  scale_color_distiller(palette = "Spectral") +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(x = "Residual larval development", y = "Residual larval growth", shape = NULL,
       title = "No fixed effects, no taxonomy") +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$dd_int_res, na.rm = T), 
           y = max(two_hosts_p$rg_int_res, na.rm = T), 
           color = "black", size = 3, hjust = "left")
ell1 <- post_cov_matrices_df(mod_comb_vcv4, "dd_int_host", "rg_int_host", ".units", 10)
x <- c("traitrg_int_host:traitrg_int_host.units", "traitrg_int_host:traitdd_int_host.units", 
       "traitdd_int_host:traitrg_int_host.units", "traitdd_int_host:traitdd_int_host.units")
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fb <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(missing_rg_ih == "yes", "zz", parasite_phylum)),  
       aes(x = dd_int_res, y = rg_int_res)) +
  geom_point(aes(shape = parasite_phylum_m)) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, p_samp, angles),
              aes(x = x, y = y, group = p_samp),
              alpha = 0.25, color = "black") +
  # geom_smooth(se = F, method = lm) +
  scale_color_distiller(palette = "Spectral") +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(x = "Residual larval development", y = "Residual larval growth", shape = NULL,
       title = "Fixed effects, no taxonomy") +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$dd_int_res, na.rm = T), 
           y = max(two_hosts_p$rg_int_res, na.rm = T), 
           color = "black", size = 3, hjust = "left")
ell1 <- post_cov_matrices_df(mod_comb_vcv1t, "dd_int_host", "rg_int_host", ".units", 10)
x <- c("traitrg_int_host:traitrg_int_host.units", "traitrg_int_host:traitdd_int_host.units", 
       "traitdd_int_host:traitrg_int_host.units", "traitdd_int_host:traitdd_int_host.units")
sx <- summary(posterior.cor(mod_comb_vcv1t[,colnames(mod_comb_vcv1t) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fc <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(missing_rg_ih == "yes", "zz", parasite_phylum)), 
       aes(x = dd_int_res, y = rg_int_res)) +
  geom_point(aes(shape = parasite_phylum_m)) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, p_samp, angles),
              aes(x = x, y = y, group = p_samp),
              alpha = 0.25, color = "black") +
  # geom_smooth(se = F, method = lm) +
  scale_color_distiller(palette = "Spectral") +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(x = "Residual larval development", y = "Residual larval growth", shape = NULL,
       title = "Taxonomy, no fixed effects") +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$dd_int_res, na.rm = T), 
           y = max(two_hosts_p$rg_int_res, na.rm = T), 
           color = "black", size = 3, hjust = "left")
ell1 <- post_cov_matrices_df(mod_comb_vcv4t, "dd_int_host", "rg_int_host", ".units", 10)
x <- c("traitrg_int_host:traitrg_int_host.units", "traitrg_int_host:traitdd_int_host.units", 
       "traitdd_int_host:traitrg_int_host.units", "traitdd_int_host:traitdd_int_host.units")
sx <- summary(posterior.cor(mod_comb_vcv4t[,colnames(mod_comb_vcv4t) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fd <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(missing_rg_ih == "yes", "zz", parasite_phylum)),  
       aes(x = dd_int_res, y = rg_int_res)) +
  geom_point(aes(shape = parasite_phylum_m)) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, p_samp, angles),
              aes(x = x, y = y, group = p_samp),
              alpha = 0.25, color = "black") +
  # geom_smooth(se = F, method = lm) +
  scale_color_distiller(palette = "Spectral") +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(x = "Residual larval development", y = "Residual larval growth", shape = NULL,
       title = "Taxonomy, fixed effects") +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$dd_int_res, na.rm = T), 
           y = max(two_hosts_p$rg_int_res, na.rm = T), 
           color = "black", size = 3, hjust = "left")

cowplot::plot_grid(fa, fb, fc, fd, nrow = 2)
```


Even though taxonomy and the fixed effects can alter trait correlations, the estimates were still rather similar. Here is the pearson correlation for the covariances with and without fixed effects (no taxonomy).

```{r}
cor.test(cors_wide$cor.fit_no_fixed_no_tax, cors_wide$cor.fit_fixed_no_tax)
```

With taxonomy, the correlation with and without fixed effects is much tighter.

```{r}
cor.test(cors_wide$cor.fit_no_fixed_tax, cors_wide$cor.fit_fixed_tax)
```

Here is the trend with fixed effects, but with and without taxonomy. It is quite high.

```{r}
cor.test(cors_wide$cor.fit_fixed_no_tax, cors_wide$cor.fit_fixed_tax)
```

It is lower, though, when we compare correlations without taxonomy and fixed effects to those with taxonomy and fixed effects. This indicates that taxonomy and fixed effects can shift correlations somewhat.

```{r}
cor.test(cors_wide$cor.fit_no_fixed_no_tax, cors_wide$cor.fit_fixed_tax)
```

We therefore proceed with residuals "correcting" for fixed effects but not taxonomy; taxonomic covariance is considered later. To visualize covariances, we calculate confidence ellipses. The width of the ellipses represent variance, whereas the tilt represents covariance.

Let's look at the correlations between size and age within growth periods, i.e. within intermediate hosts, within definitive hosts and over the whole life cycle. In each case, it is significantly positive, though some species grow faster than others (upper left quadrant). The colors code an index of performance (the average of the standardized residuals for size and inverse age).

```{r}
ell1 <- post_cov_matrices_df(mod_comb_vcv4, "dd_int_host", "rg_int_host", ".units", 10)
x <- c("traitrg_int_host:traitrg_int_host.units", "traitrg_int_host:traitdd_int_host.units", 
       "traitdd_int_host:traitrg_int_host.units", "traitdd_int_host:traitdd_int_host.units")
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fa <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_rg_ih == "yes" | missing_dd_ih == "yes", "zz", parasite_phylum)),
       aes(x = dd_int_res, y = rg_int_res)) +
  geom_point(aes(shape = parasite_phylum_m)) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, p_samp, angles),
              aes(x = x, y = y, group = p_samp),
              alpha = 0.25, color = "black") +
  # geom_smooth(se = F, method = lm) +
  scale_color_distiller(palette = "Spectral") +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(x = "Residual larval development", y = "Residual larval growth", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        ) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$dd_int_res, na.rm = T), 
           y = max(two_hosts_p$rg_int_res, na.rm = T), 
           color = "black", size = 3, hjust = "left")

ell1 <- post_cov_matrices_df(mod_comb_vcv4, "dd_def_host", "rg_def_host", ".units", 10)
x <- gsub(pattern = "_int_", replacement = "_def_", x)
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fb <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_rg_dh == "yes" | missing_dd_dh == "yes", "zz", parasite_phylum)), 
       aes(x = dd_def_res, y = rg_def_res)) +
  geom_point(aes(shape = parasite_phylum_m)) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, p_samp, angles),
              aes(x = x, y = y, group = p_samp),
              alpha = 0.25, color = "black") +
  scale_color_distiller(palette = "Spectral") +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(x = "Residual adult development", y = "Residual adult growth", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank()) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$dd_def_res, na.rm = T), 
           y = max(two_hosts_p$rg_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "left")
ell1 <- post_cov_matrices_df(mod_comb_vcv4, "ag_def_host", "fs_def_host", ".units", 10)
x <- gsub(pattern = "dd_def_", replacement = "ag_def_", x)
x <- gsub(pattern = "rg_def_", replacement = "fs_def_", x)
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fc <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_fs == "yes" | missing_ag == "yes", "zz", parasite_phylum)), 
       aes(x = ag_def_res, y = fs_def_res)) +
  geom_point(aes(shape = parasite_phylum_m)) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, p_samp, angles),
              aes(x = x, y = y, group = p_samp),
              alpha = 0.25, color = "black") +
  scale_color_distiller(palette = "Spectral") +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(x = "Residual age at maturity", y = "Residual size at maturity", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank()) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$ag_def_res, na.rm = T), 
           y = max(two_hosts_p$fs_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "left")
cowplot::plot_grid(fa, fb, fc, nrow = 1)
```









What about correlations across life stages? We consider 5 adult traits: adult growth, adult developmental time (prepatent period), adult growth rate, size at maturity, and age at maturity. We looked at how those traits were affected by larval strategies (larval growth, developmental time, and growth rate). These correlations are calculated after accounting for host traits and parasite group (i.e. with fixed effects removed). So these are worms that grow more/less, fast/slow, etc. relative to host size and parasite group. Note though that host traits had little impact on growth rate, so the residuals for larval growth rate are similar to observed rates.

```{r}
# function to get best cov matrix and cor CI from residuals of post dist
rgr_get_cov_cor <- function(trait1, trait2){
  rgr <- select(px, starts_with(trait1))
  rgr2 <- select(px, starts_with(trait2))

  for(i in 1:ncol(rgr)){
    i_use <- which(!is.na(rgr[,i]) & !is.na(rgr2[,i])) # where both variables non-missing
    n_rgr <- length(i_use) # n
    
    var1 <- sum(rgr[i_use,i]^2, na.rm=T)/(n_rgr - num_fe/6) # var in x
    var2 <- sum(rgr2[i_use,i]^2, na.rm=T)/(n_rgr - num_fe/6) # var in y
    
    cov_rgr <- sum(rgr[i_use,i] * rgr2[i_use,i], na.rm=T)/(n_rgr - num_fe/6)
    # cov_rgr.upr <- cov_rgr/qchisq(0.975, df= (n_rgr - num_fe/6) )
    # cov_rgr.lwr <- cov_rgr/qchisq(0.025, df= (n_rgr - num_fe/6) )
    cor_rgr <- cov_rgr/(sqrt(var1*var2))
    
    zrgr <- 0.5*log((1+cor_rgr)/(1-cor_rgr)) # calculate ci around cor coef with Fisher transformation
    zrgr.upr <- zrgr + 1.96*sqrt(1/(n_rgr-3)) 
    zrgr.lwr <- zrgr - 1.96*sqrt(1/(n_rgr-3))
    cor_rgr.lwr <- (exp(2*zrgr.lwr)-1)/(exp(2*zrgr.lwr)+1)
    cor_rgr.upr <- (exp(2*zrgr.upr)-1)/(exp(2*zrgr.upr)+1)
    
    if(i == 1){ # collate results across all iterations of posterior dist
      cov_rgr_out <- cov_rgr
      cor_rgr_out <- cor_rgr
      cor_rgr.lwr_out <- cor_rgr.lwr
      cor_rgr.upr_out <- cor_rgr.upr
    } else {
      cov_rgr_out <- c(cov_rgr_out, cov_rgr)
      cor_rgr_out <- c(cor_rgr_out, cor_rgr)
      cor_rgr.lwr_out <- c(cor_rgr.lwr_out, cor_rgr.lwr)
      cor_rgr.upr_out <- c(cor_rgr.upr_out, cor_rgr.upr)
    }
  }
  # best cov matrix
  cov_mat <- matrix(c(
    median(apply(rgr, MARGIN =2, function(x) {sum(x[i_use]^2, na.rm=T)/(n_rgr - num_fe/6)})),
    median(cov_rgr_out), median(cov_rgr_out),
    median(apply(rgr2, MARGIN =2, function(x) {sum(x[i_use]^2, na.rm=T)/(n_rgr - num_fe/6)}))
    ), 2,2)
  # correlation and CI
  cor_anno <- paste0(round(median(cor_rgr_out), 2),
                   " [", round(median(cor_rgr.lwr_out), 2),
                   " to ", round(median(cor_rgr.upr_out), 2),"]")
  
  return(list(cov_mat, cor_anno))
}
```

We start with adult growth. 

```{r}
std_xaxes <- two_hosts_p%>%
  filter(!is.na(fs_def_res))%>%
  summarize(across(c(rg_int_res, dd_int_res, rgr_int_res), list(min, max), na.rm = T))

std_yaxes <- two_hosts_p%>%
  summarize(across(c(rg_def_res, dd_def_res, rgr_def_res, fs_def_res, ag_def_res),
                   list(min, max), na.rm = T))
```

```{r}
ell1 <- post_cov_matrix_best(mod_comb_vcv4, "rg_int_host", "rg_def_host", ".units")
x <- c("traitrg_int_host:traitrg_int_host.units", "traitrg_int_host:traitrg_def_host.units", 
       "traitrg_def_host:traitrg_int_host.units", "traitrg_def_host:traitrg_def_host.units")
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
faa <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_rg_ih == "yes" | missing_rg_dh == "yes", 
                 "zz", parasite_phylum)),  
       aes(x = rg_int_res, y = rg_def_res)) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval growth", y = "Residual adult growth", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = max(two_hosts_p$rg_int_res, na.rm = T), 
           y = max(two_hosts_p$rg_def_res, na.rm = T),
           color = "black", size = 3, hjust = "right") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$rg_int_res_1, std_xaxes$rg_int_res_2),
                  ylim = c(std_yaxes$rg_def_res_1, std_yaxes$rg_def_res_2))

ell1 <- post_cov_matrix_best(mod_comb_vcv4, "dd_int_host", "rg_def_host", ".units")
x <- c("traitdd_int_host:traitdd_int_host.units", "traitrg_def_host:traitdd_int_host.units", 
       "traitdd_int_host:traitrg_def_host.units", "traitrg_def_host:traitrg_def_host.units")
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fab <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_dd_ih == "yes" | missing_rg_dh == "yes", 
                 "zz", parasite_phylum)),  
       aes(x = dd_int_res, y = rg_def_res)) +
  geom_point(aes(shape = parasite_phylum_m), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval development", y = "Residual adult growth", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = max(two_hosts_p$dd_int_res, na.rm = T), 
           y = max(two_hosts_p$rg_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "right") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$dd_int_res_1, std_xaxes$dd_int_res_2),
                  ylim = c(std_yaxes$rg_def_res_1, std_yaxes$rg_def_res_2))
fp <- rgr_get_cov_cor("rgr_int_res", "rg_def_res")
ell1 <- ci_ellipse(6*fp[[1]],0,0)
cor_anno <- fp[[2]]
std_xaxes$rgr_int_res_1 <- min(ell1$x)
fac <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 (missing_dd_ih == "yes" | missing_rg_ih == "yes") | 
                   (missing_rg_dh == "yes"), 
                 "zz", parasite_phylum)),   
       aes(x = rgr_int_res, y = rg_def_res)) +
  geom_point(aes(shape = parasite_phylum_m), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval growth rate", y = "Residual adult growth", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        ) +
  annotate("text", label = cor_anno, 
           x = max(two_hosts_p$rgr_int_res, na.rm = T), 
           y = max(two_hosts_p$rg_def_res, na.rm = T),
           color = "black", size = 3, hjust = "right") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$rgr_int_res_1, std_xaxes$rgr_int_res_2),
                  ylim = c(std_yaxes$rg_def_res_1, std_yaxes$rg_def_res_2))

```

We expected that worms that grow more in intermediate hosts should grow less in definitive hosts. This is clearly the case. Parasite species that grew more and faster as larvae grew less as adults. Long larval development did not affect adult growth. Slow larval growth was associated with more adult growth.

```{r}
fa <- cowplot::plot_grid(faa, fab, fac, nrow = 1, align = "hv")
fa
fa <- cowplot::plot_grid(faa + theme(axis.title.x = element_blank(),
                                     axis.text.x = element_blank()),
                         fab + theme(axis.title = element_blank(),
                                     axis.text = element_blank()),
                         fac + theme(axis.title = element_blank(),
                                     axis.text = element_blank()),
                         nrow = 1,
                         align = "hv")
```
Moving on to the next adult trait: prepatent period.

```{r}
ell1 <- post_cov_matrix_best(mod_comb_vcv4, "rg_int_host", "dd_def_host", ".units")
x <- c("traitrg_int_host:traitrg_int_host.units", "traitrg_int_host:traitdd_def_host.units", 
       "traitdd_def_host:traitrg_int_host.units", "traitdd_def_host:traitdd_def_host.units")
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
faa <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_rg_ih == "yes" | missing_dd_dh == "yes", 
                 "zz", parasite_phylum)),  
              aes(x = rg_int_res, y = dd_def_res)) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval growth", y = "Residual adult development", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        ) +
  annotate("text", label = cor_anno, 
           x = max(two_hosts_p$rg_int_res, na.rm = T), 
           y = max(two_hosts_p$dd_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "right")+
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$rg_int_res_1, std_xaxes$rg_int_res_2),
                  ylim = c(std_yaxes$dd_def_res_1, std_yaxes$dd_def_res_2))

ell1 <- post_cov_matrix_best(mod_comb_vcv4, "dd_int_host", "dd_def_host", ".units")
x <- gsub(pattern = "rg_int_", replacement = "dd_int_", x)
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fab <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_dd_ih == "yes" | missing_dd_dh == "yes", 
                 "zz", parasite_phylum)),  
              aes(x = dd_int_res, y = dd_def_res)) +
  geom_point(aes(shape = parasite_phylum_m), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval development", y = "Residual adult development", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$dd_int_res, na.rm = T), 
           y = max(two_hosts_p$dd_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "left") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$dd_int_res_1, std_xaxes$dd_int_res_2),
                  ylim = c(std_yaxes$dd_def_res_1, std_yaxes$dd_def_res_2))

fp <- rgr_get_cov_cor("rgr_int_res", "dd_def_res")
ell1 <- ci_ellipse(6*fp[[1]],0,0)
cor_anno <- fp[[2]]
fac <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 (missing_rg_ih == "yes" | missing_dd_ih == "yes") |
                   missing_dd_dh == "yes", 
                 "zz", parasite_phylum)),  
              aes(x = rgr_int_res, y = dd_def_res)) +
  geom_point(aes(shape = parasite_phylum_m), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval growth rate", y = "Residual adult development", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = max(two_hosts_p$rgr_int_res, na.rm = T), 
           y = max(two_hosts_p$dd_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "right") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$rgr_int_res_1, std_xaxes$rgr_int_res_2),
                  ylim = c(std_yaxes$dd_def_res_1, std_yaxes$dd_def_res_2))
```

Species that had slow larval growth and long larval development tended to have longer prepatent periods. By contrast, worms with fast larval growth tended to have slightly shorter prepatent periods.

```{r}
fb <- cowplot::plot_grid(faa, fab, fac, nrow = 1)
fb
fb <- cowplot::plot_grid(faa + theme(axis.title.x = element_blank(),
                                     axis.text.x = element_blank()),
                         fab + theme(axis.title = element_blank(),
                                     axis.text = element_blank()),
                         fac + theme(axis.title = element_blank(),
                                     axis.text = element_blank()),
                         nrow = 1,
                         align = "hv")
```

Since fast growing larvae exhibit shorter adult development and less adult growth, we would not expect adult growth rates to depend on larval traits. Let's check.

```{r}
fp <- rgr_get_cov_cor("rg_int_res", "rgr_def_res")
ell1 <- ci_ellipse(6*fp[[1]],0,0)
cor_anno <- fp[[2]]
std_yaxes$rgr_def_res_1 <- min(ell1$y)

faa <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_rg_ih == "yes" | 
                   (missing_rg_dh == "yes" | missing_dd_dh == "yes"), 
                 "zz", parasite_phylum)),   
       aes(x = rg_int_res, y = rgr_def_res)) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  # geom_smooth(se = F, method = lm) +
  scale_color_distiller(palette = "Spectral") +
  labs(x = "Residual larval growth", y = "Residual adult growth rate", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = max(two_hosts_p$rg_int_res, na.rm = T), 
           y = max(two_hosts_p$rgr_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "right") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$rg_int_res_1, std_xaxes$rg_int_res_2),
                  ylim = c(std_yaxes$rgr_def_res_1, std_yaxes$rgr_def_res_2))

fp <- rgr_get_cov_cor("dd_int_res", "rgr_def_res")
ell1 <- ci_ellipse(6*fp[[1]],0,0)
cor_anno <- fp[[2]]
fab <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_dd_ih == "yes" | 
                   (missing_rg_dh == "yes" | missing_dd_dh == "yes"), 
                 "zz", parasite_phylum)),   
              aes(x = dd_int_res, y = rgr_def_res)) +
  geom_point(aes(shape = parasite_phylum_m), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval development", y = "Residual adult growth rate", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = max(two_hosts_p$dd_int_res, na.rm = T), 
           y = max(two_hosts_p$rgr_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "right")+
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$dd_int_res_1, std_xaxes$dd_int_res_2),
                  ylim = c(std_yaxes$rgr_def_res_1, std_yaxes$rgr_def_res_2))

fp <- rgr_get_cov_cor("rgr_int_res", "rgr_def_res")
ell1 <- ci_ellipse(6*fp[[1]],0,0)
cor_anno <- fp[[2]]
fac <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 (missing_rg_ih == "yes" | missing_dd_ih == "yes")| 
                   (missing_rg_dh == "yes" | missing_dd_dh == "yes"), 
                 "zz", parasite_phylum)), 
              aes(x = rgr_int_res, y = rgr_def_res)) +
  geom_point(aes(shape = parasite_phylum_m), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval growth rate", y = "Residual adult growth rate", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = max(two_hosts_p$rgr_int_res, na.rm = T), 
           y = max(two_hosts_p$rgr_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "right") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$rgr_int_res_1, std_xaxes$rgr_int_res_2),
                  ylim = c(std_yaxes$rgr_def_res_1, std_yaxes$rgr_def_res_2))
```

Indeed, larval and adult growth rates were uncorrelated. However, worms that grew more and longer as larvae tended to grow slower as adults. However, this trend might be a bit spurious, since the 3 groups seem to separate out.

```{r}
fc <- cowplot::plot_grid(faa, fab, fac, nrow = 1)
fc
fc <- cowplot::plot_grid(faa + theme(axis.title.x = element_blank(),
                                     axis.text.x = element_blank()),
                         fab + theme(axis.title = element_blank(),
                                     axis.text = element_blank()),
                         fac + theme(axis.title = element_blank(),
                                     axis.text = element_blank()),
                         nrow = 1,
                         align = "hv")
```

Here is the same plot separated for each group. It is less clear that there is a consistent negative relationship. Also, cestodes and nematodes separate along the x-axis, suggesting that the model considers their growth relative to the host different. This is probably influenced by taxonomic effects, i.e. some points have more weight than others.

```{r}
ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_rg_ih == "yes" | 
                   (missing_rg_dh == "yes" | missing_dd_dh == "yes"), 
                 "zz", parasite_phylum)), 
       aes(x = rg_int_res, y = rgr_def_res)) +
  geom_point(aes(shape = parasite_phylum_m)) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  labs(x = "Residual larval growth", y = "Residual adult growth rate", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        ) +
  facet_wrap(~parasite_phylum) +
  geom_smooth(method = lm) +
  scale_shape_manual(values = c(16,17,15,4)) 
```

Here is the simple pearson correlation for acanths,
```{r}
with(filter(two_hosts_p, parasite_phylum == "Acanthocephala"), cor.test(rg_int_res, rgr_def_res))
```
cestodes, and...

```{r}
with(filter(two_hosts_p, parasite_phylum == "Cestoda"), cor.test(rg_int_res, rgr_def_res))
```
nematodes.

```{r}
with(filter(two_hosts_p, parasite_phylum == "Nematoda"), cor.test(rg_int_res, rgr_def_res))
```

One reason that adult growth rate may decrease with larval growth is that growth rates overall decrease with size/age. In other words, the biggest larvae are on the part of the curve where growth typically slows. Let's examine this.

```{r}
size_df <- two_hosts_p%>%
  filter(is.na(pred))%>%
  select(Parasite.species, parasite_phylum, egg_size, fs_int_host, fs_def_host)%>%
  mutate(eggies = egg_size, obs_int_size = fs_int_host)%>%
  pivot_longer(cols = egg_size:fs_def_host, names_to = "trait_size", values_to = "size")%>%
  mutate(stage = if_else(trait_size == "egg_size", "propagule", 
                         if_else(trait_size == "fs_int_host", "int_host", "def_host")))%>%
  mutate(spst = paste(Parasite.species, stage))

age_df <- two_hosts_p%>%
  filter(is.na(pred))%>%
  select(Parasite.species, parasite_phylum, dd_int_host, dd_def_host)%>%
  pivot_longer(cols = dd_int_host:dd_def_host, names_to = "trait_age", values_to = "dt")%>%
  mutate(stage = if_else(trait_age == "dd_int_host", "int_host", "def_host"))%>%
  mutate(spst = paste(Parasite.species, stage))
size_age_df <- left_join(size_df, age_df)
size_age_df <- size_age_df%>%
  mutate(dt = exp(dt)/15)%>%
  mutate(dt = if_else(stage == "propagule", 0, dt))%>%
  group_by(Parasite.species)%>%
  mutate(age = cumsum(dt))%>%
  ungroup()
size_age_df <- size_age_df%>%
  mutate(rg = size - eggies)%>%
  mutate(rgr = rg/age)
```
```{r}
size_age_df <- left_join(size_age_df, 
                          two_hosts_p%>%
                            filter(is.na(pred))%>%
                            select(Parasite.species, parasite_family,
                                   rg_int_host, rg_int_res, 
                                   dd_int_host, dd_int_res,
                                   rg_def_host, rg_def_res, 
                                   dd_def_host, dd_def_res, 
                                   fs_def_host, fs_def_res, 
                                   ag_def_host, ag_def_res, 
                                   rgr_int_host, rgr_int_res,
                                   rgr_def_host, rgr_def_res),
                          by = "Parasite.species")
```
```{r}
size_age_df_fams <- size_age_df%>%
              group_by(parasite_phylum, parasite_family, stage)%>%
              summarize(across(c(size, age, obs_int_size,
                                 rg_int_host, dd_int_host, rgr_def_host, dd_def_host,
                                 rg_int_res, dd_int_res), mean, na.rm = T),
                        n = n())%>%
  ungroup()
```

We fit growth curves (age vs size) separately for each helminth group.

```{r}
iPar <- list(Asym = max(size_age_df$size, na.rm=T), lrc = 0.02, R0 = min(size_age_df$size, na.rm=T))
tl_a <- nls(size ~ Asym - (Asym - R0) * exp(-lrc*age), # for this parameterization of VBLG, see here: https://derekogle.com/NCNRS349/modules/Growth/BKG
          start = iPar,
          data = filter(size_age_df, parasite_phylum == "Acanthocephala"))
tl_c <- nls(size ~ Asym - (Asym - R0) * exp(-lrc*age), # for this parameterization of VBLG, see here: https://derekogle.com/NCNRS349/modules/Growth/BKG
          start = iPar,
          data = filter(size_age_df, parasite_phylum == "Cestoda"))
tl_n <- nls(size ~ Asym - (Asym - R0) * exp(-lrc*age), # for this parameterization of VBLG, see here: https://derekogle.com/NCNRS349/modules/Growth/BKG
          start = iPar,
          data = filter(size_age_df, parasite_phylum == "Nematoda"))
```
```{r}
# also fit at family level
iPar <- list(Asym = max(size_age_df_fams$size, na.rm=T), lrc = 0.02, 
             R0 = min(size_age_df_fams$size, na.rm=T))
tl_a_fams <- nls(size ~ Asym - (Asym - R0) * exp(-lrc*age), # for this parameterization of VBLG, see here: https://derekogle.com/NCNRS349/modules/Growth/BKG
          start = iPar,
          data = filter(size_age_df_fams, parasite_phylum == "Acanthocephala"))
tl_c_fams <- nls(size ~ Asym - (Asym - R0) * exp(-lrc*age), # for this parameterization of VBLG, see here: https://derekogle.com/NCNRS349/modules/Growth/BKG
          start = iPar,
          data = filter(size_age_df_fams, parasite_phylum == "Cestoda"))
tl_n_fams <- nls(size ~ Asym - (Asym - R0) * exp(-lrc*age), # for this parameterization of VBLG, see here: https://derekogle.com/NCNRS349/modules/Growth/BKG
          start = iPar,
          data = filter(size_age_df_fams, parasite_phylum == "Nematoda"))
```

The curve is a better fit than a line, as the residual standard errors are lower for acanths...

```{r}
tl_lm_a <- lm(size ~ age, data = filter(size_age_df, parasite_phylum == "Acanthocephala"))
tl_lm_c <- lm(size ~ age, data = filter(size_age_df, parasite_phylum == "Cestoda"))
tl_lm_n <- lm(size ~ age, data = filter(size_age_df, parasite_phylum == "Nematoda"))
data.frame(line_res_se = summary(tl_lm_a)$sigma, curve_res_se = summary(tl_a)$sigma, 
           prop_dec = 
             (summary(tl_lm_a)$sigma - summary(tl_a)$sigma)/summary(tl_lm_a)$sigma)
```

...cestodes...
```{r}
data.frame(line_res_se = summary(tl_lm_c)$sigma, curve_res_se = summary(tl_c)$sigma,
           prop_dec = 
             (summary(tl_lm_c)$sigma - summary(tl_c)$sigma)/summary(tl_lm_c)$sigma)
```
...and nematodes.

```{r}
data.frame(line_res_se = summary(tl_lm_n)$sigma, curve_res_se = summary(tl_n)$sigma,
           prop_dec = 
             (summary(tl_lm_n)$sigma - summary(tl_n)$sigma)/summary(tl_lm_n)$sigma)
```

We confirm this by plotting the curves (dotted lines). They fit better than a straight line (red; this pure exponential growth given the log transformed y-axis). Growth clearly slows with size/age.

```{r}
x<-0:250
lg <- rbind(
  data.frame(x = x, 
             y = predict(tl_a, newdata = data.frame(age = x)), 
             eggies = predict(tl_a, newdata = data.frame(age = 0)),
             parasite_phylum = "Acanthocephala"),
  data.frame(x = x,
             y = predict(tl_c, newdata = data.frame(age = x)),
             eggies = predict(tl_c, newdata = data.frame(age = 0)),
             parasite_phylum = "Cestoda"),
  data.frame(x = x, 
             y = predict(tl_n, newdata = data.frame(age = x)),
             eggies = predict(tl_n, newdata = data.frame(age = 0)),
             parasite_phylum = "Nematoda")
  )
  
size_age_plot <- ggplot(size_age_df, aes(x = age, y = exp(size))) +
  geom_point(aes(shape = stage),
             alpha = 0.5) +
  # geom_smooth(method = lm, se = F, color = "red") +
  geom_line(data = lg, aes(x = x, y = exp(y)),
            linetype = "dashed", color = "black", size = 1.5) +
  coord_cartesian(xlim = c(0, 250), 
                  ylim = c(min(exp(size_age_df$size),na.rm=T),
                           max(exp(size_age_df$size),na.rm=T))
                  ) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(7, 1, 4), labels = c("Adult", "Larva", "Propagule")) +
  labs(x = "Age (days at 20 C)", y = "Body volume (mm3)", shape = NULL) +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.position = c(0.95,0.05),
        legend.justification = c(1,0))
size_age_plot
```

We can also reformulate the data to plot growth rate as a function of age. The dashed lines are from the fitted curves. Relative growth rate decreases with age. Moreover, this formulation shows us that growth rates vary more among young worms (i.e. when there is a low value for age in the denominator of the growth rate calculation). 

```{r}
ggplot(size_age_df, aes(x = age, y = rgr)) +
  geom_point(aes(shape = stage),
             alpha = 0.5) +
  geom_line(data = lg, aes(x = x, y = (y-eggies)/x),
            linetype = "dashed", color = "black", size = 1.5) +
  scale_shape_manual(values = c(7, 1, 4), labels = c("Adult", "Larva", "Propagule")) +
  coord_cartesian(xlim = c(0, 250)) +
  labs(x = "Age (days at 20 C)", y = "Relative growth rate") +
  facet_wrap(~parasite_phylum) 
```

We can make the same plot with size instead of age on the x-axis. Relative growth rate decreases in larger worms, though there is more variation when worms are small. 

```{r}
ggplot(size_age_df, aes(x = size, y = rgr)) +
  geom_point(aes(shape = stage),
             alpha = 0.5) +
  geom_line(data = lg, aes(x = y, y = (y-eggies)/x),
            linetype = "dashed", color = "black", size = 1.5) +
  scale_shape_manual(values = c(7, 1, 4), labels = c("Adult", "Larva", "Propagule")) +
  labs(x = "Ln(Body size)", y = "Relative growth rate") +
  facet_wrap(~parasite_phylum) 
```

Therefore, the worms that grow more and longer as larvae (i.e. are further to right on the last two plots) are expected to have lower adult growth rates. Here is an easier way to see that. The species are split by their larval style (i.e. if they grew more/longer than expected or less/shorter). Species that grew more/longer as larvae tended to have slower adult growth.

```{r}
size_age_df <- size_age_df%>%
  mutate(larv_perf = scale(((scale(rg_int_res) + scale(dd_int_res))/2)))%>%
  mutate(larv_per_bi = if_else(larv_perf > 0.5, "long", 
                               if_else(larv_perf < -0.5, "short", "avg")))
```

```{r}
ggplot(size_age_df, aes(x = age, y = size)) +
  geom_line(data = lg, aes(x = x, y = y),
            linetype = "dashed", color = "black", size = 1.5) +
  geom_point(data=filter(size_age_df, stage != "propagule"),
             aes(
               color = larv_per_bi
               ),
             alpha = 0.2
             ) +
  geom_line(data=filter(size_age_df, stage != "propagule"),
            aes(
              group = Parasite.species,
              color = larv_per_bi
              ),
            alpha = 0.5
            ) +
  coord_cartesian(xlim = c(0, 350)) +
  labs(x = "Age (days at 20 C)", y = "Ln(Body size)") +
  facet_grid(parasite_phylum~larv_per_bi) +
  theme(panel.grid.minor = element_blank()) +
  guides(color=F)
```

Decelerating growth is not obviously driven by single taxa. When we fit curves to family averages (red), they are quite comparable to the curves fit to species values (blue).

```{r}
x<-0:250
lg <- rbind(
  data.frame(x = x, 
             y = predict(tl_a, newdata = data.frame(age = x)), 
             parasite_phylum = "Acanthocephala"),
  data.frame(x = x,
             y = predict(tl_c, newdata = data.frame(age = x)),
             parasite_phylum = "Cestoda"),
  data.frame(x = x, 
             y = predict(tl_n, newdata = data.frame(age = x)),
             parasite_phylum = "Nematoda")
  )
lg2 <- rbind(
  data.frame(x = x, 
             y = predict(tl_a_fams, newdata = data.frame(age = x)), 
             parasite_phylum = "Acanthocephala"),
  data.frame(x = x,
             y = predict(tl_c_fams, newdata = data.frame(age = x)),
             parasite_phylum = "Cestoda"),
  data.frame(x = x, 
             y = predict(tl_n_fams, newdata = data.frame(age = x)),
             parasite_phylum = "Nematoda")
  )
lgfam <- bind_rows(lg%>%mutate(grp = "species"),
                lg2%>%mutate(grp = "families"))
size_age_df2 <- bind_rows(size_age_df%>%mutate(grp = "species", n = 1),
                          size_age_df_fams%>%mutate(grp = "families"))

size_age_plot <- ggplot(size_age_df2, aes(x = age, y = exp(size), color = grp)) +
  geom_point(aes(shape = stage, size = n),
             alpha = 0.5) +
  geom_line(data = lgfam, aes(x = x, y = exp(y), color = grp),
            linetype = "dashed", size = 1.5) +
  coord_cartesian(xlim = c(0, 250), 
                  ylim = c(min(exp(size_age_df$size),na.rm=T),
                           max(exp(size_age_df$size),na.rm=T))
                  ) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(values = c(7, 1, 4), labels = c("Adult", "Larva", "Propagule")) +
  labs(x = "Age (days at 20 C)", y = "Body volume (mm3)", shape = NULL) +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.text = element_text(size = 6),
        legend.position = c(0.3,0.03),
        legend.justification = c(1,0)) +
  guides(size = F, color = F)
size_age_plot
ggsave(size_age_plot, filename = "../../figs/figB4_size_age_plot_imp.png", width = 6, height = 3)
```

Taxa that fall above or below these curves grew faster or slower than expected, given the deceleration in growth rates overall. Thus, the residuals around the curve can hint at whether more larval growth is associated with slower adult growth than expected.

```{r}
size_age_df2 <- size_age_df2%>%
  mutate(pred_size_curve =
           if_else(parasite_phylum == "Acanthocephala" & grp == "species",
                   predict(tl_a, newdata = data.frame(age = age)),
                   if_else(parasite_phylum == "Cestoda" & grp == "species",
                           predict(tl_c, newdata = data.frame(age = age)),
                           if_else(parasite_phylum == "Nematoda" & grp == "species",
                                   predict(tl_n, newdata = data.frame(age = age)),
                                                   NA_real_)
                                           )
                                   )
         )%>%
  mutate(pred_size_curve =
           if_else(parasite_phylum == "Acanthocephala" & grp == "families",
                   predict(tl_a_fams, newdata = data.frame(age = age)),
                   if_else(parasite_phylum == "Cestoda" & grp == "families",
                           predict(tl_c_fams, newdata = data.frame(age = age)),
                           if_else(parasite_phylum == "Nematoda" & grp == "families",
                                   predict(tl_n_fams, newdata = data.frame(age = age)),
                                   pred_size_curve)
                           )
                   )
         )%>%
  mutate(resid_size_curve = size - pred_size_curve)
```

Here are the curves' residuals plotted as a function of larval growth. There is not a trend for larger larvae to end up with larger adults than expected.

```{r}
ggplot(size_age_df2%>%filter(stage == "def_host"),
       aes(x = rg_int_host, y = resid_size_curve, color = grp)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_point(aes(size = n),
             shape = 7, alpha = 0.5) +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.position = c(0.97,0.03),
        legend.justification = c(1,0)) +
  labs(x = "Larval growth", y = "Residual adult size from curve", color = NULL) +
  guides(size = F)
```

Here are the residuals plotted as a function of larval developmental time. At least in cestodes, species with longer larval development tended to have smaller adult sizes than expected.

```{r}
ggplot(size_age_df2%>%filter(stage == "def_host"),
       aes(x = dd_int_host, y = resid_size_curve, color = grp)) +
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_point(aes(size = n),
             shape = 7, alpha = 0.5) +
  geom_smooth(method = lm, se = F) +
  facet_wrap(~parasite_phylum) +
  theme(panel.grid.minor = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.position = c(0.97,0.03),
        legend.justification = c(1,0)) +
  labs(x = "Larval development", y = "Residual adult size from curve", color = NULL) +
  guides(size = F)

```

Now let's move on to size at maturity. Even if worms grow more than expected as larvae, they are not predicted to have a larger-than-expected size at maturity. 

```{r}
ell1 <- post_cov_matrix_best(mod_comb_vcv4, "rg_int_host", "fs_def_host", ".units")
x <- c("traitrg_int_host:traitrg_int_host.units", "traitrg_int_host:traitfs_def_host.units", 
       "traitfs_def_host:traitrg_int_host.units", "traitfs_def_host:traitfs_def_host.units")
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
faa <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_rg_ih == "yes" | missing_fs == "yes", 
                 "zz", parasite_phylum)), 
       aes(x = rg_int_res, y = fs_def_res)) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval growth", y = "Residual size at maturity", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        ) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$rg_int_res, na.rm = T),
           y = max(two_hosts_p$fs_def_res, na.rm = T),
           color = "black", size = 3, hjust="left")+
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$rg_int_res_1, std_xaxes$rg_int_res_2),
                  ylim = c(std_yaxes$fs_def_res_1, std_yaxes$fs_def_res_2))

ell1 <- post_cov_matrix_best(mod_comb_vcv4, "dd_int_host", "fs_def_host", ".units")
x <- gsub(pattern = "rg_int_", replacement = "dd_int_", x)
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fab <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_dd_ih == "yes" | missing_fs == "yes", 
                 "zz", parasite_phylum)), 
       aes(x = dd_int_res, y = fs_def_res)) +
  geom_point(aes(shape = parasite_phylum_m), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval development", y = "Residual size at maturity", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$dd_int_res, na.rm = T), 
           y = max(two_hosts_p$fs_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "left") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$dd_int_res_1, std_xaxes$dd_int_res_2),
                  ylim = c(std_yaxes$fs_def_res_1, std_yaxes$fs_def_res_2))

fp <- rgr_get_cov_cor("rgr_int_res", "fs_def_res")
ell1 <- ci_ellipse(6*fp[[1]],0,0)
cor_anno <- fp[[2]]
fac <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 (missing_rg_ih == "yes" | missing_dd_ih == "yes") |
                   missing_fs == "yes", 
                 "zz", parasite_phylum)), 
       aes(x = rgr_int_res, y = fs_def_res)) +
  geom_point(aes(shape = parasite_phylum_m), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval growth rate", y = "Residual size at maturity", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        # legend.background = element_rect(color = "black"),
        # legend.position = c(0.15, 0.85)
        ) +
  annotate("text", label = cor_anno, 
           x = max(two_hosts_p$rgr_int_res, na.rm = T), 
           y = max(two_hosts_p$fs_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "right") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$rgr_int_res_1, std_xaxes$rgr_int_res_2),
                  ylim = c(std_yaxes$fs_def_res_1, std_yaxes$fs_def_res_2))
```

Indeed, worms that grew more than expected as larvae did not reach larger final sizes. However, prolonged larval development was associated with larger sizes at maturity. As a consequence, slow larval growth was associated with larger reproductive sizes.

```{r}
fd <- cowplot::plot_grid(faa, fab, fac, nrow = 1)
fd
fd <- cowplot::plot_grid(faa + theme(axis.title.x = element_blank(),
                                     axis.text.x = element_blank()),
                         fab + theme(axis.title = element_blank(),
                                     axis.text = element_blank()),
                         fac + theme(axis.title = element_blank(),
                                     axis.text = element_blank()),
                         nrow = 1,
                         align = "hv")
```

The final adult trait is age at maturity, which depends on the time spent developing both as a larva and as an adult.

```{r}
ell1 <- post_cov_matrix_best(mod_comb_vcv4, "rg_int_host", "ag_def_host", ".units")
x <- c("traitrg_int_host:traitrg_int_host.units", "traitrg_int_host:traitag_def_host.units", 
       "traitag_def_host:traitrg_int_host.units", "traitag_def_host:traitag_def_host.units")
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
faa <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_rg_ih == "yes" | missing_ag == "yes", 
                 "zz", parasite_phylum)),
              aes(x = rg_int_res, y = ag_def_res)) +
  geom_point(aes(shape = parasite_phylum_m),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval growth", y = "Residual age at maturity", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        ) +
  scale_shape_manual(values = c(16,17,15,4)) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$rg_int_res, na.rm = T), 
           y = max(two_hosts_p$ag_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "left")+
  coord_cartesian(xlim = c(std_xaxes$rg_int_res_1, std_xaxes$rg_int_res_2),
                  ylim = c(std_yaxes$ag_def_res_1, std_yaxes$ag_def_res_2))

ell1 <- post_cov_matrix_best(mod_comb_vcv4, "dd_int_host", "ag_def_host", ".units")
x <- gsub(pattern = "rg_int_", replacement = "dd_int_", x)
sx <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% x]))
cor_anno <- paste0(round(sx$quantiles[2,3], 2),
                   " [", round(sx$quantiles[2,1], 2), " to ",round(sx$quantiles[2,5], 2),"]")
fab <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 missing_dd_ih == "yes" | missing_ag == "yes", 
                 "zz", parasite_phylum)), 
       aes(x = dd_int_res, y = ag_def_res)) +
  geom_point(aes(shape = parasite_phylum_m), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval development", y = "Residual age at maturity", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        ) +
  annotate("text", label = cor_anno, 
           x = min(two_hosts_p$dd_int_res, na.rm = T), 
           y = max(two_hosts_p$ag_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "left") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$dd_int_res_1, std_xaxes$dd_int_res_2),
                  ylim = c(std_yaxes$ag_def_res_1, std_yaxes$ag_def_res_2))

fp <- rgr_get_cov_cor("rgr_int_res", "ag_def_res")
ell1 <- ci_ellipse(6*fp[[1]],0,0)
cor_anno <- fp[[2]]
fac <- ggplot(two_hosts_p%>%
               mutate(parasite_phylum_m = if_else(
                 (missing_dd_ih == "yes" | missing_rg_ih == "yes") |
                   missing_ag == "yes", 
                 "zz", parasite_phylum)),
       aes(x = rgr_int_res, y = ag_def_res)) +
  geom_point(aes(shape = parasite_phylum_m), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_path(data = arrange(ell1, angles),
              aes(x = x, y = y),
              alpha = 1, color = "black") +
  labs(x = "Residual larval growth rate", y = "Residual age at maturity", shape = NULL) +
  guides(color = F, shape = F) +
  theme(panel.grid.minor = element_blank(),
        ) +
  annotate("text", label = cor_anno, 
           x = max(two_hosts_p$rgr_int_res, na.rm = T), 
           y = max(two_hosts_p$ag_def_res, na.rm = T), 
           color = "black", size = 3, hjust = "right") +
  scale_shape_manual(values = c(16,17,15,4)) +
  coord_cartesian(xlim = c(std_xaxes$rgr_int_res_1, std_xaxes$rgr_int_res_2),
                  ylim = c(std_yaxes$ag_def_res_1, std_yaxes$ag_def_res_2))
```

Species with larvae that had prolonged larval development and slow growth had later ages at maturity, as we would expect.

```{r}
fe <- cowplot::plot_grid(faa, fab, fac, nrow = 1)
fe
fe <- cowplot::plot_grid(faa,
                         fab + theme(axis.title.y = element_blank(),
                                     axis.text.y = element_blank()),
                         fac + theme(axis.title.y = element_blank(),
                                     axis.text.y = element_blank()),
                         nrow = 1,
                         align = "hv")
```

When we put it all together, we find that species that grow more as larvae grow less as adults but do not mature at a smaller final size. Slow larval development is associated with slow adult development and larger final adult sizes. This is consistent with developmental rate as a species (or taxon) trait. 

```{r}
f5x <- cowplot::plot_grid(
  fa, fb, fc, fd, fe,
  ncol = 1,
  align = "left")
f5x
# ggsave(f5x, filename = "../../figs/trait_matx_imp_no_tax.png", width = 9, height = 12)
```

## Taxonomic trait covariation

Are the correlations above happening at a deeper taxonomic level? For example, are species that grow more as larvae and less as adults all in the same genus, family, etc. To get at this, we can ask what taxonomic levels account for the variation in parasite growth and development? Are the differences between genera or between classes? And is it the same for every parasite trait? we can extract this information from the mixed models. 

```{r}
make_tax_var_plot <- function(m){
  sol <- runjags::combine.mcmc(mcmc.list(lapply(m, function(x) {x$Sol}))) # fix param
  vcv <- runjags::combine.mcmc(mcmc.list(lapply(m, function(x) {x$VCV}))) # vc
  X <- m[[1]]$X # design matrix
  num_fe <- m[[1]]$Fixed$nfl # fixed effects
  l <- dim(X)[1]/6 # number of data points in model

  # calculate fixed effects var
  p_all <- as.matrix(X) %*% t(sol[,1:num_fe]) # predicteds for every post sample
  p1 <- p_all[1:l,] # preds for larval growth
  p2 <- p_all[(l+1):(l*2),] # preds for adult growth
  p3 <- p_all[(l*2 + 1):(l*3),] # preds for larval dd
  p4 <- p_all[(l*3 + 1):(l*4),] # preds for adult dd
  p5 <- p_all[(l*4 + 1):(l*5),] # preds for adult size
  p6 <- p_all[(l*5 + 1):(l*6),] # preds for adult age
  
  f1 <- apply(p1, MARGIN = 2, FUN = var)
  f2 <- apply(p2, MARGIN = 2, FUN = var)
  f3 <- apply(p3, MARGIN = 2, FUN = var)
  f4 <- apply(p4, MARGIN = 2, FUN = var)
  f5 <- apply(p5, MARGIN = 2, FUN = var)
  f6 <- apply(p6, MARGIN = 2, FUN = var)
  
  # random effects var
  resi <- which(grepl(colnames(vcv), pattern = '.units')) # remove resid variance from variance components
  randVar <- vcv[,-resi]
  ran1 <- randVar[, grepl(colnames(randVar), pattern = 'traitrg_int_host.')] # RE for larval size
  ran2 <- randVar[, grepl(colnames(randVar), pattern = 'traitrg_def_host.')] # RE for adult size
  ran3 <- randVar[, grepl(colnames(randVar), pattern = 'traitdd_int_host.')] # RE for larval devo time
  ran4 <- randVar[, grepl(colnames(randVar), pattern = 'traitdd_def_host.')] # RE for adult devo time
  ran5 <- randVar[, grepl(colnames(randVar), pattern = 'traitfs_def_host.')] # RE for adult devo time
  ran6 <- randVar[, grepl(colnames(randVar), pattern = 'traitag_def_host.')] # RE for adult devo time

  # resid var
  res1 <- vcv[, "traitrg_int_host:traitrg_int_host.units"]
  res2 <- vcv[, "traitrg_def_host:traitrg_def_host.units"]
  res3 <- vcv[, "traitdd_int_host:traitdd_int_host.units"]
  res4 <- vcv[, "traitdd_def_host:traitdd_def_host.units"]
  res5 <- vcv[, "traitfs_def_host:traitfs_def_host.units"]
  res6 <- vcv[, "traitag_def_host:traitag_def_host.units"]
  
  # fixed effect R2 marginal
  r2m1 <- f1/(f1 + rowSums(ran1) + res1)
  r2m2 <- f2/(f2 + rowSums(ran2) + res2)
  r2m3 <- f3/(f3 + rowSums(ran3) + res3)
  r2m4 <- f4/(f4 + rowSums(ran4) + res4)
  r2m5 <- f5/(f5 + rowSums(ran5) + res5)
  r2m6 <- f6/(f6 + rowSums(ran6) + res6)
  
  sp1 <- res1/(f1 + rowSums(ran1) + res1)
  sp2 <- res2/(f2 + rowSums(ran2) + res2)
  sp3 <- res3/(f3 + rowSums(ran3) + res3)
  sp4 <- res4/(f4 + rowSums(ran4) + res4)
  sp5 <- res5/(f5 + rowSums(ran5) + res5)
  sp6 <- res6/(f6 + rowSums(ran6) + res6)
  
  g1 <- ran1[,1]/(f1 + rowSums(ran1) + res1)
  g2 <- ran2[,1]/(f2 + rowSums(ran2) + res2)
  g3 <- ran3[,1]/(f3 + rowSums(ran3) + res3)
  g4 <- ran4[,1]/(f4 + rowSums(ran4) + res4)
  g5 <- ran5[,1]/(f5 + rowSums(ran5) + res5)
  g6 <- ran6[,1]/(f6 + rowSums(ran6) + res6)
  
  fa1 <- ran1[,2]/(f1 + rowSums(ran1) + res1)
  fa2 <- ran2[,2]/(f2 + rowSums(ran2) + res2)
  fa3 <- ran3[,2]/(f3 + rowSums(ran3) + res3)
  fa4 <- ran4[,2]/(f4 + rowSums(ran4) + res4)
  fa5 <- ran5[,2]/(f5 + rowSums(ran5) + res5)
  fa6 <- ran6[,2]/(f6 + rowSums(ran6) + res6)
  
  o1 <- ran1[,3]/(f1 + rowSums(ran1) + res1)
  o2 <- ran2[,3]/(f2 + rowSums(ran2) + res2)
  o3 <- ran3[,3]/(f3 + rowSums(ran3) + res3)
  o4 <- ran4[,3]/(f4 + rowSums(ran4) + res4)
  o5 <- ran5[,3]/(f5 + rowSums(ran5) + res5)
  o6 <- ran6[,3]/(f6 + rowSums(ran6) + res6)
  
  c1 <- ran1[,4]/(f1 + rowSums(ran1) + res1)
  c2 <- ran2[,4]/(f2 + rowSums(ran2) + res2)
  c3 <- ran3[,4]/(f3 + rowSums(ran3) + res3)
  c4 <- ran4[,4]/(f4 + rowSums(ran4) + res4)
  c5 <- ran5[,4]/(f5 + rowSums(ran5) + res5)
  c6 <- ran6[,4]/(f6 + rowSums(ran6) + res6)
  
  # p1 <- ran1[,5]/(f1 + rowSums(ran1) + res1)
  # p2 <- ran2[,5]/(f2 + rowSums(ran2) + res2)
  # p3 <- ran3[,5]/(f3 + rowSums(ran3) + res3)
  # p4 <- ran4[,5]/(f4 + rowSums(ran4) + res4)
  # p5 <- ran5[,5]/(f5 + rowSums(ran5) + res5)
  # p6 <- ran6[,5]/(f6 + rowSums(ran6) + res6)
  
  vc_lev <- rep(c("fixed", "species\nresidual", "genus", "family", "order", "class"), each = length(g1))

  df1 <- data.frame(trait = "rg_int", trait2 = "size", stage = "larva",
                  vc_lev = vc_lev,
                  r2 = c(r2m1, sp1, g1, fa1, o1, c1))

  df2 <- data.frame(trait = "rg_def", trait2 = "size", stage = "adult",
                  vc_lev = vc_lev,
                  r2 = c(r2m2, sp2, g2, fa2, o2, c2))

  df3 <- data.frame(trait = "dd_int", trait2 = "dt", stage = "larva",
                  vc_lev = vc_lev,
                  r2 = c(r2m3, sp3, g3, fa3, o3, c3))

  df4 <- data.frame(trait = "dd_def", trait2 = "dt", stage = "adult",
                  vc_lev = vc_lev,
                  r2 = c(r2m4, sp4, g4, fa4, o4, c4))
  
  df5 <- data.frame(trait = "fs_def", trait2 = "size", stage = "adult",
                  vc_lev = vc_lev,
                  r2 = c(r2m5, sp5, g5, fa5, o5, c5))
  
  df6 <- data.frame(trait = "ag_def", trait2 = "dt", stage = "adult",
                  vc_lev = vc_lev,
                  r2 = c(r2m6, sp6, g6, fa6, o6, c6))
  df <- bind_rows(df1, df2, df3, df4, df5, df6)
  df <- df%>%
  group_by(trait, trait2, stage, vc_lev)%>%
  summarize(r2_fit = median(r2), r2_lwr = quantile(r2, probs = 0.025), r2_upr = quantile(r2, probs = 0.975))%>%
  mutate(vc_lev = fct_relevel(vc_lev, c("fixed", "class", "order", "family", "genus", "species\nresidual")))

  fp <- ggplot(df,
         aes(x = vc_lev, y = r2_fit, ymin = r2_lwr, ymax = r2_upr, 
             color = trait,
             shape = trait2)) +
    geom_pointrange(position = position_dodge2(width = 0.5)) +
    geom_line(aes(group = trait),
              position = position_dodge(width = 0.5),
              alpha = 0.3) +
    theme(axis.title.x = element_blank(),
          panel.grid.minor = element_blank()) +
    labs(y = "Proportion variance", shape = "Trait") +
    scale_y_continuous(limits = c(0,0.75), breaks = seq(0, 0.8, by = 0.1))
  return(fp)
}
```


Here is the variance explained by each taxonomic level in the models without fixed effects. Uncertainty in the effects increase up the taxonomic hierarchy. Growth traits vary most among families. Developmental times also vary among families, but among orders and classes too.

```{r}
s41 <- make_tax_var_plot(chains1t) + 
  scale_color_manual(values = rep(RColorBrewer::brewer.pal(3, "Set1"), 2),
                     
                     labels = c("Size/Age Maturity", "in DH", "in IH","Size/Age Maturity", "DH", "IH")
                     ) +
  guides(shape = F) +
  theme(legend.title = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.position = c(0.25, 0.75),
        panel.grid.major.x = element_blank()) +
  facet_wrap(~trait2, labeller = labeller(trait2 = c(`dt` = "Development, Age", 
                                                     `size` = "Growth, Size")))
s41
```

Here is the same plot but for the model including fixed effects. Overall, the taxonomic effects decrease. Adult traits still tend to vary more among genera than larval traits, but the differences deeper in the phylogeny are not as clear.

```{r}
s42 <- make_tax_var_plot(chains4t) +
  scale_color_manual(values = rep(RColorBrewer::brewer.pal(3, "Set1"), 2),
                     
                     labels = c("Size/Age Maturity", "DH", "IH","Size/Age Maturity", "DH", "IH")
                     ) +
  guides(shape = F) +
  theme(legend.title = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.position = c(0.25, 0.75),
        panel.grid.major.x = element_blank()) +
  facet_wrap(~trait2, labeller = labeller(trait2 = c(`dt` = "Development, Age", 
                                                     `size` = "Growth, Size")))
s42
```

```{r}
s4 <- cowplot::plot_grid(s41 + theme(axis.text.x = element_blank()), 
                         s42 + theme(strip.background = element_blank(),
                                     strip.text = element_blank()) +
                           guides(color = F),
                         align = "hv", labels = c("(a)", "(b)"), ncol = 1)
ggsave(s4, filename = "../../figs/figC3_imp.png", width = 6, height = 6)
ggsave(s4, filename = "../../figs/figC3_imp.svg", width = 6, height = 6)
# remove extra symbols, reduce size of legend. move a and b closer together.
```


Now let's fit a model allowing taxonomic trait covariance, i.e. taxa with high values for trait 1 may have higher or lower values for trait 2. To see where covariance arises, we add taxonomic levels from root to tip. For example, we test covariance among orders and then, controlling for order-level effects, we test whether there is covariance among parasite families and so on.

Overall, adding taxonomic covariance is an improvement, at least judged by model DIC. Also, below we see that covariances are significantly different from zero.

```{r}
cat("Delta DIC, +taxonomic covariance: ", 
    mean(unlist(lapply(chains4t, function(x){x$DIC}))) - 
      mean(unlist(lapply(chains4t.1, function(x){x$DIC}))) 
    )
```


```{r}
mod_comb_sol4t.1 <- runjags::combine.mcmc(mcmc.list(lapply(chains4t.1, function(x) {x$Sol})))
mod_comb_sol4t_fam <- runjags::combine.mcmc(mcmc.list(lapply(chains4t_fam, function(x) {x$Sol})))

```
```{r}
sx <- summary(
  mod_comb_sol4t_fam[,grepl(pattern = "traitrg_int_host.parasite_family", colnames(mod_comb_sol4t_fam))]
)
re_fams <- data.frame(fam = row.names(sx$quantiles), 
                      re_lwr = sx$quantiles[,1],
                      re = sx$quantiles[,3],
                      re_upr = sx$quantiles[,5])
re_fams <- re_fams%>%
  mutate(fam = gsub(pattern = "traitrg_int_host.parasite_family.", "", fam))
```

Here are the number of distinct families that were included in the model

```{r}
n_distinct(re_fams$fam)
```

Here are families that grew more as larvae than expected (large random effects).

```{r}
arrange(re_fams, desc(re))%>%slice_head(n=10)
```

Here are the families that grew less as larvae than expected.

```{r}
arrange(re_fams, re)%>%slice_head(n=10)
```

Here are the worm families that developed longer than expected as larvae.

```{r}
sx <- summary(
  mod_comb_sol4t_fam[,grepl(pattern = "traitdd_int_host.parasite_family", colnames(mod_comb_sol4t_fam))]
)
re_fams <- data.frame(fam = row.names(sx$quantiles), 
                      re_lwr = sx$quantiles[,1],
                      re = sx$quantiles[,3],
                      re_upr = sx$quantiles[,5])
re_fams <- re_fams%>%
  mutate(fam = gsub(pattern = "traitdd_int_host.parasite_family.", "", fam))
arrange(re_fams, desc(re))%>%slice_head(n=10)
```

Here are the families that developed shorter than expected as larvae.

```{r}
arrange(re_fams, re)%>%slice_head(n=10)
```

Let's combine these into a single measure for larval growth/development. We standardize the random effects for larval growth and development, then we average them. Positive values are families that grew more/longer than expected. Here are those families:

```{r}
sx1 <- mod_comb_sol4t_fam[,grepl(pattern = "traitdd_int_host.parasite_family", colnames(mod_comb_sol4t_fam))]
sx2 <- mod_comb_sol4t_fam[,grepl(pattern = "traitrg_int_host.parasite_family", colnames(mod_comb_sol4t_fam))]

# std each set of RE estimates
sx1 <- sx1/apply(sx1, MARGIN = 1, sd) 
sx2 <- sx2/apply(sx2, MARGIN = 1, sd)

# average std re estimates
sx <- (sx1 + sx2)/2

sx <- summary(sx)
sx1 <- summary(sx1)
sx2 <- summary(sx2)
re_fams <- data.frame(fam = row.names(sx$quantiles), 
                      re_lwr = sx$quantiles[,1],
                      re = sx$quantiles[,3],
                      re_upr = sx$quantiles[,5],
                      t1_lwr = sx1$quantiles[,1],
                      t1 = sx1$quantiles[,3],
                      t1_upr = sx1$quantiles[,5],
                      t2_lwr = sx2$quantiles[,1],
                      t2 = sx2$quantiles[,3],
                      t2_upr = sx2$quantiles[,5]
                      )
re_fams <- re_fams%>%
  mutate(fam = gsub(pattern = "traitdd_int_host.parasite_family.", "", fam))
row.names(re_fams) <- NULL
arrange(re_fams, desc(re))%>%slice_head(n=10)
```

And here are the families that grew less/shorter than expected as larvae: 

```{r}
arrange(re_fams, re)%>%slice_head(n=10)
```

Moving on to adult growth, here are the families that grew more as adults than expected.

```{r}
sx <- summary(
  mod_comb_sol4t_fam[,grepl(pattern = "traitrg_def_host.parasite_family", colnames(mod_comb_sol4t_fam))]
)
re_fams <- data.frame(fam = row.names(sx$quantiles), 
                      re_lwr = sx$quantiles[,1],
                      re = sx$quantiles[,3],
                      re_upr = sx$quantiles[,5])
re_fams <- re_fams%>%
  mutate(fam = gsub(pattern = "traitrg_def_host.parasite_family.", "", fam))
arrange(re_fams, desc(re))%>%slice_head(n=10)
```

Here are the families that grew less as adults than expected.

```{r}
arrange(re_fams, re)%>%slice_head(n=10)
```

Here are the families that had longer prepatent periods than expected.

```{r}
sx <- summary(
  mod_comb_sol4t_fam[,grepl(pattern = "traitdd_def_host.parasite_family", colnames(mod_comb_sol4t_fam))]
)
re_fams <- data.frame(fam = row.names(sx$quantiles), 
                      re_lwr = sx$quantiles[,1],
                      re = sx$quantiles[,3],
                      re_upr = sx$quantiles[,5])
re_fams <- re_fams%>%
  mutate(fam = gsub(pattern = "traitdd_def_host.parasite_family.", "", fam))
arrange(re_fams, desc(re))%>%slice_head(n=10)
```

Here are the families that had shorter prepatent periods than expected.

```{r}
arrange(re_fams, re)%>%slice_head(n=10)
```

Let's combine adult growth/development into a single metric. We standardize the random effects for adult growth and development, then we average them. Positive values are families that grew more/longer than expected. Here are those families:

```{r}
sx1 <- mod_comb_sol4t_fam[,grepl(pattern = "traitdd_def_host.parasite_family", colnames(mod_comb_sol4t_fam))]
sx2 <- mod_comb_sol4t_fam[,grepl(pattern = "traitrg_def_host.parasite_family", colnames(mod_comb_sol4t_fam))]

# std each set of RE estimates
sx1 <- sx1/apply(sx1, MARGIN = 1, sd) 
sx2 <- sx2/apply(sx2, MARGIN = 1, sd)

# average std re estimates
sx <- (sx1 + sx2)/2

sx <- summary(sx)
sx1 <- summary(sx1)
sx2 <- summary(sx2)
re_fams <- data.frame(fam = row.names(sx$quantiles), 
                      re_lwr = sx$quantiles[,1],
                      re = sx$quantiles[,3],
                      re_upr = sx$quantiles[,5],
                      t1_lwr = sx1$quantiles[,1],
                      t1 = sx1$quantiles[,3],
                      t1_upr = sx1$quantiles[,5],
                      t2_lwr = sx2$quantiles[,1],
                      t2 = sx2$quantiles[,3],
                      t2_upr = sx2$quantiles[,5]
                      )
re_fams <- re_fams%>%
  mutate(fam = gsub(pattern = "traitdd_def_host.parasite_family.", "", fam))
row.names(re_fams) <- NULL
arrange(re_fams, desc(re))%>%slice_head(n=10)
```

And here are the families that grew less than expected as adults: 

```{r}
arrange(re_fams, re)%>%slice_head(n=10)
```

These also tend to be the families that attain larger sizes and ages at maturity. Here are the families that are older/larger adults, relative to expectations:

```{r}
sx1 <- mod_comb_sol4t_fam[,grepl(pattern = "traitag_def_host.parasite_family", colnames(mod_comb_sol4t_fam))]
sx2 <- mod_comb_sol4t_fam[,grepl(pattern = "traitfs_def_host.parasite_family", colnames(mod_comb_sol4t_fam))]

# std each set of RE estimates
sx1 <- sx1/apply(sx1, MARGIN = 1, sd) 
sx2 <- sx2/apply(sx2, MARGIN = 1, sd)

# average std re estimates
sx <- (sx1 + sx2)/2

sx <- summary(sx)
sx1 <- summary(sx1)
sx2 <- summary(sx2)

re_fams <- data.frame(fam = row.names(sx$quantiles), 
                      re_lwr = sx$quantiles[,1],
                      re = sx$quantiles[,3],
                      re_upr = sx$quantiles[,5],
                      t1_lwr = sx1$quantiles[,1],
                      t1 = sx1$quantiles[,3],
                      t1_upr = sx1$quantiles[,5],
                      t2_lwr = sx2$quantiles[,1],
                      t2 = sx2$quantiles[,3],
                      t2_upr = sx2$quantiles[,5]
                      )
re_fams <- re_fams%>%
  mutate(fam = gsub(pattern = "traitag_def_host.parasite_family.", "", fam))
row.names(re_fams) <- NULL
arrange(re_fams, desc(re))%>%slice_head(n=10)
```

And here are the families that mature as small/young adults:

```{r}
arrange(re_fams, re)%>%slice_head(n=10)
```

Now let's plot the covariance matrices. Above we plotted trait covariance without taxonomic effects - the species that grew more or less than expected from just the fixed effects (marginal residuals). Now, we divide this covariance by taxonomic levels. 

The taxonomic covariances estimated by the model can be better understood by plotting *conditional* residuals. In other, words, we take the residuals accounting for fixed effects (host mass etc.) and taxonomy. The conditional residuals represent high (or low) growth, given host mass and taxonomy. Since we fit nested models (i.e. first order, then add family, then add genus), we can look at conditional residuals after controlling for higher level taxonomy.  For instance, the conditional residuals at the family level represent families that grow more (or less) than expected given fixed effects like host mass but also relative to the mean growth for their order.

```{r}
pal <- RColorBrewer::brewer.pal(name="Dark2", n=8)
```

```{r}
l <- length(two_hosts2$Parasite.species)

# marginal predictions from trait means, "raw"
p_raw <- lapply(chains1t, 
                function(x){predict.MCMCglmm(x, marginal = x$Random$formula)}
                )
p_raw <- data.frame(p_raw)
p_raw <- apply(p_raw, MARGIN = 1, FUN = median)
names(p_raw) <- NULL

# marginal predictions, i.e. trait predicted with just fixed effects (no tax cov)
p_m <- lapply(chains4t,
              function(x){
                predict.MCMCglmm(x,
                                 marginal = ~
                                   idh(trait):parasite_genus +
                                   idh(trait):parasite_family +
                                   idh(trait):parasite_order +
                                   idh(trait):parasite_class
                                 )                }
)

p_m <- data.frame(p_m)
p_m <- apply(p_m, MARGIN = 1, FUN = median)
names(p_m) <- NULL

# conditional predictions for orders (removes effect of class)
p_o <- lapply(chains4t_ord, 
              function(x){predict.MCMCglmm(x, 
                                           marginal = ~ us(trait):parasite_order)})
p_o <- data.frame(p_o)
p_o <- apply(p_o, MARGIN = 1, FUN = median)
names(p_o) <- NULL

# conditional predictions for fams (removes effect of order, class)
p_f <- lapply(chains4t_ord, function(x){predict.MCMCglmm(x, 
                                                         marginal = NULL)})
p_f <- data.frame(p_f)
p_f <- apply(p_f, MARGIN = 1, FUN = median)
names(p_f) <- NULL

# conditional predictions for genera (removes effect of fam, order, class)
p_g <- lapply(chains4t_fam, function(x){predict.MCMCglmm(x, 
                                                         marginal = NULL)})
p_g <- data.frame(p_g)
p_g <- apply(p_g, MARGIN = 1, FUN = median)
names(p_g) <- NULL

# conditional predictions, i.e. trait predicted with fixed effects and all taxonomy
p_c <- lapply(chains4t.1, function(x){predict.MCMCglmm(x, marginal = NULL)})
p_c <- data.frame(p_c)
p_c <- apply(p_c, MARGIN = 1, FUN = median)
names(p_c) <- NULL
```
```{r}
p <- data.frame(rg_int_predraw = p_raw[1:l],
                rg_def_predraw = p_raw[(l+1):(l*2)],
                dd_int_predraw = p_raw[(l*2+1):(l*3)],
                dd_def_predraw = p_raw[(l*3+1):(l*4)],
                rgr_int_predraw = p_raw[1:l]/(exp(p_raw[(l*2+1):(l*3)])/15),
                rgr_def_predraw = p_raw[(l+1):(l*2)]/(exp(p_raw[(l*3+1):(l*4)])/15),
                fs_def_predraw = p_raw[(l*4+1):(l*5)],
                ag_def_predraw = p_raw[(l*5+1):(l*6)],
                rg_int_pred = p_m[1:l],
                rg_def_pred = p_m[(l+1):(l*2)],
                dd_int_pred = p_m[(l*2+1):(l*3)],
                dd_def_pred = p_m[(l*3+1):(l*4)],
                rgr_int_pred = p_m[1:l]/(exp(p_m[(l*2+1):(l*3)])/15),
                rgr_def_pred = p_m[(l+1):(l*2)]/(exp(p_m[(l*3+1):(l*4)])/15),
                fs_def_pred = p_m[(l*4+1):(l*5)],
                ag_def_pred = p_m[(l*5+1):(l*6)],
                rg_int_predg = p_g[1:l],
                rg_def_predg = p_g[(l+1):(l*2)],
                dd_int_predg = p_g[(l*2+1):(l*3)],
                dd_def_predg = p_g[(l*3+1):(l*4)],
                rgr_int_predg = p_g[1:l]/(exp(p_g[(l*2+1):(l*3)])/15),
                rgr_def_predg = p_g[(l+1):(l*2)]/(exp(p_g[(l*3+1):(l*4)])/15),
                fs_def_predg = p_g[(l*4+1):(l*5)],
                ag_def_predg = p_g[(l*5+1):(l*6)],
                rg_int_predf = p_f[1:l],
                rg_def_predf = p_f[(l+1):(l*2)],
                dd_int_predf = p_f[(l*2+1):(l*3)],
                dd_def_predf = p_f[(l*3+1):(l*4)],
                rgr_int_predf = p_f[1:l]/(exp(p_f[(l*2+1):(l*3)])/15),
                rgr_def_predf = p_f[(l+1):(l*2)]/(exp(p_f[(l*3+1):(l*4)])/15),
                fs_def_predf = p_f[(l*4+1):(l*5)],
                ag_def_predf = p_f[(l*5+1):(l*6)],
                rg_int_predo = p_o[1:l],
                rg_def_predo = p_o[(l+1):(l*2)],
                dd_int_predo = p_o[(l*2+1):(l*3)],
                dd_def_predo = p_o[(l*3+1):(l*4)],
                rgr_int_predo = p_o[1:l]/(exp(p_o[(l*2+1):(l*3)])/15),
                rgr_def_predo = p_o[(l+1):(l*2)]/(exp(p_o[(l*3+1):(l*4)])/15),
                fs_def_predo = p_o[(l*4+1):(l*5)],
                ag_def_predo = p_o[(l*5+1):(l*6)],
                rg_int_predc = p_c[1:l],
                rg_def_predc = p_c[(l+1):(l*2)],
                dd_int_predc = p_c[(l*2+1):(l*3)],
                dd_def_predc = p_c[(l*3+1):(l*4)],
                rgr_int_predc = p_c[1:l]/(exp(p_c[(l*2+1):(l*3)])/15),
                rgr_def_predc = p_c[(l+1):(l*2)]/(exp(p_c[(l*3+1):(l*4)])/15),
                fs_def_predc = p_c[(l*4+1):(l*5)],
                ag_def_predc = p_c[(l*5+1):(l*6)]
                )
```

```{r}
two_hosts_p <- bind_cols(two_hosts2, p)%>%
  mutate(rg_int_resraw = rg_int_host - rg_int_predraw,
         rg_def_resraw = rg_def_host - rg_def_predraw,
         dd_int_resraw = dd_int_host - dd_int_predraw,
         dd_def_resraw = dd_def_host - dd_def_predraw,
         rgr_int_resraw = rgr_int_host - rgr_int_predraw,
         rgr_def_resraw = rgr_def_host - rgr_def_predraw,
         fs_def_resraw = fs_def_host - fs_def_predraw,
         ag_def_resraw = ag_def_host - ag_def_predraw,
         
         rg_int_resm = rg_int_host - rg_int_pred,
         rg_def_resm = rg_def_host - rg_def_pred,
         dd_int_resm = dd_int_host - dd_int_pred,
         dd_def_resm = dd_def_host - dd_def_pred,
         rgr_int_resm = rgr_int_host - rgr_int_pred,
         rgr_def_resm = rgr_def_host - rgr_def_pred,
         fs_def_resm = fs_def_host - fs_def_pred,
         ag_def_resm = ag_def_host - ag_def_pred,
         
         rg_int_resg = rg_int_host - rg_int_predg,
         rg_def_resg = rg_def_host - rg_def_predg,
         dd_int_resg = dd_int_host - dd_int_predg,
         dd_def_resg = dd_def_host - dd_def_predg,
         rgr_int_resg = rgr_int_host - rgr_int_predg,
         rgr_def_resg = rgr_def_host - rgr_def_predg,
         fs_def_resg = fs_def_host - fs_def_predg,
         ag_def_resg = ag_def_host - ag_def_predg,
         
         rg_int_resf = rg_int_host - rg_int_predf,
         rg_def_resf = rg_def_host - rg_def_predf,
         dd_int_resf = dd_int_host - dd_int_predf,
         dd_def_resf = dd_def_host - dd_def_predf,
         rgr_int_resf = rgr_int_host - rgr_int_predf,
         rgr_def_resf = rgr_def_host - rgr_def_predf,
         fs_def_resf = fs_def_host - fs_def_predf,
         ag_def_resf = ag_def_host - ag_def_predf,
         
         rg_int_reso = rg_int_host - rg_int_predo,
         rg_def_reso = rg_def_host - rg_def_predo,
         dd_int_reso = dd_int_host - dd_int_predo,
         dd_def_reso = dd_def_host - dd_def_predo,
         rgr_int_reso = rgr_int_host - rgr_int_predo,
         rgr_def_reso = rgr_def_host - rgr_def_predo,
         fs_def_reso = fs_def_host - fs_def_predo,
         ag_def_reso = ag_def_host - ag_def_predo,
         
         rg_int_resc = rg_int_host - rg_int_predc,
         rg_def_resc = rg_def_host - rg_def_predc,
         dd_int_resc = dd_int_host - dd_int_predc,
         dd_def_resc = dd_def_host - dd_def_predc,
         rgr_int_resc = rgr_int_host - rgr_int_predc,
         rgr_def_resc = rgr_def_host - rgr_def_predc,
         fs_def_resc = fs_def_host - fs_def_predc,
         ag_def_resc = ag_def_host - ag_def_predc
         )
```


```{r}
# average residuals at each taxonomic level
# raw resid
spraw <- two_hosts_p%>%
  filter(is.na(pred))%>%
  select(Parasite.species, parasite_phylum, parasite_order, parasite_family, parasite_genus,
         rg_int_resraw:ag_def_resraw, 
         missing_rg_ih:missing_ag)%>%
  rename_with(~gsub("raw$", "", .x))%>%
  mutate(level = "raw", n = 1)
# marginal resid (no fixed effects)
spmarg <- two_hosts_p%>%
  filter(is.na(pred))%>%
  select(Parasite.species, parasite_phylum, parasite_order, parasite_family, parasite_genus,
         rg_int_resm:ag_def_resm,
         missing_rg_ih:missing_ag)%>%
  rename_with(~gsub("m$", "", .x))%>%
  rename(parasite_phylum = parasite_phylu)%>%
  mutate(level = "fixed", n = 1)
# order avg resid after removing fixed effx
od <- two_hosts_p%>%
  filter(is.na(pred))%>%
  group_by(parasite_phylum, parasite_order)%>%
  summarise(n = n(),
    across(rg_int_reso:ag_def_reso, 
           list(median = ~median(.x, na.rm = T),
                n_not_miss = ~sum(!is.na(.x)))
           ))%>%
  rename_with(~gsub("o_median$", "", .x))%>%
  rename_with(~gsub("o_n", "", .x))%>%
  mutate(level = "order")%>%
  ungroup()
# fam avg resid after removing fixed effx
fd <- two_hosts_p%>%
  filter(is.na(pred))%>%
  group_by(parasite_phylum, parasite_family)%>%
  summarise(n = n(),
    across(rg_int_resf:ag_def_resf, 
           list(median = ~median(.x, na.rm = T),
                n_not_miss = ~sum(!is.na(.x)))
           ))%>%
  rename_with(~gsub("f_median$", "", .x))%>%
  rename_with(~gsub("f_n", "", .x))%>%
  mutate(level = "family")%>%
  ungroup()
# genus avg resid after removing fixed effx
gd <- two_hosts_p%>%
  filter(is.na(pred))%>%
  group_by(parasite_phylum, parasite_genus)%>%
  summarise(n = n(),
    across(rg_int_resg:ag_def_resg, 
           list(median = ~median(.x, na.rm = T),
                n_not_miss = ~sum(!is.na(.x)))
           ))%>%
  rename_with(~gsub("g_median$", "", .x))%>%
  rename_with(~gsub("g_n", "", .x))%>%
  mutate(level = "genus")%>%
  ungroup()

# conditional residuals (fixed and random effects removed)
sp <- two_hosts_p%>%
  filter(is.na(pred))%>%
  select(Parasite.species, parasite_phylum, 
         rg_int_resc:ag_def_resc,
         missing_rg_ih:missing_ag)%>%
  rename_with(~gsub("c$", "", .x))%>%
  mutate(level = "species", n = 1)

dc <- bind_rows(spraw, spmarg, sp, od, fd, gd)
dc <- mutate(dc, level = fct_relevel(level, c("raw", "fixed", 
                                              "order", "family", "genus", "species")))
dc <- dc%>%
  rename(missing_rg_int_host = missing_rg_ih,
         missing_rg_def_host = missing_rg_dh,
         missing_dd_int_host = missing_dd_ih,
         missing_dd_def_host = missing_dd_dh,
         missing_fs_def_host = missing_fs,
         missing_ag_def_host = missing_ag)
```

```{r}
res_cn0 <- colnames(mod_comb_vcv4t.1[,grepl(".units",colnames(mod_comb_vcv4t.1))])
res_cn1 <- colnames(mod_comb_vcv4t.1[,grepl(".parasite_genus",colnames(mod_comb_vcv4t.1))])
res_cn2 <- colnames(mod_comb_vcv4t_fam[,grepl(".parasite_family",colnames(mod_comb_vcv4t_fam))])
res_cn3 <- colnames(mod_comb_vcv4t_ord[,grepl(".parasite_order",colnames(mod_comb_vcv4t_ord))])

res_cn4 <- colnames(mod_comb_vcv4[,grepl(".units",colnames(mod_comb_vcv4))]) # resid
res_cn5 <- colnames(mod_comb_vcv1[,grepl(".units",colnames(mod_comb_vcv1))]) # sp-level raw

sx0 <- summary(posterior.cor(mod_comb_vcv4t.1[,colnames(mod_comb_vcv4t.1) %in% res_cn0]))
sx1 <- summary(posterior.cor(mod_comb_vcv4t.1[,colnames(mod_comb_vcv4t.1) %in% res_cn1]))
sx2 <- summary(posterior.cor(mod_comb_vcv4t_fam[,colnames(mod_comb_vcv4t_fam) %in% res_cn2]))
sx3 <- summary(posterior.cor(mod_comb_vcv4t_ord[,colnames(mod_comb_vcv4t_ord) %in% res_cn3]))
sx4 <- summary(posterior.cor(mod_comb_vcv4[,colnames(mod_comb_vcv4) %in% res_cn4]))
sx5 <- summary(posterior.cor(mod_comb_vcv1[,colnames(mod_comb_vcv1) %in% res_cn5]))
cor_d <- data.frame(cor = c(res_cn0, res_cn1, res_cn2, res_cn3, res_cn4, res_cn5),
                    level = rep(c("species", "genus", "family", "order", "fixed", "raw"), 
                                times = c(length(res_cn0), length(res_cn1), length(res_cn2),
                                          length(res_cn3), length(res_cn4), length(res_cn5))),
                    cor_lwr = c(sx0$quantiles[,1], sx1$quantiles[,1], sx2$quantiles[,1],
                                sx3$quantiles[,1], sx4$quantiles[,1], sx5$quantiles[,1]),
                    cor_fit = c(sx0$quantiles[,3], sx1$quantiles[,3], sx2$quantiles[,3], 
                                sx3$quantiles[,3], sx4$quantiles[,3], sx5$quantiles[,3]),
                    cor_upr = c(sx0$quantiles[,5], sx1$quantiles[,5], sx2$quantiles[,5],
                                sx3$quantiles[,5], sx4$quantiles[,5], sx5$quantiles[,5]))
cor_d <- cor_d%>%
  mutate(txt = paste0(round(cor_fit, 2), " [", round(cor_lwr, 2), " to ",round(cor_upr, 2),"]"))

cor_d <- mutate(cor_d, level = fct_relevel(level, c("raw", "fixed", "order", "family", "genus", "species")))
rm(res_cn0, res_cn1, res_cn2, res_cn3, res_cn4, res_cn5, sx0, sx1, sx2, sx3, sx4, sx5)
```

```{r}
pal <- RColorBrewer::brewer.pal(name="Dark2", n=8)
# function to make taxonomic covariance plot
tax_cov_plot <- function(trait1, trait2, label1, label2, corner){
  corx <- paste0("trait",trait1,":","trait",trait2)
  
  ell00 <- post_cov_matrix_best(mod_comb_vcv1, trait1, trait2, ".units")
  ell0 <- post_cov_matrices_df(mod_comb_vcv4, trait1, trait2, ".units", 10)
  ell1 <- post_cov_matrices_df(mod_comb_vcv4t.1, trait1, trait2, ".parasite_genus", 10)
  ell2 <- post_cov_matrices_df(mod_comb_vcv4t_fam, trait1, trait2, ".parasite_family", 10)
  ell3 <- post_cov_matrices_df(mod_comb_vcv4t_ord, trait1, trait2, ".parasite_order", 10)
  ell4 <- post_cov_matrices_df(mod_comb_vcv4t.1, trait1, trait2, ".units", 10)
  ell <- bind_rows(ell00%>%mutate(level = "raw", p_samp = "1"),
                   ell0%>%mutate(level = "fixed"),
                   ell1%>%mutate(level = "genus"),
                   ell2%>%mutate(level = "family"),
                   ell3%>%mutate(level = "order"),
                   ell4%>%mutate(level = "species"))%>%
    mutate(level = fct_relevel(level, c("raw", "fixed", "order", "family", "genus", "species")))
  
  
  var1 <- paste0("trait",trait1,":","trait",trait1,".units")
  res_var <- median(mod_comb_vcv1[,var1]) # res var int-only model
  res_var0 <- median(mod_comb_vcv4[,var1])
  res_var1 <- median(mod_comb_vcv4t_ord[,var1])
  res_var2 <- median(mod_comb_vcv4t_fam[,var1])
  res_var3 <- median(mod_comb_vcv4t.1[,var1])
  x0 <- round(100*((res_var - res_var0)/res_var))
  x1 <- round(100*((res_var0 - res_var1)/res_var))
  x2 <- round(100*((res_var1 - res_var2)/res_var))
  x3 <- round(100*((res_var2 - res_var3)/res_var))
  x4 <- round(100*(res_var3/res_var))
  
  # labx <- paste0(label1, " (", vx1,", ", vx2,", ", vx3, ", ", vx4,"%)")

  var2 <- paste0("trait",trait2,":","trait",trait2,".units")
  res_var <- median(mod_comb_vcv1[,var2]) # res var int-only model
  res_var0 <- median(mod_comb_vcv4[,var2])
  res_var1 <- median(mod_comb_vcv4t_ord[,var2])
  res_var2 <- median(mod_comb_vcv4t_fam[,var2])
  res_var3 <- median(mod_comb_vcv4t.1[,var2])
  y0 <- round(100*((res_var - res_var0)/res_var))
  y1 <- round(100*((res_var0 - res_var1)/res_var))
  y2 <- round(100*((res_var1 - res_var2)/res_var))
  y3 <- round(100*((res_var2 - res_var3)/res_var))
  y4 <- round(100*(res_var3/res_var))

  regs <- dc%>%
    rename_with(function(x){"v1"}, (gsub(pattern = "_host", "_res", trait1)))%>%
    select(level, v1)%>%
    group_by(level)%>%
    summarise(across(is.double, list(min, max), na.rm = T))%>%
    ungroup()%>%
    mutate(slope = NA_real_)
  var_x <- paste0("trait",trait1,":","trait",trait1)
  regs$slope[which(regs$level=="raw")] <- 
    median(mod_comb_vcv1[,paste0(corx,".units")]/mod_comb_vcv1[,paste0(var_x,".units")])
  regs$slope[which(regs$level=="fixed")] <- 
    median(mod_comb_vcv4[,paste0(corx,".units")]/mod_comb_vcv4[,paste0(var_x,".units")])
  regs$slope[which(regs$level=="order")] <- 
    median(mod_comb_vcv4t_ord[,paste0(corx,".parasite_order")]/mod_comb_vcv4t_ord[,paste0(var_x,".parasite_order")])
  regs$slope[which(regs$level=="family")] <- 
    median(mod_comb_vcv4t_fam[,paste0(corx,".parasite_family")]/mod_comb_vcv4t_fam[,paste0(var_x,".parasite_family")])
  regs$slope[which(regs$level=="genus")] <- 
    median(mod_comb_vcv4t.1[,paste0(corx,".parasite_genus")]/mod_comb_vcv4t.1[,paste0(var_x,".parasite_genus")])
  regs$slope[which(regs$level=="species")] <- 
    median(mod_comb_vcv4t.1[,paste0(corx,".units")]/mod_comb_vcv4t.1[,paste0(var_x,".units")])
  
  regs <- mutate(regs, y1 = slope * v1_1, y2 = slope * v1_2)  

  strip_labs <- c(
  `fixed` = paste0("fixed", " (", x0, ", ", y0, "%)" ),
  `order` = paste0("order", " (", x1, ", ", y1, "%)" ),
  `family` = paste0("family", " (", x2, ", ", y2, "%)" ),
  `genus` = paste0("genus", " (", x3, ", ", y3, "%)" ),
  `species` = paste0("species", " (", x4, ", ", y4, "%)" )
  )

  # laby <- paste0(label2, " (", vx1, ", ", vx2, ", ", vx3, ", ", vx4,"%)")
  
  xx <- if_else(corner[1] == 0, min(ell00$x, na.rm = T), max(ell00$x, na.rm = T))
  yy <- if_else(corner[2] == 0, min(ell00$y, na.rm = T), max(ell00$y, na.rm = T))
  xjust <- if_else(corner[1] == 0, "left", "right")
  
  dcx <- dc%>%
    rename_with(function(x){"v1"}, (gsub(pattern = "_host", "_res", trait1)))%>%
    rename_with(function(x){"v2"}, (gsub(pattern = "_host", "_res", trait2)))%>%
    rename_with(function(x){"v3"}, paste0("missing_",trait1))%>%
    rename_with(function(x){"v4"}, paste0("missing_",trait2))%>%
    mutate(parasite_phylum_m = if_else(is.na(v3), parasite_phylum,
                                       if_else(v3 == "yes" | v4 == "yes", "ZZ", parasite_phylum)))%>%
    filter(level != "raw")
  
  fa <- ggplot(dcx,
         aes(x = exp(v1), y = exp(v2), color = level)) +
    geom_point(aes(shape = parasite_phylum_m, size = n),
               alpha = 0.2) +
    geom_hline(yintercept = 1, linetype = "dashed") + geom_vline(xintercept = 1, linetype = "dashed") +
    geom_path(data = filter(ell, level != "raw")%>%
                arrange(level, p_samp, angles),
                aes(x = exp(x), y = exp(y), group = paste(p_samp, level)),
                alpha = 0.1, size = 1) +
    geom_path(data = filter(ell, level == "raw")%>%select(-level)%>%
                arrange(p_samp, angles),
                aes(x = exp(x), y = exp(y), group = paste(p_samp)),
                alpha = 1, size = 1, color = "black", linetype = "dashed") +
    geom_segment(data = filter(regs, level != "raw"),
                 aes(x = exp(v1_1), xend = exp(v1_2), y = exp(y1), yend = exp(y2)),
                 size = 1) +
    geom_text(data = filter(cor_d, grepl(pattern = corx, cor), level != "raw")%>%
                arrange(desc(level))%>%
                mutate(x = xx,
                       y = yy),
              aes(label = txt, 
                  x = exp(x),
                  y = exp(y)),
              size = 3, hjust = xjust) +
    scale_color_manual(values = pal[1:5]) +
    scale_linetype_manual(values = c(rep("solid", times=3), "dashed")) +
    scale_shape_manual(values = c(16,17,15,4)) +
    scale_x_log10() +
    scale_y_log10() +
    coord_cartesian(xlim = exp(c(min(ell00$x, na.rm = T), max(ell00$x, na.rm = T))), 
                    ylim = exp(c(min(ell00$y, na.rm = T), max(ell00$y, na.rm = T)))) +
    guides(size = F, shape = F, color = F, linetype = F) +
    labs(x = label1, y = label2,
         title = paste0("Species-level correlation = ", 
                      filter(cor_d, grepl(corx, cor), level == "raw")$txt)) +
    theme(panel.grid.minor = element_blank(),
          plot.title = element_text(size = 10)) +
    facet_wrap(~level, nrow=1,
               labeller = labeller(level = strip_labs))
  
  return(fa)
}
```

```{r}
# function to make taxonomic covariance plot, fig 5
tax_cov_plot_rev2 <- function(trait1, trait2, label1, label2, corner){
  corx <- paste0("trait",trait1,":","trait",trait2)
  
  ell_sp <- post_cov_matrix_best(mod_comb_vcv1, trait1, trait2, ".units")
  ell00 <- post_cov_matrices_df(mod_comb_vcv1, trait1, trait2, ".units", 10)
  ell0 <- post_cov_matrices_df(mod_comb_vcv4, trait1, trait2, ".units", 10)
  ell1 <- post_cov_matrices_df(mod_comb_vcv4t.1, trait1, trait2, ".parasite_genus", 10)
  ell2 <- post_cov_matrices_df(mod_comb_vcv4t_fam, trait1, trait2, ".parasite_family", 10)
  ell <- bind_rows(ell_sp%>%mutate(level = "raw_b", p_samp = "1"),
                   ell00%>%mutate(level = "raw"),
                   ell0%>%mutate(level = "fixed"),
                   ell1%>%mutate(level = "genus"),
                   ell2%>%mutate(level = "family")
                   )%>%
    mutate(level = fct_relevel(level, c("raw_b", "raw", "fixed", "family", "genus")))
  
  var1 <- paste0("trait",trait1,":","trait",trait1,".units")
  res_var <- median(mod_comb_vcv1[,var1]) # res var int-only model
  res_var0 <- median(mod_comb_vcv4[,var1])
  res_var2 <- median(mod_comb_vcv4t_fam[,var1])
  res_var3 <- median(mod_comb_vcv4t.1[,var1])
  
  x00 <- 0
  x0 <- round(100*((res_var - res_var0)/res_var))
  x2 <- round(100*((res_var0 - res_var2)/res_var))
  x3 <- round(100*((res_var2 - res_var3)/res_var))
  
  var2 <- paste0("trait",trait2,":","trait",trait2,".units")
  res_var <- median(mod_comb_vcv1[,var2]) # res var int-only model
  res_var0 <- median(mod_comb_vcv4[,var2])
  res_var2 <- median(mod_comb_vcv4t_fam[,var2])
  res_var3 <- median(mod_comb_vcv4t.1[,var2])
  y00 <- 0
  y0 <- round(100*((res_var - res_var0)/res_var))
  y2 <- round(100*((res_var0 - res_var2)/res_var))
  y3 <- round(100*((res_var2 - res_var3)/res_var))
  
  regs <- dc%>%
    filter(level %in% c("raw", "fixed", "family", "genus"))%>%
    rename_with(function(x){"v1"}, (gsub(pattern = "_host", "_res", trait1)))%>%
    select(level, v1)%>%
    group_by(level)%>%
    summarise(across(is.double, list(min, max), na.rm = T))%>%
    ungroup()%>%
    mutate(slope = NA_real_)
  var_x <- paste0("trait",trait1,":","trait",trait1)
  regs$slope[which(regs$level=="raw")] <- 
    median(mod_comb_vcv1[,paste0(corx,".units")]/mod_comb_vcv1[,paste0(var_x,".units")])
  regs$slope[which(regs$level=="fixed")] <- 
    median(mod_comb_vcv4[,paste0(corx,".units")]/mod_comb_vcv4[,paste0(var_x,".units")])
  regs$slope[which(regs$level=="family")] <- 
    median(mod_comb_vcv4t_fam[,paste0(corx,".parasite_family")]/mod_comb_vcv4t_fam[,paste0(var_x,".parasite_family")])
  regs$slope[which(regs$level=="genus")] <- 
    median(mod_comb_vcv4t.1[,paste0(corx,".parasite_genus")]/mod_comb_vcv4t.1[,paste0(var_x,".parasite_genus")])
  
  regs <- mutate(regs, y1 = slope * v1_1, y2 = slope * v1_2)  

  strip_labs <- c(
  `raw` = paste0("raw"),
  `fixed` = paste0("fixed", " (", x0, ", ", y0, "%)" ),
  `family` = paste0("family", " (", x2, ", ", y2, "%)" ),
  `genus` = paste0("genus", " (", x3, ", ", y3, "%)" )
  )

  xx <- if_else(corner[1] == 0, min(ell_sp$x, na.rm = T), max(ell_sp$x, na.rm = T))
  yy <- if_else(corner[2] == 0, min(ell_sp$y, na.rm = T), max(ell_sp$y, na.rm = T))
  xjust <- if_else(corner[1] == 0, "left", "right")
  
  dcx <- dc%>%
    rename_with(function(x){"v1"}, (gsub(pattern = "_host", "_res", trait1)))%>%
    rename_with(function(x){"v2"}, (gsub(pattern = "_host", "_res", trait2)))%>%
    rename_with(function(x){"v3"}, paste0("missing_",trait1))%>%
    rename_with(function(x){"v4"}, paste0("missing_",trait2))%>%
    mutate(parasite_phylum_m = if_else(is.na(v3), parasite_phylum,
                                       if_else(v3 == "yes" | v4 == "yes", "ZZ", parasite_phylum)))%>%
    filter(level %in% c("raw", "fixed", "family", "genus"))
  
  fa <- ggplot(dcx, 
         aes(x = v1, y = v2)) +
    geom_point(aes(shape = parasite_phylum_m, size = n),
               alpha = 0.2) +
    geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
    geom_path(data = filter(ell, level != "raw_b")%>%
                arrange(level, p_samp, angles),
                aes(x = x, y = y, group = paste(p_samp, level)),
                alpha = 0.1, size = 1) +
    geom_path(data = filter(ell, level == "raw_b")%>%
                select(-level)%>%
                arrange(p_samp, angles),
                aes(x = x, y = y, group = paste(p_samp)),
                alpha = 1, size = 1, color = "black", linetype = "dashed") +
    geom_segment(data = filter(regs),
                 aes(x = v1_1, xend = v1_2, y = y1, yend = y2),
                 size = 1) +
    geom_text(data = filter(cor_d, grepl(pattern = corx, cor), 
                            level %in% c("raw", "fixed", "family", "genus"))%>%
                arrange(desc(level))%>%
                mutate(x = xx,
                       y = yy),
              aes(label = txt, 
                  x = x,
                  y = y),
              size = 3, hjust = xjust) +
    scale_color_manual(values = pal[1:4]) +
    scale_linetype_manual(values = c(rep("solid", times=3), "dashed")) +
    scale_shape_manual(values = c(16,17,15,4)) +
    coord_cartesian(xlim = c(min(ell_sp$x, na.rm = T), max(ell_sp$x, na.rm = T)), 
                    ylim = c(min(ell_sp$y, na.rm = T), max(ell_sp$y, na.rm = T))) +
    guides(size = F, shape = F, linetype = F) +
    labs(x = label1, y = label2) +
    theme(panel.grid.minor = element_blank(),
          plot.title = element_text(size = 10)) +
    facet_wrap(~level, nrow=1,
               labeller = labeller(level = strip_labs))
  
  return(fa)
}
```

```{r}
# proportion of variance explained, relative to int-only model
prop_var_per_group <- function(trait){
  
  var1 <-paste0("trait",trait,":","trait",trait, ".units")
  res_var <- (mod_comb_vcv1[,var1])
  res_var0 <- (mod_comb_vcv4[,var1])
  res_var1 <- (mod_comb_vcv4t_ord[,var1])
  res_var2 <- (mod_comb_vcv4t_fam[,var1])
  res_var3 <- (mod_comb_vcv4t.1[,var1])
  x0 <- (res_var - res_var0)/res_var
  x1 <- (res_var0 - res_var1)/res_var
  x2 <- (res_var1 - res_var2)/res_var
  x3 <- (res_var2 - res_var3)/res_var
  x4 <- (res_var3/res_var)
  sx0 <- summary(x0)
  sx1 <- summary(x1)
  sx2 <- summary(x2)
  sx3 <- summary(x3)
  sx4 <- summary(x4)
  
  v_out <- data.frame(trait = trait,
                      level = c("fixed", "order", "family", "genus", "species"),
                      var_lwr = c(sx0$quantiles[1], sx1$quantiles[1], sx2$quantiles[1], 
                                  sx3$quantiles[1], sx4$quantiles[1]),
                      var_fit = c(sx0$quantiles[3], sx1$quantiles[3], sx2$quantiles[3], 
                                  sx3$quantiles[3], sx4$quantiles[3]),
                      var_upr = c(sx0$quantiles[5], sx1$quantiles[5], sx2$quantiles[5], 
                                  sx3$quantiles[5], sx4$quantiles[5])
                      )
  return(v_out)
}
```

```{r}
prop_var_plot <- function(trait1, trait2, labx, laby){
  var_df <- bind_rows(prop_var_per_group(trait1),
                    prop_var_per_group(trait2))
  var_df <- var_df%>%
    mutate(level = fct_relevel(level, c("fixed", "order", "family", "genus", "species")))
  
  f2x <- ggplot(var_df,
                aes(x = level, y = var_fit, color = trait)) +
    geom_pointrange(aes(ymin = var_lwr, ymax = var_upr),
                    position = position_dodge(width = 0.4),
                    size=0.4,
                    shape=20
                    ) +
    labs(x = NULL, y = 'Prop. variance', 
         color = NULL, shape = NULL) +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          legend.background = element_rect(color = "black"),
          legend.position = c(0.5,0.85),
          legend.text = element_text(size = 5),
          legend.direction = "horizontal",
          legend.margin = unit(c(0, 0, 0, 0), "cm")
          ) +
    scale_y_continuous(limits = c(0,1)) +
    scale_color_brewer(palette = "Accent", labels = c(labx, laby))
  return(f2x)
}

```
```{r}
cor_pointrange_plot <- function(trait1, trait2){
  corx <- paste0("trait",trait1,":","trait",trait2)
  cor_d2 <- cor_d%>%
    filter(grepl(corx, cor))
  cor_d3 <- cor_d%>%
    filter(grepl(corx, cor), level == "raw")
  cor_d3 <- bind_rows(cor_d3, cor_d3, cor_d3, cor_d3, cor_d3)%>%
    mutate(level = c("fixed", "order", "family", "genus", "species"))%>%
    mutate(level = fct_relevel(level, c("fixed", "order", "family", "genus", "species")))
  f2y <- ggplot(cor_d2%>%
                  filter(level != "raw")%>%
                  mutate(level = as.numeric(level)),
                aes(x = level, y = cor_fit)) +
    annotate("rect", 
             xmin = 0,
             xmax = 7,
             ymin = cor_d2%>%
               filter(level == "raw")%>%
               .$cor_lwr,
             ymax = cor_d2%>%
               filter(level == "raw")%>%
               .$cor_upr,
             fill = "gray",
             alpha = 0.2) +
    geom_hline(yintercept = cor_d2%>%
                 filter(level == "raw")%>%
                 .$cor_fit,
               linetype = "dotted") +
    geom_pointrange(aes(ymin = cor_lwr, ymax = cor_upr),
                    position = position_dodge(width = 0.33),
                    # shape = 3,
                    size=0.5,
                    shape=20) +
    labs(x = NULL, y = 'Correlation', 
         color = NULL, shape = NULL) +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          legend.background = element_rect(color = "black"),
          legend.position = c(0.6,0.8),
          axis.text = element_text(size = 6)
          ) +
    scale_x_continuous(breaks = c(2:6), 
                       labels = c("fixed", "order", "family", "genus", "species")) +
    coord_cartesian(xlim = c(1.66,6.33))
    # scale_y_continuous(limits = c(-1,1))
  return(f2y)
}
```
```{r}
raw_cov_plot <- function(trait1, trait2, label1, label2, corner){
  
  corx <- paste0("trait",trait1,":","trait",trait2)
  cor_anno <- cor_d%>%
    filter(grepl(pattern = corx, cor))%>%
    filter(level == "raw")%>%
    .$txt
  
  th <- two_hosts%>%
  rename(missing_rg_int_host = missing_rg_ih,
         missing_rg_def_host = missing_rg_dh,
         missing_dd_int_host = missing_dd_ih,
         missing_dd_def_host = missing_dd_dh,
         missing_fs_def_host = missing_fs,
         missing_ag_def_host = missing_ag)
  th <- th%>%
    rename(v1 = all_of(trait1), v2 = all_of(trait2))%>%
    rename_with(function(x){"v3"}, paste0("missing_",trait1))%>%
    rename_with(function(x){"v4"}, paste0("missing_",trait2))%>%
    mutate(parasite_phylum_m = if_else(is.na(v3), parasite_phylum,
                                         if_else(v3 == "yes" | v4 == "yes", "ZZ", parasite_phylum)))
  
  xx <- if_else(corner[1] == 0, min(th$v1, na.rm = T), max(th$v1, na.rm = T))
  yy <- if_else(corner[2] == 0, min(th$v2, na.rm = T), max(th$v2, na.rm = T))
  xjust <- if_else(corner[1] == 0, "left", "right")
  
  fa <- ggplot(th,
                aes(x = exp(v1), y = exp(v2))) +
    geom_vline(xintercept = exp(posterior.mode(mod_comb_sol1[,paste0("trait",trait1)])),
               linetype = "dotted") +
    geom_hline(yintercept = exp(posterior.mode(mod_comb_sol1[,paste0("trait",trait2)])),
               linetype = "dotted") +
    geom_point(aes(shape = parasite_phylum_m),
               alpha = 0.2, size = 1) +
    geom_smooth(method=lm, se = F, color = "black") +
    scale_y_log10() +
    scale_x_log10() +
    scale_shape_manual(values = c(16,17,15,4)) +
    labs(x = label1, y = label2, 
         shape = NULL) +
    theme(panel.grid.minor = element_blank(),
          legend.background = element_rect(color = "black"),
          legend.position = c(0.975,0.025),
          legend.justification = c(1,0),
          axis.text = element_text(size = 6)
          ) +
    guides(shape = F) +
    annotate("text", label = cor_anno,
             x = exp(xx),
             y = exp(yy),
             color = "black", size = 3, hjust = xjust) 
  return(fa)
  
}
```


### Correlations within stages

Let's look at the correlations using conditional residuals, starting within stages. Here is the correlation between larval growth and development. The left plot shows the raw, unadjusted species-level correlation, whereas the right plot shows how the correlation changes by adding fixed effects like host mass and then taxonomic levels. The correlation is weaker after accounting for host size, suggesting it is at least partly driven by host mass. However, even after accounting for host mass, there are correlations among orders and families, suggesting some families grow more/longer than expected from the size of their hosts.

```{r}
f5n <- cowplot::plot_grid(raw_cov_plot("dd_int_host", "rg_int_host", 
                                "Larval development", "Larval growth",
                                corner = c(0,1)) + 
                     scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))),
                   cor_pointrange_plot("dd_int_host", "rg_int_host"),
                   align = "hv", nrow=1)
f5n
```

Here's the same plot, but for adult growth and development. In this case, correcting for size strengthens the relationship slightly, suggesting species that grow large relative to their host also have longer development. Interestingly, the correlation was tight among genera, which mirrors a pattern in host masses.

```{r}
f5m <- cowplot::plot_grid(raw_cov_plot("dd_def_host", "rg_def_host", 
                                "Adult development", "Adult growth",
                                corner = c(1,0)) + 
                     scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))),
                   cor_pointrange_plot("dd_def_host", "rg_def_host"),
                   align = "hv", nrow=1)
f5m
```

```{r}
f5test <- cowplot::plot_grid(f5n, f5m, labels = c("(a)","(b)"), nrow = 1)
ggsave(f5test, filename = "../../figs/fig5_imp.png", width = 8, height = 2)
ggsave(f5test, filename = "../../figs/fig5_imp.svg", width = 8, height = 2)
```

We can plot how these different factors impact these within-stage correlations. Here we can see that family-level covariance is higher for larvae than adults, whereas genus-level covariance is higher for adults.

```{r}
fa <- tax_cov_plot("dd_int_host", "rg_int_host", 
                   "Fold-change from expected larval developmental time", 
                   "Fold-change from\nexpected larval growth",
                   c(0,1)) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))
fb <- tax_cov_plot("dd_def_host", "rg_def_host",
                   "Fold-change from expected adult developmental time", 
                   "Fold-change from\nexpected adult growth",
                   c(0,1)) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))
f5 <- cowplot::plot_grid(fa, fb, nrow = 2,
                         labels = c("(a)", "(b)"))
f5
ggsave(f5, filename = "../../figs/figC4_within_imp.png", width = 7, height = 5)
ggsave(f5, filename = "../../figs/figC4_within_imp.svg", width = 7, height = 5)
```

Since "order" explained little variance for any trait, and since there is little covariance left at the "species/residual" level after accounting for higher taxonomy, let's remove those panels. We'll also separate the raw, uncorrected correlation out to show how it is reduced by accounting for host masses and taxonomy. The correlation between larval growth and development is caused by host masses more than adult growth and development. Even after accounting for host masses, though, some taxa, mainly families, grow more and longer than expected.

```{r}
fa <- tax_cov_plot_rev2("dd_int_host", "rg_int_host", 
                        "Residual larval development", "Residual larval growth",
                   c(0,1))
fb <- tax_cov_plot_rev2("dd_def_host", "rg_def_host", 
                        "Residual adult development", "Residual adult growth",
                   c(0,1))
f5 <- cowplot::plot_grid(fa, fb, nrow = 2,
                         labels = c("(a)", "(b)"))
f5
# ggsave(f5, filename = "../../figs/fig5_rev_imp.png", width = 7, height = 5)
# ggsave(f5, filename = "../../figs/fig5_rev_imp.svg", width = 7, height = 5)
```

Let's also plot which families drive the relationships. Here are the estimated random effects for the families with long/short larval growth and development.

```{r}
plot_biv_families <- function(trait1, trait2, label1, label2) {
  # plot random effect correlation among families
  sx1 <- mod_comb_sol4t_fam[,grepl(pattern = paste0("trait",trait1,".parasite_family"), colnames(mod_comb_sol4t_fam))]
  sx2 <- mod_comb_sol4t_fam[,grepl(pattern = paste0("trait",trait2,".parasite_family"), colnames(mod_comb_sol4t_fam))]
  
  sx <- 
    sx1/apply(sx1, MARGIN = 1, sd) +
    sx2/apply(sx2, MARGIN = 1, sd)
  sx <- sx/2
  sx <- summary(sx)
  re_fams <- data.frame(fam = row.names(sx$quantiles), 
                        t1 = apply(sx1,MARGIN = 2, median), 
                        t2 = apply(sx2,MARGIN = 2, median),
                        re_lwr = sx$quantiles[,1],
                        re = sx$quantiles[,3],
                        re_upr = sx$quantiles[,5])
  re_fams <- re_fams%>%
    mutate(fam = gsub(pattern = paste0("trait",trait1,".parasite_family."), "", fam))
  re_fams <- left_join(re_fams, 
                       filter(dc, level == "family")%>%
                         select(parasite_family, parasite_phylum, n),
                       by = c("fam" = "parasite_family")
                       )
  re_fams <- re_fams%>%
    mutate(ranks = percent_rank(re))
  
  fa <- ggplot(re_fams,
         aes(x=t1, y=t2, color = re)) +
    geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(shape = parasite_phylum, size = n),
               ) +
    ggrepel::geom_text_repel(
      data = re_fams%>%
                filter(ranks > 0.9 | ranks < 0.1),
              aes(label = fam)) +
    scale_color_distiller(palette = "Spectral") +
    guides(shape = F, size = F, color = F) +
    theme(panel.grid.minor = element_blank()) +
    labs(x = label1, y = label2)
  return(list(re_fams, fa))
}
```

```{r}
bv <- plot_biv_families("dd_int_host", "rg_int_host", "Residual larval development", "Residual larval growth")
s4a <- bv[[2]]
s4a
```
We can also see this by plotting the residuals of the different models and highlighting the families with large or small larvae.

```{r}
alt_resid_plot <- function(trait1, trait2, fams){
  t <- left_join(
    two_hosts_p%>%
      filter(is.na(pred))%>%
      select(Parasite.species, parasite_phylum, parasite_order, parasite_family, parasite_genus,
             starts_with(trait1), 
             missing_rg_ih:missing_ag)%>%
      pivot_longer(starts_with(trait1), values_to = trait1, names_to = "model")%>%
      mutate(model = gsub(trait1, "", model)),
    two_hosts_p%>%
      filter(is.na(pred))%>%
      select(Parasite.species, parasite_phylum, parasite_order, parasite_family, parasite_genus,
             starts_with(trait2), 
             missing_rg_ih:missing_ag)%>%
      pivot_longer(starts_with(trait2), values_to = trait2, names_to = "model")%>%
      mutate(model = gsub(trait2, "", model))
    )
  
  t <- t%>%
    mutate(model = fct_recode(model, raw = "raw", fixed = "m", order = "o", family = "f", 
                              genus = "g", species = "c"))%>%
    mutate(model = fct_relevel(model, c("raw", "fixed", "order", "family", "genus", "species")))%>%
    rename(v1 = all_of(trait1), v2 = all_of(trait2))
  
  fx <- ggplot(t, aes(x = exp(v1), y = exp(v2))) +
    geom_vline(xintercept = 1, linetype = "dotted") +
    geom_hline(yintercept = 1, linetype = "dotted") +
    geom_point(alpha = 0.1, aes(shape = parasite_phylum)) +
    geom_point(data = filter(t, parasite_family %in% fams),
               aes(shape = parasite_phylum, color = parasite_family)) +
    scale_x_log10() +
    scale_y_log10() +
    labs(x = trait1, y = trait2, color = NULL) +
    guides(shape = F) +
    theme(panel.grid.minor = element_blank()) +
    facet_wrap(~model)
  
  return(fx)
}
```


```{r}
fc3 <- alt_resid_plot("dd_int_res", "rg_int_res", c("Taeniidae", "Syngamidae")) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  labs(x = "Fold-change from expected larval developmental time", 
       y = "Fold-change from\nexpected larval growth")
fc3
ggsave(fc3, filename = "../../figs/figC1_demo.png", width = 6, height = 4)
```

And here are the families that grew long/short as adults.

```{r}
s4b <- plot_biv_families("dd_def_host", "rg_def_host", "Residual adult development", "Residual adult growth")[[2]]
s4b
```

And here are the model residuals for two families in the above plot:

```{r}
alt_resid_plot("dd_def_res", "rg_def_res", c("Anoplocephalidae", "Cystidicolidae")) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  labs(x = "Fold-change from expected adult developmental time", 
       y = "Fold-change from\nexpected adult growth")
```

Parasites that are have older ages at maturity are also larger. This correlation was stronger after accounting for host traits, which indicates that species with large sizes, relative to their host, also have older ages than expected. This is at least somewhat caused by taxonomy; even after controlling for host traits, there were taxon-level correlations.

```{r}
f5o <- cowplot::plot_grid(raw_cov_plot("ag_def_host", "fs_def_host", 
                                "Maturation age", "Maturation size",
                                corner = c(0,1)) + 
                     scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))),
                   cor_pointrange_plot("ag_def_host", "fs_def_host"),
                   align = "hv", nrow=1)
f5o
```

Here are the taxon-level correlations;

```{r}
tax_cov_plot("ag_def_host", "fs_def_host", 
             "Fold-change from expected maturation age", "Fold-change from\nexpected maturation size",
             c(0,1)) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))
```
Here are the families driving the size-age relationship:

```{r}
plot_biv_families("ag_def_host", "fs_def_host", "Residual maturation age", "Residual maturation size")[[2]] 
```
At the family level, a 10% increase in age at maturity was associated with a 20% increase in reproductive size.

```{r}
summary(
  exp(
    (mod_comb_vcv4t_fam[,"traitag_def_host:traitfs_def_host.parasite_family"]/
       mod_comb_vcv4t_fam[,"traitag_def_host:traitag_def_host.parasite_family"]) * log(1.1)
    ) - 1
  )
```
The slope is basically the same among species after accounting for fixed effects, though the CI is smaller.

```{r}
summary(
  exp(
    (mod_comb_vcv4[,"traitag_def_host:traitfs_def_host.units"]/
       mod_comb_vcv4[,"traitag_def_host:traitag_def_host.units"]) * log(1.1)
    ) - 1
  )
```

### Correlations across stages

Now let's make the same plots across stages. 

#### Larval growth vs adult traits

We start by looking at the relationship between larval and adult growth. Larval and adult growth were negatively correlated and this relationship was seen at the family, genus, and species level. The correlation weakened after we accounted for host traits, suggesting some of the overall correlation was driven by host traits.

```{r}
f6a_1 <- raw_cov_plot("rg_int_host", "rg_def_host", 
                      "Larval growth", "Adult growth",
                      corner = c(1,1)) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  # geom_vline(xintercept = 1, color = "green") +
  # geom_hline(yintercept = exp(
  #   posterior.mode(mod_comb_sol1[,"traitrg_def_host"]) +
  #     posterior.mode(mod_comb_sol1[,"traitrg_int_host"])
  #   ),
  #   color = "green") +
  geom_abline(intercept = 5.55, # obtained by iteration! could not figure out where this value comes from
    slope = -1, linetype = "dotted")

f6a_2 <- cor_pointrange_plot("rg_int_host", "rg_def_host")

cowplot::plot_grid(f6a_1, f6a_2,
                   align = "hv", nrow=1)
```

If a e.g. 100% increase in larval growth results in a 50% decrease in adult growth, then the slope of the correlation should be -1. The dotted diagonal line has this slope. The observed correlation is flatter than this until we account for higher taxonomy. Once we account for class and order, then we see closer adherence to the line. Thus, species or genera that increase growth by X%, relative to expectations, tend to see a corresponding decrease in adult growth.

```{r}
fc <- tax_cov_plot("rg_int_host", "rg_def_host",
                   "Fold-change from expected larval growth", "Fold-change from\nexpected adult growth",
                   c(1,1)) +
  geom_abline(slope = -1, intercept = 0, linetype = "dotted") +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))
fc
```

For each of these panels, we can look at the slope and its CI in each panel (the slope is calculated as the larval-adult covariance divided by the variance in larval growth; cov(x,y)/var(x) ). The overall slope (i.e. for the black ellipse) was greater than -1, suggesting that species with more larval growth also had less than proportionate decreases in adult growth:

```{r}
summary(mod_comb_vcv1[,"traitrg_int_host:traitrg_def_host.units"]/mod_comb_vcv1[,"traitrg_int_host:traitrg_int_host.units"])
```
It was a bit lower, but still greater than -1 after we accounted for host traits:

```{r}
summary(mod_comb_vcv4[,"traitrg_int_host:traitrg_def_host.units"]/mod_comb_vcv4[,"traitrg_int_host:traitrg_int_host.units"])
```
With this slope, a doubling of larval growth was not quite associated with a corresponding 50% decrease in adult growth.

```{r}
summary(
  exp( 
    (mod_comb_vcv4[,"traitrg_int_host:traitrg_def_host.units"]/
      mod_comb_vcv4[,"traitrg_int_host:traitrg_int_host.units"]) * log(2)
    ) - 1
  )
```
This low value is largely driven by parasite order

```{r}
summary(mod_comb_vcv4t_ord[,"traitrg_int_host:traitrg_def_host.parasite_order"]/mod_comb_vcv4t_ord[,"traitrg_int_host:traitrg_int_host.parasite_order"])
```

It got much closer to -1 after accounting for class and order. Here is the slope at the family level:

```{r}
summary(mod_comb_vcv4t_fam[,"traitrg_int_host:traitrg_def_host.parasite_family"]/mod_comb_vcv4t_fam[,"traitrg_int_host:traitrg_int_host.parasite_family"])
```
At the genus level:

```{r}
summary(mod_comb_vcv4t.1[,"traitrg_int_host:traitrg_def_host.parasite_genus"]/mod_comb_vcv4t.1[,"traitrg_int_host:traitrg_int_host.parasite_genus"])
```
And within genera (among species): 

```{r}
summary(mod_comb_vcv4t.1[,"traitrg_int_host:traitrg_def_host.units"]/mod_comb_vcv4t.1[,"traitrg_int_host:traitrg_int_host.units"])
```

We can also plot the families that tended to grow more/less at both life stages.

```{r}
s5a <- plot_biv_families("rg_int_host", "rg_def_host", "Residual larval growth", "Residual adult growth")[[2]] +
  geom_abline(slope = -1, intercept = 0, linetype = "dotted")
s5a
```

Moving on to the relationship between larval growth and adult development (prepatent period). 

```{r}
f6b_1 <- raw_cov_plot("rg_int_host", "dd_def_host", 
                      "Larval growth", "Adult development",
                      corner = c(1,1)) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))

f6b_2 <- cor_pointrange_plot("rg_int_host", "dd_def_host")

cowplot::plot_grid(f6b_1, f6b_2,
                   align = "hv", nrow=1)
```

More larval growth tended to reduce adult prepatent period, but this was mainly observed among genera not families. There is thus a mismatch in the levels at which these traits vary: larval growth varies mostly among families. By contrast, adult development varies more among genera.

```{r}
fd <- tax_cov_plot("rg_int_host", "dd_def_host",
                   "Fold-change from expected larval growth", "Fold-change from\nexpected adult development",
                   c(0,1)) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))
fd
```

Because adult growth decreased more with larval growth than adult development, there was a tendency for adult growth *rates* to be slower for species/taxa that grew more as larvae. As explored above, this trend is somewhat related to slowing growth rates with larger sizes.

```{r}
fa_grow <- ggplot(filter(dc, level != "raw")%>%
                    mutate(parasite_phylum_m = if_else(is.na(missing_rg_int_host),
                                                       parasite_phylum,
                                                       if_else(
                                                         (missing_rg_int_host == "yes" | missing_rg_def_host == "yes" | missing_dd_def_host == "yes"), "ZZ", parasite_phylum))),
       aes(x=rg_int_res, y=rgr_def_res, color = level)) +
  geom_point(aes(shape = parasite_phylum_m, size = n),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(method=lm, se = F) +
  scale_color_manual(values = pal[1:5]) +
  guides(size = F, shape = F, color = F, linetype = F) +
  theme(panel.grid.minor = element_blank()) +
  facet_wrap(~level, nrow=1) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(x = "Residual larval growth", y = "Residual adult growth rate")
fa_grow
```

Here are the Pearson correlations associated with the plot above.

```{r}
dc%>%
  group_by(level)%>%
  select(rg_int_res, rgr_def_res)%>%
  summarise(cor.lwr = cor.test(rg_int_res,rgr_def_res)$conf.int[1],
            cor = cor.test(rg_int_res,rgr_def_res)$estimate,
            cor.upr = cor.test(rg_int_res,rgr_def_res)$conf.int[2],
            pval = round(cor.test(rg_int_res,rgr_def_res)$p.value, 3))
```

Now let's examine how larval growth affects size at maturity. Worms that grow more as larvae tend to be larger adults. However, this correlation is partly driven by variance in host mass (correlation weakens with fixed effects) and higher-level taxonomy (differences among orders). Within orders, parasites that grew more than expected as larvae did not mature at larger sizes.

```{r}
f6c_1 <- raw_cov_plot("rg_int_host", "fs_def_host", 
                    "Larval growth", "Maturation size",
                    corner = c(1,0)) + 
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))

f6c_2 <- cor_pointrange_plot("rg_int_host", "fs_def_host")

cowplot::plot_grid(f6c_1, f6c_2,
                   align = "hv", nrow=1)
```

```{r}
fe <- tax_cov_plot("rg_int_host", "fs_def_host",
                   "Fold-change from expected larval growth", "Fold-change from\nexpected maturation size",
                   c(0,1)) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))

fe
```

```{r}
f6 <- cowplot::plot_grid(fc + theme(axis.title.x = element_blank(),
                                    axis.text.x = element_blank(),
                                    plot.margin = unit(c(0, 0, 0, 0), "points")),
                         fd + theme(axis.title.x = element_blank(),
                                    axis.text.x = element_blank(),
                                    plot.margin = unit(c(0, 0, 0, 0), "points")),
                         fe + theme(plot.margin = unit(c(0, 0, 0, 0), "points")), 
                         labels = c("(a)", "(b)", "(c)"),
                         align = "hv", nrow = 3)
ggsave(f6, filename = "../../figs/figC5_across_imp.png", width = 7, height = 7.5)
ggsave(f6, filename = "../../figs/figC5_across_imp.svg", width = 7, height = 7.5)
```

Finally, there was very little relationship between larval growth and age at maturity. Growing more (or less) than expected is not associated with later (or earlier) reproductive ages.

```{r}
tax_cov_plot("rg_int_host", "ag_def_host", "Residual larval growth", "Residual maturation age",
                   c(0,1)) +
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))
```

#### Larval development vs adult traits

Now we move from larval growth to larval developmental times. We start by examining how larval development affects adult growth. Species that develop longer tended to grow less as adults.

```{r}
f6d_1 <- raw_cov_plot("dd_int_host", "rg_def_host", 
                    "Larval development", "Adult growth",
                    corner = c(0,0)) + 
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))

f6d_2 <- cor_pointrange_plot("dd_int_host", "rg_def_host")

cowplot::plot_grid(f6d_1, f6d_2,
                   align = "hv", nrow=1)
```

Families, genera, and species tended to grow less as adults when they developed longer.

```{r}
fc <- tax_cov_plot("dd_int_host", "rg_def_host",
                   "Fold-change from expected larval development", "Fold-change from\nexpected adult growth",
                   c(1,1)) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))
fc
```

If spending more time in the intermediate host reduces the time needed in the definitive host, then developmental times in the two hosts should be negatively correlated, especially after accounting for fixed effects. However, spending more time in the intermediate hosts was associated with spending more time in the definitive hosts, suggesting that developmental rates are species traits. Perhaps they are better considered family traits, since the positive correlation was clearest at the level.

```{r}
f6e_1 <- raw_cov_plot("dd_int_host", "dd_def_host", 
                    "Larval development", "Adult development",
                    corner = c(1,1)) 

f6e_2 <- cor_pointrange_plot("dd_int_host", "dd_def_host")

cowplot::plot_grid(f6e_1, f6e_2,
                   align = "hv", nrow=1)
```

```{r}
fd <- tax_cov_plot("dd_int_host", "dd_def_host", 
                   "Fold-change from expected larval development", "Fold-change from\nexpected adult development",
                   c(0,1))
fd
```

After accounting for fixed effects, here is how much a 10% increase in larval developmental time increases adult developmental time: 

```{r}
summary(
  exp( 
    (mod_comb_vcv4[,"traitdd_int_host:traitdd_def_host.units"]/
      mod_comb_vcv4[,"traitdd_int_host:traitdd_int_host.units"]) * log(1.1)
    ) - 1
  )
```
The family level correlation was similar in magnitude, though with much more uncertainty.

```{r}
summary(
  exp(
    (mod_comb_vcv4t_fam[,"traitdd_int_host:traitdd_def_host.parasite_family"]/
       mod_comb_vcv4t_fam[,"traitdd_int_host:traitdd_int_host.parasite_family"]) * log(1.1)
    ) - 1
  )
```

Here are the parasite families characterized by longer (or shorter) development than expected at both stages.

```{r}
bv <- plot_biv_families("dd_int_host", "dd_def_host", "Residual larval development", "Residual adult development")
s5b <- bv[[2]]
s5b
```

We can also put the slow developers (both stages) in a table:

```{r}
bv[[1]]%>%
  select(fam, n, re_lwr, re, re_upr)%>%
  arrange(desc(re))%>%slice_head(n=10)
```

And here are the fast developers:

```{r}
bv[[1]]%>%
  select(fam, n, re_lwr, re, re_upr)%>%
  arrange(re)%>%slice_head(n=10)
```

Since slow larval development was associated with slow adult development and only marginally less growth, there was a tendency for adult growth rates to decrease with larval development at most taxonomic levels.

```{r}
fb_grow <- ggplot(filter(dc, level != "raw")%>%
                    mutate(parasite_phylum_m = if_else(is.na(missing_dd_int_host),
                                                       parasite_phylum,
                                                       if_else(
                                                         (missing_dd_int_host == "yes" | missing_rg_def_host == "yes" | missing_dd_def_host == "yes"), "ZZ", parasite_phylum))),
       aes(x=dd_int_res, y=rgr_def_res, color = level)) +
  geom_point(aes(shape = parasite_phylum_m, size = n),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(method=lm, se = F) +
  scale_color_manual(values = pal[1:5]) +
  guides(size = F, shape = F, color = F, linetype = F) +
  theme(panel.grid.minor = element_blank()) +
  facet_wrap(~level, nrow=1) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(x = "Residual larval development", y = "Residual adult growth rate")
fb_grow
```
Here are the Pearson correlations associated with the plot above:

```{r}
dc%>%
  group_by(level)%>%
  select(dd_int_res, rgr_def_res)%>%
  summarise(cor.lwr = cor.test(dd_int_res,rgr_def_res)$conf.int[1],
            cor = cor.test(dd_int_res,rgr_def_res)$estimate,
            cor.upr = cor.test(dd_int_res,rgr_def_res)$conf.int[2],
            pval = round(cor.test(dd_int_res,rgr_def_res)$p.value, 3))
```

Despite the slower adult growth rates, parasites with slow larval (and adult) development tended to mature at larger adult sizes. The trend was clearest among families.

```{r}
f6f_1 <- raw_cov_plot("dd_int_host", "fs_def_host", 
                    "Larval development", "Maturation size",
                    corner = c(0,1)) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))

f6f_2 <- cor_pointrange_plot("dd_int_host", "fs_def_host")

cowplot::plot_grid(f6f_1, f6f_2,
                   align = "hv", nrow=1)
```


```{r}
fe <- tax_cov_plot("dd_int_host", "fs_def_host",
                   "Fold-change from expected larval development", "Fold-change from\nexpected maturation size",
                   c(0,1)) +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))
fe
```

A 10% increase in larval developmental time, beyond expectations from host traits, was associated with a 12% increase in maturation size.

```{r}
summary(
  exp( 
    (mod_comb_vcv4[,"traitdd_int_host:traitfs_def_host.units"]/
      mod_comb_vcv4[,"traitdd_int_host:traitdd_int_host.units"]) * log(1.1)
    ) - 1
  )
```
The family level correlation was similar in magnitude, though with much more uncertainty.

```{r}
summary(
  exp(
    (mod_comb_vcv4t_fam[,"traitdd_int_host:traitfs_def_host.parasite_family"]/
       mod_comb_vcv4t_fam[,"traitdd_int_host:traitdd_int_host.parasite_family"]) * log(1.1)
    ) - 1
  )
```

Here are the families characterized by long larval development and large reproductive sizes (or vice versa).

```{r}
bv <- plot_biv_families("dd_int_host", "fs_def_host", "Residual larval development", "Residual maturation size")
bv[[2]]
```
Here are the slow-larvae, large-adult families in a table:

```{r}
bv[[1]]%>%
  select(fam, n, re_lwr, re, re_upr)%>%
  arrange(desc(re))%>%slice_head(n=10)
```

Here are the fast-larvae, small-adult families in a table:

```{r}
bv[[1]]%>%
  select(fam, n, re_lwr, re, re_upr)%>%
  arrange(re)%>%slice_head(n=10)
```


```{r}
f7 <- cowplot::plot_grid(fc + theme(axis.title.x = element_blank(),
                                    axis.text.x = element_blank(),
                                    plot.margin = unit(c(0, 0, 0, 0), "points")),
                         fd + theme(axis.title.x = element_blank(),
                                    axis.text.x = element_blank(),
                                    plot.margin = unit(c(0, 0, 0, 0), "points")),
                         fe + theme(plot.margin = unit(c(0, 0, 0, 0), "points")), 
                         labels = c("(a)","(b)","(c)"),
                         align = "hv", nrow = 3)
ggsave(f7, filename = "../../figs/figC6_across_imp.png", width = 7, height = 7.5)
ggsave(f7, filename = "../../figs/figC6_across_imp.svg", width = 7, height = 7.5)
```


Longer larval development increased age at maturity, as expected.

```{r}
tax_cov_plot("dd_int_host", "ag_def_host", "Residual larval development", "Residual age at maturity", c(0,1))
```



```{r}
f6 <- cowplot::plot_grid(f6a_1 + theme(axis.title.x = element_blank(),
                                       axis.text.x = element_blank(),
                                       plot.margin = unit(c(0, 0, 0, 0), "points")), 
                         f6a_2 + theme(axis.title = element_blank(),
                                       axis.text.x = element_blank(),
                                       plot.margin = unit(c(0, 0, 0, 0), "points")),
                         f6d_1 + theme(axis.title.x = element_blank(),
                                       axis.text.x = element_blank(),
                                       plot.margin = unit(c(0, 0, 0, 0), "points")),
                         f6d_2 + theme(axis.title = element_blank(),
                                       axis.text.x = element_blank(),
                                       plot.margin = unit(c(0, 0, 0, 0), "points")),
                         f6b_1 + theme(axis.title.x = element_blank(),
                                       axis.text.x = element_blank(),
                                       plot.margin = unit(c(0, 0, 0, 0), "points")),
                         f6b_2 + theme(axis.title = element_blank(),
                                       axis.text.x = element_blank(),
                                       plot.margin = unit(c(0, 0, 0, 0), "points")),
                         f6e_1 + theme(axis.title.x = element_blank(),
                                       axis.text.x = element_blank(),
                                       plot.margin = unit(c(0, 0, 0, 0), "points")),
                         f6e_2 + theme(axis.title = element_blank(),
                                       axis.text.x = element_blank(),
                                       plot.margin = unit(c(0, 0, 0, 0), "points")),
                         f6c_1 + theme(plot.margin = unit(c(0, 0, 0, 0), "points")),
                         f6c_2 + theme(axis.title.y = element_blank(),
                                       plot.margin = unit(c(0, 0, 0, 0), "points")),
                         f6f_1 + theme(plot.margin = unit(c(0, 0, 0, 0), "points")),
                         f6f_2 + theme(axis.title.y = element_blank(),
                                       plot.margin = unit(c(0, 0, 0, 0), "points")),
                         align = "hv", 
                         labels = c("(a)", "", "(b)", "", "(c)", "", "(d)", "", "(e)", "", "(f)", ""),
                         nrow = 3)
ggsave(f6, filename = "../../figs/fig6_imp.png", width = 8, height = 6)
ggsave(f6, filename = "../../figs/fig6_imp.svg", width = 8, height = 6)
```


#### Growth rates in the two hosts

They were uncorrelated across hosts.

```{r}
fc_grow <- ggplot(filter(dc, level != "raw")%>%
                    mutate(parasite_phylum_m = if_else(is.na(missing_dd_int_host),
                                                       parasite_phylum,
                                                       if_else(
                                                         (missing_dd_int_host == "yes" | missing_rg_def_host == "yes" | missing_dd_def_host == "yes"| missing_rg_int_host == "yes"), "ZZ", parasite_phylum))),
       aes(x=rgr_int_res, y=rgr_def_res, color = level)) +
  geom_point(aes(shape = parasite_phylum_m, size = n),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(method=lm, se = F) +
  scale_color_manual(values = pal) +
  guides(size = F, shape = F, color = F, linetype = F) +
  theme(panel.grid.minor = element_blank()) +
  facet_wrap(~level, nrow=1) +
  scale_shape_manual(values = c(16,17,15,4)) +
  labs(x = "Residual larval growth rate", y = "Residual adult growth rate")
fc_grow
```

Since growth rates were not explicitly modeled, there was not covariance returned by the model. Thus, here are the pearson correlations for the plot above.

```{r}
dc%>%
  group_by(level)%>%
  select(rgr_int_res, rgr_def_res)%>%
  summarise(cor.lwr = cor.test(rgr_int_res,rgr_def_res)$conf.int[1],
            cor = cor.test(rgr_int_res,rgr_def_res)$estimate,
            cor.upr = cor.test(rgr_int_res,rgr_def_res)$conf.int[2],
            pval = cor.test(rgr_int_res,rgr_def_res)$p.value)
```


```{r}
fs <- cowplot::plot_grid(fa_grow,
                         fb_grow,
                         fc_grow,
                         labels = c("(a)","(b)","(c)"),
                         align = "hv", nrow = 3)
# fs
ggsave(fs, filename = "../../figs/figB3_imp.png", width = 7, height = 7.5)
# ggsave(fs, filename = "../../figs/figB3_imp.svg", width = 7, height = 7.5)
```

#### Size and age at maturity - determined by larval or adult traits?

Larvae that grew more did not have larger adult sizes or younger ages, although genera that grew relatively large had shorter prepatent periods. Species that have longer larval development have older age at maturity. This trend was mostly due to variation within genera. Families that developed longer as larvae tended to be larger adults, but only weakly.

Here are the plots of adult growth and development vs size and age at maturity.

```{r}
fa <- tax_cov_plot("rg_def_host", "fs_def_host", "Residual adult growth", "Residual size at maturity", c(0,1))
fb <- tax_cov_plot("dd_def_host", "ag_def_host", "Residual adult development", "Residual age at maturity", c(0,1))
fc <- tax_cov_plot("rg_def_host", "ag_def_host", "Residual adult growth", "Residual age at maturity", c(0,1))
fd <- tax_cov_plot("dd_def_host", "fs_def_host", "Residual adult development", "Residual size at maturity", c(0,1))
```

Species that grew more as adults tended to have bigger maturation sizes at the family, genus, and species levels. Age at maturity was also correlated with adult growth, but not within genera.

```{r}
cowplot::plot_grid(fa, fc, ncol = 1)
```
Size and age at maturity also increased with adult development, but not within genera for development.

```{r}
cowplot::plot_grid(fb, fd, ncol = 1)
```

Rapid adult growth is associated with a younger age at maturity but not a larger size at maturity.

```{r}
fd_grow <- ggplot(filter(dc, level != "raw"),
       aes(x=rgr_def_res, y=ag_def_res, color = level)) +
  geom_point(aes(shape = parasite_phylum, size = n),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(method=lm, se = F) +
  scale_color_manual(values = pal) +
  guides(size = F, shape = F, color = F, linetype = F) +
  theme(panel.grid.minor = element_blank()) +
  facet_wrap(~level, nrow=1) +
  labs(x = "Residual adult growth rate", y = "Residual maturation age")
fe_grow <- ggplot(filter(dc, level != "raw"),
       aes(x=rgr_def_res, y=fs_def_res, color = level)) +
  geom_point(aes(shape = parasite_phylum, size = n),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(method=lm, se = F) +
  scale_color_manual(values = pal) +
  guides(size = F, shape = F, color = F, linetype = F) +
  theme(panel.grid.minor = element_blank()) +
  facet_wrap(~level, nrow=1) +
  labs(x = "Residual adult growth rate", y = "Residual maturation size")
cowplot::plot_grid(fd_grow, fe_grow, ncol = 1)
```
Slow larval growth, though, tends to be associated with larger sizes and older ages at maturity.

```{r}
fd_grow <- ggplot(filter(dc, level != "raw"),
       aes(x=rgr_int_res, y=ag_def_res, color = level)) +
  geom_point(aes(shape = parasite_phylum, size = n),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(method=lm, se = F) +
  scale_color_manual(values = pal) +
  guides(size = F, shape = F, color = F, linetype = F) +
  theme(panel.grid.minor = element_blank()) +
  facet_wrap(~level, nrow=1) +
  labs(x = "Residual larval growth rate", y = "Residual maturation age")
fe_grow <- ggplot(filter(dc, level != "raw"),
       aes(x=rgr_int_res, y=fs_def_res, color = level)) +
  geom_point(aes(shape = parasite_phylum, size = n),
             alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(method=lm, se = F) +
  scale_color_manual(values = pal) +
  guides(size = F, shape = F, color = F, linetype = F) +
  theme(panel.grid.minor = element_blank()) +
  facet_wrap(~level, nrow=1) +
  labs(x = "Residual larval growth rate", y = "Residual maturation size")
cowplot::plot_grid(fd_grow, fe_grow, ncol = 1)
```

```{r}
# dc%>%
#   group_by(level)%>%
#   select(rgr_int_res, fs_def_res)%>%
#   summarise(cor.lwr = cor.test(rgr_int_res,fs_def_res)$conf.int[1],
#             cor = cor.test(rgr_int_res,fs_def_res)$estimate,
#             cor.upr = cor.test(rgr_int_res,fs_def_res)$conf.int[2],
#             pval = cor.test(rgr_int_res,fs_def_res)$p.value)
```

Since parasites grow more and longer as adults, it is not surprising that size and age at maturity is primarily determined by adult strategies.

Since correlations among orders, among genera, and within-genera usually did not diverge from family-level correlations, let's simplify the plots. Also, we can pick out a couple families to show how they achieved large sizes - through more growth or faster growth, and at what stage?

```{r}
# function to make taxonomic covariance plot
tax_cov_plot_rev <- function(trait1, trait2, label1, label2, corner, fams_highlight){
  corx <- paste0("trait",trait1,":","trait",trait2)
  
  ell_sp <- post_cov_matrix_best(mod_comb_vcv1, trait1, trait2, ".units")
  ell00 <- post_cov_matrices_df(mod_comb_vcv1, trait1, trait2, ".units", 10)
  ell0 <- post_cov_matrices_df(mod_comb_vcv4, trait1, trait2, ".units", 10)
  ell2 <- post_cov_matrices_df(mod_comb_vcv4t_fam, trait1, trait2, ".parasite_family", 10)
  ell <- bind_rows(ell_sp%>%mutate(level = "raw_b", p_samp = "1"),
                   ell00%>%mutate(level = "raw"),
                   ell0%>%mutate(level = "fixed"),
                   ell2%>%mutate(level = "family")
                   )%>%
    mutate(level = fct_relevel(level, c("raw_b", "raw", "fixed", "family")))
  
  
  var1 <- paste0("trait",trait1,":","trait",trait1,".units")
  res_var <- median(mod_comb_vcv1[,var1]) # res var int-only model
  res_var0 <- median(mod_comb_vcv4[,var1])
  res_var2 <- median(mod_comb_vcv4t_fam[,var1])
  
  x00 <- 0
  x0 <- round(100*((res_var - res_var0)/res_var))
  x2 <- round(100*((res_var0 - res_var2)/res_var))
  
  # labx <- paste0(label1, " (", vx1,", ", vx2,", ", vx3, ", ", vx4,"%)")

  var2 <- paste0("trait",trait2,":","trait",trait2,".units")
  res_var <- median(mod_comb_vcv1[,var2]) # res var int-only model
  res_var0 <- median(mod_comb_vcv4[,var2])
  res_var2 <- median(mod_comb_vcv4t_fam[,var2])
  y00 <- 0
  y0 <- round(100*((res_var - res_var0)/res_var))
  y2 <- round(100*((res_var0 - res_var2)/res_var))
  
  regs <- dc%>%
    filter(level %in% c("raw", "fixed", "family"))%>%
    rename_with(function(x){"v1"}, (gsub(pattern = "_host", "_res", trait1)))%>%
    select(level, v1)%>%
    group_by(level)%>%
    summarise(across(is.double, list(min, max), na.rm = T))%>%
    ungroup()%>%
    mutate(slope = NA_real_)
  var_x <- paste0("trait",trait1,":","trait",trait1)
  regs$slope[which(regs$level=="raw")] <- 
    median(mod_comb_vcv1[,paste0(corx,".units")]/mod_comb_vcv1[,paste0(var_x,".units")])
  regs$slope[which(regs$level=="fixed")] <- 
    median(mod_comb_vcv4[,paste0(corx,".units")]/mod_comb_vcv4[,paste0(var_x,".units")])
  regs$slope[which(regs$level=="family")] <- 
    median(mod_comb_vcv4t_fam[,paste0(corx,".parasite_family")]/mod_comb_vcv4t_fam[,paste0(var_x,".parasite_family")])
  
  regs <- mutate(regs, y1 = slope * v1_1, y2 = slope * v1_2)  

  strip_labs <- c(
  `raw` = paste0("raw"),
  `fixed` = paste0("fixed", " (", x0, ", ", y0, "%)" ),
  `family` = paste0("family", " (", x2, ", ", y2, "%)" )
  )

  # laby <- paste0(label2, " (", vx1, ", ", vx2, ", ", vx3, ", ", vx4,"%)")
  
  xx <- if_else(corner[1] == 0, min(ell_sp$x, na.rm = T), max(ell_sp$x, na.rm = T))
  yy <- if_else(corner[2] == 0, min(ell_sp$y, na.rm = T), max(ell_sp$y, na.rm = T))
  xjust <- if_else(corner[1] == 0, "left", "right")
  
  dcx <- dc%>%
    rename_with(function(x){"v1"}, (gsub(pattern = "_host", "_res", trait1)))%>%
    rename_with(function(x){"v2"}, (gsub(pattern = "_host", "_res", trait2)))%>%
    rename_with(function(x){"v3"}, paste0("missing_",trait1))%>%
    rename_with(function(x){"v4"}, paste0("missing_",trait2))%>%
    mutate(parasite_phylum_m = if_else(is.na(v3), parasite_phylum,
                                       if_else(v3 == "yes" | v4 == "yes", "ZZ", parasite_phylum)))%>%
    filter(level %in% c("raw", "fixed", "family"))
   
  fa <- ggplot(dcx, 
         aes(x = v1, y = v2)) +
    geom_point(aes(shape = parasite_phylum_m, size = n),
               alpha = 0.2) +
    geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
    geom_path(data = filter(ell, level != "raw_b")%>%
                arrange(level, p_samp, angles),
                aes(x = x, y = y, group = paste(p_samp, level)),
                alpha = 0.1, size = 1) +
    geom_path(data = filter(ell, level == "raw_b")%>%
                select(-level)%>%
                arrange(p_samp, angles),
                aes(x = x, y = y, group = paste(p_samp)),
                alpha = 1, size = 1, color = "black", linetype = "dashed") +
    geom_segment(data = filter(regs),
                 aes(x = v1_1, xend = v1_2, y = y1, yend = y2),
                 size = 1) +
    geom_point(data = dcx%>%
                 filter(
                   # level == "family",
                   parasite_family %in% fams_highlight),
               aes(shape = parasite_phylum_m, size = n, color = parasite_family)) +
    geom_text(data = filter(cor_d, grepl(pattern = corx, cor), 
                            level %in% c("raw", "fixed", "family"))%>%
                arrange(desc(level))%>%
                mutate(x = xx,
                       y = yy),
              aes(label = txt, 
                  x = x,
                  y = y),
              size = 3, hjust = xjust) +
    scale_color_manual(values = pal[1:4]) +
    scale_linetype_manual(values = c(rep("solid", times=3), "dashed")) +
    scale_shape_manual(values = c(16,17,15,4)) +
    coord_cartesian(xlim = c(min(ell_sp$x, na.rm = T), max(ell_sp$x, na.rm = T)), 
                    ylim = c(min(ell_sp$y, na.rm = T), max(ell_sp$y, na.rm = T))) +
    guides(size = F, shape = F, linetype = F) +
    labs(x = label1, y = label2) +
    theme(panel.grid.minor = element_blank(),
          plot.title = element_text(size = 10)) +
    facet_wrap(~level, nrow=1,
               labeller = labeller(level = strip_labs))
  
  return(fa)
}
```

```{r}
fams_to_plot <- c("Acuariidae", "Anoplocephalidae", "Taeniidae", "Cystidicolidae")
fa <- tax_cov_plot_rev("rg_int_host", "rg_def_host", "Residual larval growth", "Residual adult growth",
                   c(0,0), fams_to_plot) +
  geom_abline(slope = -1, intercept = 0, linetype = "dotted") 
fc <- tax_cov_plot_rev("rg_int_host", "dd_def_host", "Residual larval growth", "Residual adult development",
                   c(0,1), fams_to_plot) 
fe <- tax_cov_plot_rev("rg_int_host", "fs_def_host", "Residual larval growth", "Residual maturation size",
                   c(0,1), fams_to_plot) 
fb <- tax_cov_plot_rev("dd_int_host", "rg_def_host", "Residual larval development", "Residual adult growth",
                   c(0,0), fams_to_plot) 
fd <- tax_cov_plot_rev("dd_int_host", "dd_def_host", "Residual larval development", "Residual adult development",
                   c(0,1), fams_to_plot) 
ff <- tax_cov_plot_rev("dd_int_host", "fs_def_host", "Residual larval development", "Residual maturation size",
                   c(0,1), fams_to_plot) 
fg <- tax_cov_plot_rev("ag_def_host", "fs_def_host", "Residual maturation age", "Residual maturation size",
                   c(0,1), fams_to_plot) +
  theme(legend.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3)))

f6new <- cowplot::plot_grid(fa + theme(axis.title.x = element_blank(),
                                    axis.text.x = element_blank()), 
                            fb + theme(axis.title = element_blank(),
                                    axis.text = element_blank()),
                            fc + theme(axis.title.x = element_blank(),
                                    axis.text.x = element_blank()),
                            fd + theme(axis.title = element_blank(),
                                       axis.text = element_blank()),
                            fe, 
                            ff + theme(axis.title.y = element_blank(),
                                       axis.text.y = element_blank()),
                            fg,
                         labels = c("(a)","(b)","(c)", "(d)", "(e)", "(f)","(g)"),
                         align = "hv", nrow = 4)
f6new
# ggsave(f6new, filename = "../../figs/fig6_new_imp.png", width = 13, height = 10)
# ggsave(f6new, filename = "../../figs/fig6_new_imp.svg", width = 13, height = 10)
# remove legends, move closer together, move (g) into center
```

On this plot 4 families with different growth strategies are highlighted: 1) Anoplocephalidae (more adult growth than expected, also relative to larval size), 2) Taeniidae (more larval growth than expected, and proprtionally more adult growth), 3) Acuariidae (a little less growth than expected in both hosts), 4) Cystidicolidae (more larval growth than expected, but much less adult growth).

```{r}
fa
```
These differences are reflected in developmental times. Longer development is associated with proportionally more growth.

```{r}
fd
```
If we look at the growth rates of these families, we see that they are not consistently faster or slower than expected. Thus, their position on the size-age continuum is mainly due to variation in developmental time, not growth rate.

```{r}
fc_grow <- ggplot(filter(dc, level %in% c("raw", "fixed", "family")),
       aes(x=rgr_int_res, y=rgr_def_res)) +
  geom_point(aes(shape = parasite_phylum, size = n),
             alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
  geom_smooth(method=lm, se = F, color = "black") +
  geom_point(data = dc%>%
               filter(parasite_family %in% fams_to_plot),
             aes(shape = parasite_phylum, size = n, color = parasite_family),
             alpha = 1) +
  scale_color_manual(values = pal[1:4]) +
  guides(size = F, shape = F, color = F, linetype = F) +
  theme(panel.grid.minor = element_blank()) +
  facet_wrap(~level, nrow=1) +
  labs(x = "Residual larval growth rate", y = "Residual adult growth rate")
fc_grow
```

Overall, these patterns result in a continuum of size-age at maturity.
```{r}
fg
```


Instead of plotting species values and family average, we can also plot the family-level random effects from the mixed model.  

```{r}
plot_biv_families <- function(trait1, trait2, label1, label2) {
  # plot random effect correlation among families
  sx1 <- mod_comb_sol4t_fam[,grepl(pattern = paste0("trait",trait1,".parasite_family"), colnames(mod_comb_sol4t_fam))]
  sx2 <- mod_comb_sol4t_fam[,grepl(pattern = paste0("trait",trait2,".parasite_family"), colnames(mod_comb_sol4t_fam))]
  sx <- 
    sx1/apply(sx1, MARGIN = 1, sd) +
    sx2/apply(sx2, MARGIN = 1, sd)
  
  # sx <- 
  #   sx1/sd(as.matrix(two_hosts2[,grepl(paste0("^", trait1), colnames(two_hosts2))]), na.rm = T) +
  #   sx2/sd(as.matrix(two_hosts2[,grepl(paste0("^", trait2), colnames(two_hosts2))]), na.rm = T)
  # sx <- sx1 + sx2
  sx <- sx/2
  sx <- summary(sx)
  re_fams <- data.frame(fam = row.names(sx$quantiles), 
                        t1 = apply(sx1,MARGIN = 2, median), 
                        t2 = apply(sx2,MARGIN = 2, median),
                        re_lwr = sx$quantiles[,1],
                        re = sx$quantiles[,3],
                        re_upr = sx$quantiles[,5])
  re_fams <- re_fams%>%
    mutate(fam = gsub(pattern = paste0("trait",trait1,".parasite_family."), "", fam))
  re_fams <- left_join(re_fams, 
                       filter(dc, level == "family")%>%
                         select(parasite_family, parasite_phylum, n, ends_with("not_miss")),
                       by = c("fam" = "parasite_family")
                       )
  re_fams <- re_fams%>%
    mutate(ranks = percent_rank(re))
  
  return(re_fams)
}
```

Here is how random effects for development look. Some families with long larval development also have long adult development.

```{r}
bv3 <- plot_biv_families("ag_def_host", "fs_def_host", "Residual maturation age", "Residual maturation size")
# top and bottom 10 fams for size and age at maturity
fams_to_plot <- bv3%>% 
  filter(ranks >= (1-(10/86)) | ranks <= (10/86))%>%
  arrange(ranks)%>%
  .$fam


bv <- plot_biv_families("dd_int_host", "dd_def_host", "Residual larval development", "Residual larval growth")

s4b <- ggplot(bv,
         aes(x=t1, y=t2, fill = re)) +
    geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(shape = parasite_phylum, size=n),
               color = "white") +
    ggrepel::geom_text_repel(
      data = bv%>%
                filter(fam %in% fams_to_plot),
              aes(label = fam),
      size = 2) +
    scale_fill_distiller(palette = "RdBu", direction = 1) +
    scale_shape_manual(values = c(21,24,22)) +
    guides(shape = F, size = F, color = F, fill = F) +
    theme(panel.grid.minor = element_blank()) +
    labs(x = "Residual larval development", y = "Residual adult development")
s4b
```

Here are the random effects for growth showing which families grow a bit more as larvae and adults than expected.

```{r}
bv2 <- plot_biv_families("rg_int_host", "rg_def_host", "Residual larval development", "Residual larval growth")

s4a <- ggplot(bv2,
         aes(x=t1, y=t2, color = re)) +
  geom_abline(slope = -1, linetype = "dotted") +
    geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(shape = parasite_phylum, size=n),
               stroke = 1) +
    ggrepel::geom_text_repel(
      data = bv2%>%
        filter(fam %in% fams_to_plot),
              aes(label = fam),
      color = "black", size = 2) +
    scale_color_distiller(palette = "RdBu", direction = 1) +
    scale_shape_manual(values = c(21,24,22)) +
    guides(shape = F, size = F, color = F) +
    theme(panel.grid.minor = element_blank()) +
    labs(x = "Residual larval growth", y = "Residual adult growth") 
s4a
```

Combining growth and development, we see which parasite families are characterized by large sizes and long lives.

```{r}
bv3 <- bind_cols(bv3, select(bv2, re_rg = re), select(bv, re_dd = re))

s4c <- ggplot(bv3,
         aes(x=t1, y=t2, color = re_rg, fill = re_dd)) +
    geom_hline(yintercept = 0, linetype = "dashed") + geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(aes(shape = parasite_phylum, size=n),
               stroke = 1) +
    ggrepel::geom_text_repel(
      data = bv3%>%
        filter(fam %in% fams_to_plot),
              aes(label = fam),
      color = "black", size = 2) +
    scale_fill_distiller(palette = "RdBu", direction = 1) +
  scale_color_distiller(palette = "RdBu", direction = 1) + 
    scale_shape_manual(values = c(21,24,22)) +
    guides(shape = F, size = F, color = F, fill = F) +
    theme(panel.grid.minor = element_blank()) +
    labs(x = "Residual maturation age", y = "Residual maturation size")
s4c
```
```{r}
# top_row <- cowplot::plot_grid(s4a, s4b, align = "hv", labels = c("(a)", "(b)"), nrow = 1)
# bottom_row <- cowplot::plot_grid(NULL, s4c, NULL, align = "hv", labels = c("","(c)",""),
#                                  rel_widths = c(0.33,1,0.33), nrow = 1)
# s4 <- cowplot::plot_grid(top_row, bottom_row, ncol = 1)
# ggsave(s4, filename = "../../figs/figS4_old.png", width = 6, height = 6)
```

Maybe forest plots might be a better way to show this. This way the CIs can also be shown.

```{r}
plot_uni_families <- function(trait1, label1) {
  # plot random effect correlation among families
  sx1 <- mod_comb_sol4t_fam[,grepl(pattern = paste0("trait",trait1,".parasite_family"), colnames(mod_comb_sol4t_fam))]
  sx <- summary(sx1)
  re_fams <- data.frame(fam = row.names(sx$quantiles), 
                        re_lwr = sx$quantiles[,1],
                        re = sx$quantiles[,3],
                        re_upr = sx$quantiles[,5])
  re_fams <- re_fams%>%
    mutate(fam = gsub(pattern = paste0("trait",trait1,".parasite_family."), "", fam))
  re_fams <- left_join(re_fams, 
                       filter(dc, level == "family")%>%
                         select(parasite_family, parasite_phylum, n, ends_with("not_miss")),
                       by = c("fam" = "parasite_family")
                       )
  re_fams <- re_fams%>%
    mutate(ranks = percent_rank(re))
  
  return(re_fams)
}
```

```{r}
fa <- ggplot(plot_uni_families("fs_def_host", "l")%>%
         filter(fam %in% fams_to_plot)%>%
         mutate(fam = fct_relevel(fam, fams_to_plot))%>%
         arrange(fam)%>%
         mutate(label = paste0(fam, " (", fs_def_res_not_miss, ")"),
                label_fct = fct_relevel(label, label)),
        aes(x = label_fct, y = re, shape = parasite_phylum)) +
  geom_pointrange(aes(ymin = re_lwr, ymax = re_upr)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(y = "Estimated RE, maturation size") +
  coord_flip() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.position = c(0.05,0.95),
        legend.justification = c(0,1))
fb <- ggplot(plot_uni_families("ag_def_host", "l")%>%
         filter(fam %in% fams_to_plot)%>%
         mutate(fam = fct_relevel(fam, fams_to_plot))%>%
         arrange(fam)%>%
         mutate(label = paste0(fam, " (", ag_def_res_not_miss, ")"),
                label_fct = fct_relevel(label, label)),
        aes(x = label_fct, y = re, shape = parasite_phylum)) +
  geom_pointrange(aes(ymin = re_lwr, ymax = re_upr)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(y = "Estimated RE, maturation age") +
  coord_flip() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()) +
  guides(shape = F)
top <- cowplot::plot_grid(fa, fb, labels = c("(a)", "(b)"))
```
```{r}
fc <- ggplot(plot_uni_families("rg_int_host", "l")%>%
         filter(fam %in% fams_to_plot)%>%
         mutate(fam = fct_relevel(fam, fams_to_plot))%>%
         arrange(fam)%>%
         mutate(label = paste0(fam, " (", rg_int_res_not_miss, ")"),
                label_fct = fct_relevel(label, label)),
        aes(x = label_fct, y = re, shape = parasite_phylum)) +
  geom_pointrange(aes(ymin = re_lwr, ymax = re_upr)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(y = "Estimated RE, larval RG") +
  coord_flip() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.title.y = element_blank()) +
  guides(shape = F)
fd <- ggplot(plot_uni_families("dd_int_host", "l")%>%
         filter(fam %in% fams_to_plot)%>%
         mutate(fam = fct_relevel(fam, fams_to_plot))%>%
         arrange(fam)%>%
         mutate(label = paste0(fam, " (", dd_int_res_not_miss, ")"),
                label_fct = fct_relevel(label, label)),
        aes(x = label_fct, y = re, shape = parasite_phylum)) +
  geom_pointrange(aes(ymin = re_lwr, ymax = re_upr)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(y = "Estimated RE, larval DT") +
  coord_flip() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()) +
  guides(shape = F)
mid <- cowplot::plot_grid(fc, fd, labels = c("(c)", "(d)"))
```
```{r}
fe <- ggplot(plot_uni_families("rg_def_host", "l")%>%
         filter(fam %in% fams_to_plot)%>%
         mutate(fam = fct_relevel(fam, fams_to_plot))%>%
         arrange(fam)%>%
         mutate(label = paste0(fam, " (", rg_def_res_not_miss, ")"),
                label_fct = fct_relevel(label, label)),
        aes(x = label_fct, y = re, shape = parasite_phylum)) +
  geom_pointrange(aes(ymin = re_lwr, ymax = re_upr)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(y = "Estimated RE, adult RG") +
  coord_flip() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.title.y = element_blank()) +
  guides(shape = F)
ff <- ggplot(plot_uni_families("dd_def_host", "l")%>%
         filter(fam %in% fams_to_plot)%>%
         mutate(fam = fct_relevel(fam, fams_to_plot))%>%
         arrange(fam)%>%
         mutate(label = paste0(fam, " (", dd_def_res_not_miss, ")"),
                label_fct = fct_relevel(label, label)),
        aes(x = label_fct, y = re, shape = parasite_phylum)) +
  geom_pointrange(aes(ymin = re_lwr, ymax = re_upr)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(y = "Estimated RE, adult DT") +
  coord_flip() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()) +
  guides(shape = F)
bot <- cowplot::plot_grid(fe, ff, labels = c("(e)", "(f)"))
```
```{r}
fsx <- cowplot::plot_grid(top, mid, bot,ncol= 1)
fsx
ggsave(fsx, filename = "../../figs/figC7_imp.png", width = 8, height = 10)
```


# Conclusions

Some changes in life history are consistent with theoretical expectations. Others are not. Overperformance as larvae is not associated with over or under-performance as adults, suggestive of decoupling.

```{r}
save.image(file = "lh_dat_rg_imp.RData")
```

